<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VVPhone</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="iPhone Sim">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#000000">

    <!-- 引用外部 CSS 文件 -->
    <link rel="stylesheet" href="style.css">

    <!-- 这两个 style 标签由 JavaScript 动态填充，需要保留 -->
    <style id="custom-font-style"></style>
    <style id="dynamic-chat-theme"></style>
</head>
<body>
    <!-- 数据加载遮罩 -->
    <div id="app-loading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#fff;">
        <div style="font-size:24px; margin-bottom:20px;">VVPhone</div>
        <div style="color:#888;">正在升级数据库...</div>
    </div>

    <div class="phone-case">
        <div class="notch"></div>
        <div class="status-bar">
            <span id="clock-time">12:00</span>
            <span>100%</span>
        </div>

        <!-- 1. 锁屏 -->
        <div id="lock-screen" class="screen active">
            <div class="clock" id="lock-clock">12:00</div>
            <div class="date" id="lock-date">1月1日 星期一</div>
            <div class="slider-container">
                <div class="slider-text">滑动来解锁</div>
                <input type="range" min="0" max="100" value="0" id="unlock-slider">
            </div>
        </div>

        <!-- 2. 主屏幕 -->
        <div id="home-screen" class="screen">
            <div class="home-header">
                <div class="home-time-big" id="home-time-big">12:00</div>
                <div class="home-date-big" id="home-date-big">1月1日 星期一</div>
            </div>

            <!-- 翻页容器 -->
            <div class="home-pages-container" id="home-pages-container">
                <div class="home-pages-wrapper" id="home-pages-wrapper">
                    <!-- 第一页 -->
                    <div class="home-page" id="home-page-1">
                        <div class="home-widget-container">
                            <div class="home-widget" id="home-widget" onclick="triggerWidgetUpload()">
                                <span>点击上传图片</span>
                                <img id="home-widget-img" src="">
                            </div>
                            <input type="file" id="widget-file-input" style="display:none" accept="image/*" onchange="uploadWidgetImage(this)">
                        </div>

                        <!-- APP 图标网格 -->
                        <div class="app-grid">
                            <div class="app-icon" id="icon-app-vk" onclick="openApp('app-vk')">VK<div class="app-label">Vkontakte</div></div>
                            <div class="app-icon" id="icon-app-contacts" onclick="openApp('app-contacts')">👤<div class="app-label">通讯录</div></div>
                            <div class="app-icon" id="icon-app-memos" onclick="openApp('app-memos')" style="background-color:#f1c40f; color:#000;">📝<div class="app-label">备忘录</div></div>
                            <div class="app-icon" id="icon-app-calendar" onclick="openApp('app-calendar')" style="background-color:#fff; color:#ff3b30;">📅<div class="app-label">日历</div></div>
                            <div class="app-icon" id="icon-app-worldbook" onclick="openApp('app-worldbook')">📖<div class="app-label">世界书</div></div>
                            <div class="app-icon" id="icon-app-spy-list" onclick="openApp('app-spy-list')">👁️<div class="app-label">查岗</div></div>
                            <div class="app-icon" id="icon-app-theme" onclick="openApp('app-theme')">🎨<div class="app-label">美化</div></div>
                            <div class="app-icon" id="icon-app-settings" onclick="openApp('app-settings')">⚙️<div class="app-label">设置</div></div>
                        </div>
                    </div>

                    <!-- 第二页 -->
                    <div class="home-page" id="home-page-2">
                        <div class="page2-layout">
                            <!-- 左上角：方块小组件 -->
                            <div class="page2-widget-square" id="page2-widget-square" onclick="triggerPage2WidgetUpload()">
                                <span>点击上传</span>
                                <img id="page2-widget-img" src="">
                            </div>
                            <input type="file" id="page2-widget-file-input" style="display:none" accept="image/*" onchange="uploadPage2WidgetImage(this)">

                            <!-- 右上角：四个应用 -->
                            <div class="page2-app-grid">
                                <div class="app-icon" id="icon-app-couple" onclick="openApp('app-couple')" style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a);">💕<div class="app-label">情侣空间</div></div>
                                <div class="app-icon" id="icon-app-tomato" style="background: linear-gradient(135deg, #ff6348, #ff4757);">🍅<div class="app-label">番茄钟</div></div>
                                <div class="app-icon" id="icon-app-music" onclick="openApp('app-music')" style="background: linear-gradient(135deg, #ff2d55, #ff375f);">🎵<div class="app-label">音乐</div></div>
                                <div class="app-icon" id="icon-app-forum" onclick="openApp('app-forum')" style="background: linear-gradient(135deg, #5856d6, #6c5ce7);">💬<div class="app-label">论坛</div></div>
                            </div>

                            <!-- 左下角：四个应用 -->
                            <div class="page2-app-grid">
                                <div class="app-icon" id="icon-app-shopping" style="background: linear-gradient(135deg, #ff9500, #ff8c00);">🛒<div class="app-label">购物</div></div>
                                <div class="app-icon" id="icon-app-game" style="background: linear-gradient(135deg, #34c759, #30d158);">🎮<div class="app-label">小游戏</div></div>
                                <div class="app-icon" id="icon-app-accounting" style="background: linear-gradient(135deg, #007aff, #0a84ff);">📊<div class="app-label">记账</div></div>
                                <div class="app-icon" id="icon-app-wallet" style="background: linear-gradient(135deg, #ffcc00, #ffd60a);">💰<div class="app-label">钱包</div></div>
                            </div>

                            <!-- 右下角：新设计区域 -->
                            <div class="page2-new-design">
                                <!-- 两个圆形 -->
                                <div class="design-circles">
                                    <div class="design-circle" id="circle-left" onclick="triggerCircleUpload('left')">
                                        <span>点击上传</span>
                                        <img id="circle-left-img" src="">
                                    </div>
                                    <svg class="curved-line" viewBox="0 0 100 100" preserveAspectRatio="none">
                                        <path d="M 20 50 C 20 30, 40 30, 50 50 C 60 30, 80 30, 80 50 C 80 70, 50 90, 50 90 C 50 90, 20 70, 20 50" stroke="rgba(255,255,255,0.6)" stroke-width="3" fill="none"/>
                                    </svg>
                                    <div class="design-circle" id="circle-right" onclick="triggerCircleUpload('right')">
                                        <span>点击上传</span>
                                        <img id="circle-right-img" src="">
                                    </div>
                                </div>
                                
                                <!-- 大长方形 -->
                                <div class="design-rectangle" id="rectangle-bottom" onclick="triggerRectangleUpload()">
                                    <span>点击上传</span>
                                    <img id="rectangle-img" src="">
                                </div>
                            </div>
                            
                            <!-- 隐藏的文件上传输入 -->
                            <input type="file" id="circle-left-input" style="display:none" accept="image/*" onchange="uploadCircleImage(this, 'left')">
                            <input type="file" id="circle-right-input" style="display:none" accept="image/*" onchange="uploadCircleImage(this, 'right')">
                            <input type="file" id="rectangle-input" style="display:none" accept="image/*" onchange="uploadRectangleImage(this)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 页面指示器 -->
            <div class="page-indicator">
                <div class="page-dot active" onclick="goToPage(0)"></div>
                <div class="page-dot" onclick="goToPage(1)"></div>
            </div>

            <!-- 底部固定应用栏 -->
            <div class="bottom-app-bar">
                <div class="bottom-app-icon" onclick="openApp('app-question-box')">
                    <div class="bottom-app-icon-emoji">📮</div>
                    <div class="bottom-app-icon-label">提问箱</div>
                </div>
                <div class="bottom-app-icon">
                    <div class="bottom-app-icon-emoji">💬</div>
                    <div class="bottom-app-icon-label">短信</div>
                </div>
                <div class="bottom-app-icon">
                    <div class="bottom-app-icon-emoji">📧</div>
                    <div class="bottom-app-icon-label">电子邮件</div>
                </div>
            </div>
        </div>

        <!-- 3. 设置 App -->
        <div id="app-settings" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Done</div>
                <div class="app-title">设置</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content">
                <div class="toggle-switch">
                    <span class="toggle-label">无边框全屏模式</span>
                    <label class="switch"><input type="checkbox" id="fullscreen-toggle" onchange="toggleFullscreen()"><span class="slider"></span></label>
                </div>
                <div class="form-group"><label>API Base URL</label><input type="text" id="api-url" placeholder="https://api.openai.com/v1"></div>
                <div class="form-group"><label>API Key</label><input type="password" id="api-key" placeholder="sk-..."></div>
                
                <div class="form-group">
                    <label>Model Name</label>
                    <div class="input-group-row">
                        <input type="text" id="model-name" placeholder="gpt-3.5-turbo" style="flex:1;">
                        <button class="fetch-btn" onclick="fetchModels(this)">拉取模型</button>
                    </div>
                    <select id="model-select" style="display:none; margin-top:10px; width:100%;" onchange="selectModel(this)"></select>
                </div>

                <div class="form-group">
                    <label>模型温度 (Temperature)</label>
                    <div style="display:flex; align-items:center; gap:15px; margin-top:10px;">
                        <input type="range" id="temperature-slider" min="0" max="200" value="70" step="1" style="flex:1; -webkit-appearance:none; height:6px; border-radius:5px; background:#ddd; outline:none;">
                        <input type="number" id="temperature-input" min="0" max="2" step="0.01" value="0.7" style="width:80px; padding:8px; border:1px solid #ddd; border-radius:8px; font-size:14px; text-align:center;">
                    </div>
                    <div style="font-size:11px; color:#888; margin-top:8px;">温度范围：0（精确）- 2（创造性），默认 0.7</div>
                </div>

                <!-- System Prompt 已隐藏 -->
                <input type="hidden" id="system-prompt">

                <button class="save-btn" onclick="saveSettings()">保存设置</button>

                <div class="settings-section-title" style="margin-top:30px;">备份与恢复</div>
                <div style="display:flex; gap:10px;">
                    <button class="save-btn" style="background:#333;" onclick="exportBackup()">导出备份 (JSON)</button>
                    <button class="save-btn" style="background:#007aff;" onclick="document.getElementById('import-file').click()">导入备份</button>
                    <input type="file" id="import-file" style="display:none" onchange="importBackup(this)" accept=".json,application/json,text/plain,*/*">
                </div>
                <div style="font-size:11px; color:#888; margin-top:5px;">导入备份将覆盖当前所有数据，请谨慎操作。</div>
            </div>
        </div>

        <!-- 4. 通讯录 App -->
        <div id="app-contacts" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">通讯录</div>
                <div class="action-btn" onclick="openContactForm()">+</div>
            </div>
            <div class="app-content">
                <div id="add-contact-area" class="add-contact-form">
                    <h3 id="contact-form-title" style="margin-top:0">添加联系人</h3>
                    <input type="hidden" id="contact-id-hidden">
                    <div class="form-group">
                        <label>头像 (文件 或 URL)</label>
                        <input type="file" id="contact-avatar-input" accept="image/*">
                        <input type="text" id="contact-avatar-url" placeholder="或者输入图片URL" style="margin-top:5px;">
                    </div>
                    <div class="form-group"><label>姓名</label><input type="text" id="contact-name-input"></div>
                    <div class="form-group"><label>人设 (Prompt)</label><textarea id="contact-persona-input"></textarea></div>
                    <button class="save-btn" onclick="saveContact()">保存</button>
                    <button class="save-btn" onclick="closeContactForm()" style="background:#eee; color:#333; margin-top:10px;">取消</button>
                </div>
                <div id="contacts-list"></div>
            </div>
        </div>

        <!-- 5. 世界书 App -->
        <div id="app-worldbook" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">世界书</div>
                <div class="action-btn" onclick="toggleWBCreateMenu()">+</div>
            </div>
            <div class="wb-create-menu" id="wb-create-menu">
                <div class="wb-menu-item" onclick="openWBEditor()">新建世界书</div>
                <div class="wb-menu-item" onclick="createWBCategory()">新建分类</div>
            </div>
            <div class="wb-tabs">
                <div class="wb-tab active" onclick="switchWBTab('global')" id="wb-tab-global">全局世界书</div>
                <div class="wb-tab" onclick="switchWBTab('local')" id="wb-tab-local">局部世界书</div>
            </div>
            <div class="app-content" id="wb-content-list"></div>
            
            <div id="wb-editor-modal">
                <div class="app-header">
                    <div class="back-btn" onclick="closeWBEditor()">取消</div>
                    <div class="app-title">编辑世界书</div>
                    <div class="action-btn" onclick="saveWBEntry()">保存</div>
                </div>
                <div class="app-content">
                    <input type="hidden" id="wb-edit-id">
                    <div class="form-group"><label>标题</label><input type="text" id="wb-edit-title"></div>
                    <div class="form-group"><label>类型</label><select id="wb-edit-type"><option value="global">全局 (Global)</option><option value="local">局部 (Local)</option></select></div>
                    <div class="form-group"><label>分类</label><select id="wb-edit-category"></select></div>
                    <div class="form-group"><label>正文内容</label><textarea id="wb-edit-content" style="height: 300px;"></textarea></div>
                </div>
            </div>
        </div>

        <!-- 6. 查岗 (Spy) App - 角色列表 -->
        <div id="app-spy-list" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">查岗</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content" id="spy-contact-list"></div>
        </div>

        <!-- 7. 查岗 (Spy) App - 角色模拟手机桌面 -->
        <div id="app-spy-home" class="screen">
            <div class="app-header">
                <div style="width:60px;"></div> 
                <div class="app-title" id="spy-home-title" style="color:#fff; padding:0;">Role Phone</div>
                <div class="action-btn"></div>
            </div>
            <!-- 专用图标网格容器 -->
            <div class="spy-app-grid">
                <div class="app-icon" id="spy-icon-vk" onclick="openSpyVK()">VK<div class="app-label">Vkontakte</div></div>
                <div class="app-icon" id="spy-icon-memos" onclick="openSpyMemos()" style="background-color:#f1c40f; color:#000;">📝<div class="app-label">备忘录</div></div>
                <!-- 新增：浏览器和日记图标 -->
                <div class="app-icon" id="spy-icon-browser" onclick="openSpyBrowser()" style="background-color:#007aff; color:#fff;">🌐<div class="app-label">浏览器</div></div>
                <div class="app-icon" id="spy-icon-diary" onclick="openSpyDiary()" style="background-color:#8e44ad; color:#fff;">📔<div class="app-label">日记</div></div>
                <!-- 新增：设置图标 -->
                <div class="app-icon" id="spy-icon-settings" onclick="openSpySettings()" style="background-color:#8e8e93; color:#fff;">⚙️<div class="app-label">设置</div></div>
            </div>
        </div>

        <!-- 8. 查岗 (Spy) - 模拟 VK 联系人列表 -->
        <div id="app-spy-vk" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">Vkontakte</div>
                <div class="action-btn">
                    <span onclick="refreshSpyVK()" style="margin-right:15px; font-size:18px;">🔄</span>
                    <span onclick="generateSpyChat()" style="margin-right:15px; font-size:20px;">+</span>
                    <span onclick="clearSpyVK()" style="font-size:20px;">🗑️</span>
                </div>
            </div>
            <div class="app-content" id="spy-vk-contacts"></div>
        </div>

        <!-- 9. 查岗 (Spy) - 模拟 VK 聊天界面 -->
        <div id="app-spy-vk-chat" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-vk')">Back</div>
                <div class="app-title" id="spy-vk-chat-title">Chat</div>
                <div class="action-btn"></div>
            </div>
            <div class="chat-messages" id="spy-vk-messages"></div>
        </div>

        <!-- 10. 查岗 (Spy) - 模拟备忘录 -->
        <div id="app-spy-memos" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">备忘录</div>
                <div class="action-btn">
                    <span onclick="refreshSpyMemos()" style="margin-right:15px; font-size:18px;">🔄</span>
                    <span onclick="generateSpyMemos()" style="margin-right:15px; font-size:20px;">+</span>
                    <span onclick="clearSpyMemos()" style="font-size:20px;">🗑️</span>
                </div>
            </div>
            <div class="app-content memo-list" id="spy-memo-list"></div>
        </div>

        <!-- 新增：查岗 (Spy) - 模拟浏览器 -->
        <div id="app-spy-browser" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">浏览器</div>
                <div class="action-btn">
                    <span onclick="refreshSpyBrowser()" style="margin-right:15px; font-size:18px;">🔄</span>
                    <span onclick="generateSpyBrowser()" style="margin-right:15px; font-size:20px;">+</span>
                    <span onclick="clearSpyBrowser()" style="font-size:20px;">🗑️</span>
                </div>
            </div>
            <div class="app-content" id="spy-browser-list"></div>
        </div>

        <!-- 新增：查岗 (Spy) - 角色手机设置 -->
        <div id="app-spy-settings" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">设置</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content">
                <div class="theme-section-title">壁纸设置</div>
                
                <div class="form-group">
                    <label>壁纸类型</label>
                    <div class="theme-option-row">
                        <div class="theme-option-btn active" id="spy-theme-type-color" onclick="switchSpyThemeType('color')">纯色</div>
                        <div class="theme-option-btn" id="spy-theme-type-image" onclick="switchSpyThemeType('image')">图片</div>
                    </div>
                    
                    <div id="spy-theme-input-color">
                        <div class="color-picker-wrapper">
                            <input type="color" id="spy-theme-wallpaper-color" value="#ffffff" style="width:50px; height:40px; padding:0; border:none;">
                            <span>选择颜色</span>
                        </div>
                    </div>

                    <div id="spy-theme-input-image" style="display:none;">
                        <input type="file" id="spy-theme-wallpaper-image" accept="image/*">
                        <input type="text" id="spy-theme-wallpaper-url" placeholder="或者输入图片URL" style="margin-top:5px;">
                        <div style="font-size:11px; color:#888; margin-top:5px;">上传图片或输入URL作为壁纸</div>
                    </div>
                </div>

                <button class="save-btn" onclick="saveSpyWallpaper()">保存壁纸设置</button>

                <hr class="theme-divider">

                <div class="theme-section-title">桌面图标设置</div>

                <div class="form-group">
                    <label>选择应用</label>
                    <select id="spy-theme-app-select" style="margin-bottom:10px;">
                        <option value="spy-icon-vk">Vkontakte</option>
                        <option value="spy-icon-memos">备忘录</option>
                        <option value="spy-icon-browser">浏览器</option>
                        <option value="spy-icon-diary">日记</option>
                        <option value="spy-icon-settings">设置</option>
                    </select>
                    
                    <label style="margin-top:10px">图标图片</label>
                    <input type="file" id="spy-theme-icon-file" accept="image/*">
                    <input type="text" id="spy-theme-icon-url" placeholder="或者输入图片URL" style="margin-top:5px;">
                    
                    <button class="save-btn" style="margin-top:15px; background:#007aff;" onclick="saveSpyAppIcon()">保存图标</button>
                </div>

                <hr class="theme-divider">

                <!-- 一键清空角色手机美化 -->
                <button class="save-btn" style="background:#ff3b30; margin-bottom:30px;" onclick="resetSpyTheme()">⚠️ 重置角色手机美化</button>
            </div>
        </div>

        <!-- 新增：查岗 (Spy) - 模拟日记 -->
        <div id="app-spy-diary" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">日记</div>
                <div class="action-btn">
                    <span onclick="refreshSpyDiary()" style="margin-right:15px; font-size:18px;">🔄</span>
                    <span onclick="generateSpyDiary()" id="spy-diary-add-btn" style="margin-right:15px; font-size:20px;">+</span>
                    <span onclick="clearSpyDiaries()" style="font-size:20px;">🗑️</span>
                </div>
            </div>
            <div class="app-content" id="spy-diary-list" style="background:#f9f9f9;"></div>
            
            <!-- 查岗日记专用编辑弹窗 -->
            <div id="spy-diary-edit-modal">
                <div class="offline-edit-header">
                    <span style="color:#ff3b30; cursor:pointer;" onclick="closeSpyDiaryEdit()">取消</span>
                    <span>编辑日记</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="saveSpyDiaryEdit()">完成</span>
                </div>
                <div class="offline-edit-content">
                    <textarea id="spy-diary-edit-textarea"></textarea>
                </div>
            </div>
        </div>

        <!-- 11. 美化 (Theme) App -->
        <div id="app-theme" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">美化</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content">
                <div class="theme-section-title">全局美化预设</div>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="save-btn" style="background:#333;" onclick="exportThemePreset()">导出预设 (JSON)</button>
                    <button class="save-btn" style="background:#007aff;" onclick="document.getElementById('import-theme-file').click()">导入预设</button>
                    <input type="file" id="import-theme-file" style="display:none" onchange="importThemePreset(this)" accept=".json,application/json,text/plain,*/*">
                </div>
                <div style="font-size:11px; color:#888; margin-top:-15px; margin-bottom:20px;">包含：壁纸、边框、图标、聊天背景/气泡、线下模式背景。</div>

                <hr class="theme-divider">

                <div class="theme-section-title">壁纸选择</div>
                
                <div class="form-group">
                    <label>壁纸类型</label>
                    <div class="theme-option-row">
                        <div class="theme-option-btn active" id="theme-type-color" onclick="switchThemeType('color')">纯色</div>
                        <div class="theme-option-btn" id="theme-type-image" onclick="switchThemeType('image')">图片</div>
                    </div>
                    
                    <div id="theme-input-color">
                        <div class="color-picker-wrapper">
                            <input type="color" id="theme-wallpaper-color" value="#ffffff" style="width:50px; height:40px; padding:0; border:none;">
                            <span>选择颜色</span>
                        </div>
                    </div>

                    <div id="theme-input-image" style="display:none;">
                        <input type="file" id="theme-wallpaper-image" accept="image/*">
                        <input type="text" id="theme-wallpaper-url" placeholder="或者输入图片URL" style="margin-top:5px;">
                        <div style="font-size:11px; color:#888; margin-top:5px;">上传图片或输入URL作为壁纸</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>手机边框颜色</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="theme-case-color" value="#1a1a1a" style="width:50px; height:40px; padding:0; border:none;">
                        <span>选择边框颜色</span>
                    </div>
                    <div class="theme-note">请关闭设置中的"无边框全屏模式"来使用此功能</div>
                </div>

                <button class="save-btn" onclick="saveTheme()">应用并保存壁纸设置</button>

                <hr class="theme-divider">

                <div class="theme-section-title">桌面图标设置</div>

                <div class="form-group">
                    <label>选择应用</label>
                    <select id="theme-app-select" style="margin-bottom:10px;">
                        <option value="icon-app-vk">Vkontakte</option>
                        <option value="icon-app-contacts">通讯录</option>
                        <option value="icon-app-memos">备忘录</option>
                        <option value="icon-app-calendar">日历</option>
                        <option value="icon-app-worldbook">世界书</option>
                        <option value="icon-app-spy-list">查岗</option>
                        <option value="icon-app-theme">美化</option>
                        <option value="icon-app-settings">设置</option>
                        <option value="icon-app-couple">情侣空间</option>
                        <option value="icon-app-tomato">番茄钟</option>
                        <option value="icon-app-music">音乐</option>
                        <option value="icon-app-forum">论坛</option>
                        <option value="icon-app-shopping">购物</option>
                        <option value="icon-app-game">小游戏</option>
                        <option value="icon-app-accounting">记账</option>
                        <option value="icon-app-wallet">钱包</option>
                    </select>
                    
                    <label style="margin-top:10px">图标图片</label>
                    <input type="file" id="theme-icon-file" accept="image/*">
                    <input type="text" id="theme-icon-url" placeholder="或者输入图片URL" style="margin-top:5px;">
                    
                    <button class="save-btn" style="margin-top:15px; background:#007aff;" onclick="saveAppIcon()">保存图标</button>
                </div>

                <hr class="theme-divider">

                <div class="theme-section-title">全局字体设置</div>
                <div class="form-group">
                    <label>字体文件 URL (WOFF2/TTF)</label>
                    <input type="text" id="theme-font-url" placeholder="https://example.com/font.woff2">
                    <div class="theme-note">建议使用 HTTPS 链接。设置后将应用到全局。</div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="save-btn" style="flex:1;" onclick="saveFont()">应用字体</button>
                        <button class="save-btn" style="flex:1; background:#eee; color:#333;" onclick="resetFont()">恢复默认</button>
                    </div>
                </div>

                <!-- 新增：全局字体颜色设置 -->
                <div class="form-group" style="margin-top:20px;">
                    <label>全局字体颜色</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="theme-font-color" value="#000000" style="width:50px; height:40px; padding:0; border:none;">
                        <span>选择颜色</span>
                    </div>
                    <button class="save-btn" style="margin-top:10px;" onclick="saveFontColor()">保存字体颜色</button>
                </div>

                <hr class="theme-divider">

                <!-- 新增：一键清空美化 -->
                <button class="save-btn" style="background:#ff3b30; margin-bottom:30px;" onclick="resetAllThemes()">⚠️ 一键清空所有美化</button>
            </div>
        </div>

        <!-- 12. VKontakte App (主) -->
        <div id="app-vk" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">Vkontakte</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content" id="vk-chat-list"></div>
        </div>

        <!-- 13. 聊天界面 (主) -->
        <div id="chat-interface">
            <div class="app-header">
                <div class="back-btn" onclick="closeChat()">Back</div>
                <div style="position:absolute; left:50%; transform:translateX(-50%); display:flex; align-items:center; gap:5px;">
                    <span id="chat-title" style="font-size:18px; font-weight:700;">Chat</span>
                    <span onclick="toggleThoughts()" style="cursor:pointer; font-size:16px; color:#ff2d55;">❤️</span>
                </div>
                <div class="action-btn" onclick="openChatSettings()">⚙️</div>
            </div>

            <div id="thoughts-modal" class="thoughts-modal">
                <div class="thoughts-close" onclick="toggleThoughts()">✕</div>
                <div class="thoughts-header">❤️ 角色心声</div>
                <div class="thoughts-content" id="thoughts-text">暂无心声...</div>
            </div>

            <!-- 语音通话界面 -->
            <div id="call-screen">
                <img id="call-avatar" class="call-avatar" src="">
                <div id="call-status" class="call-status">正在连接...</div>
                <div id="call-timer" class="call-timer">00:00</div>
                
                <!-- 通话界面的消息列表容器 -->
                <div id="call-history" class="chat-messages" style="background:transparent; width:100%; flex-grow:1; mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);"></div>

                <div class="call-controls-container">
                    <!-- 通话界面的输入框 -->
                    <div class="call-input-container">
                        <button class="icon-btn trigger-ai-btn" onclick="triggerAIResponse()">✨</button>
                        <input type="text" class="chat-input" id="call-message-input" placeholder="通话中..." onkeydown="handleEnterKey(event)">
                        <button class="icon-btn send-btn" onclick="sendMessage()">➤</button>
                    </div>
                    
                    <div class="call-hangup-btn" onclick="endCall()">📞</div>
                </div>
            </div>

            <!-- 线下模式界面 -->
            <div id="offline-mode">
                <div class="app-header" style="background: rgba(255,255,255,0.8); border-bottom: 1px solid #e0e0e0; backdrop-filter: blur(10px);">
                    <div class="back-btn" onclick="exitOfflineMode()">退出</div>
                    <div class="app-title">线下见面</div>
                    <div class="action-btn" onclick="openOfflineSettings()">⚙️</div>
                </div>
                <div id="offline-history"></div>
                
                <!-- 线下模式状态提示 -->
                <div id="offline-typing-indicator" class="typing-indicator" style="background: transparent; color: #888; margin-bottom: 5px;">对方正在行动中...</div>
                
                <div class="offline-input-area">
                    <input type="text" class="chat-input" id="offline-message-input" placeholder="描述你的动作或语言..." onkeydown="handleEnterKey(event)">
                    <button class="icon-btn send-btn" onclick="sendMessage()">➤</button>
                </div>
            </div>

            <div class="chat-messages" id="chat-history"></div>
            <div class="typing-indicator" id="typing-indicator">对方正在输入...</div>
            
            <!-- 表情包面板 -->
            <div id="sticker-panel">
                <div class="sticker-panel-header">
                    <div class="sticker-panel-title">表情包</div>
                    <button class="sticker-add-btn" onclick="openStickerManager()">+</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f0f0f0; margin-bottom:8px;">
                    <span style="font-size:12px; color:#666;">允许角色使用表情包</span>
                    <label class="switch" style="margin:0;"><input type="checkbox" id="ai-sticker-toggle"><span class="slider"></span></label>
                </div>
                <div class="sticker-grid" id="sticker-grid"></div>
            </div>

            <div class="chat-tools-bar">
                <button class="tool-btn" onclick="toggleStickerPanel()">😊 表情包</button>
                <button class="tool-btn" onclick="regenerateLastResponse()">🔄 刷新</button>
                <button class="tool-btn" onclick="continueChat()">⏩ 继续</button>
                <button class="tool-btn" onclick="openTransferModal()">💰 转账</button>
                <button class="tool-btn" onclick="startCall()">📞 通话</button>
                <button class="tool-btn" onclick="openOfflineMode()">📴 线下模式</button>
            </div>

            <div id="quote-preview-area">
                <div class="quote-preview-text" id="quote-preview-content">引用内容...</div>
                <div class="quote-close-btn" onclick="cancelQuote()">✕</div>
            </div>

            <div class="chat-input-area">
                <button class="icon-btn trigger-ai-btn" onclick="triggerAIResponse()">✨</button>
                <input type="text" class="chat-input" id="message-input" placeholder="输入消息..." onkeydown="handleEnterKey(event)">
                <button class="icon-btn send-btn" onclick="sendMessage()">➤</button>
            </div>

            <div class="ctx-overlay" id="ctx-overlay" onclick="closeAllOverlays()"></div>

            <div id="msg-context-menu">
                <div class="ctx-menu-item" onclick="triggerQuote()">引用</div>
                <div class="ctx-menu-item" onclick="triggerEdit()">编辑</div>
                <div class="ctx-menu-item" id="ctx-retract-btn" onclick="triggerRetract()">撤回</div>
                <div class="ctx-menu-item" onclick="triggerDeleteMode()">删除</div>
                <div class="ctx-menu-item" style="color:#333" onclick="closeContextMenu()">取消</div>
            </div>

            <div id="delete-mode-bar">
                <div class="delete-cancel-btn" onclick="exitDeleteMode()">取消</div>
                <div class="delete-confirm-btn" onclick="confirmDeleteMessages()">删除选中</div>
            </div>

            <div id="edit-msg-modal">
                <div class="app-header">
                    <div class="back-btn" onclick="closeEditModal()">取消</div>
                    <div class="app-title">编辑消息</div>
                    <div class="action-btn" onclick="saveEditedMessage()">保存</div>
                </div>
                <div class="app-content">
                    <div class="form-group">
                        <textarea id="edit-msg-textarea" style="height: 300px;"></textarea>
                    </div>
                </div>
            </div>

            <div id="transfer-modal">
                <div class="transfer-box">
                    <h3>转账</h3>
                    <div class="form-group">
                        <label>金额</label>
                        <input type="number" id="transfer-amount" placeholder="输入金额">
                    </div>
                    <div class="form-group">
                        <label>备注</label>
                        <input type="text" id="transfer-note" placeholder="转账备注">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="save-btn" style="background:#eee; color:#333;" onclick="closeTransferModal()">取消</button>
                        <button class="save-btn" onclick="sendTransfer()">确认转账</button>
                    </div>
                </div>
            </div>

            <!-- 表情包管理弹窗 -->
            <div id="sticker-manager-modal">
                <div class="sticker-manager-header">
                    <span>表情包管理</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="closeStickerManager()">完成</span>
                </div>
                <div class="sticker-manager-content">
                    <div class="sticker-upload-tabs">
                        <div class="sticker-upload-tab active" onclick="switchStickerUploadTab('single')">单独上传</div>
                        <div class="sticker-upload-tab" onclick="switchStickerUploadTab('batch')">批量上传</div>
                    </div>

                    <!-- 单独上传 -->
                    <div id="sticker-upload-single" class="sticker-upload-section active">
                        <div class="sticker-preview-container" id="sticker-preview-single">
                            <span class="sticker-preview-placeholder">预览</span>
                        </div>
                        <div class="form-group">
                            <label>上传方式</label>
                            <input type="file" id="sticker-file-input" accept="image/*" onchange="previewSingleSticker(this)">
                            <input type="text" id="sticker-url-input" placeholder="或输入图片URL" style="margin-top:5px;" oninput="previewSingleStickerUrl(this.value)">
                        </div>
                        <div class="form-group">
                            <label>表情包描述（AI将读取此文字）</label>
                            <input type="text" id="sticker-desc-input" placeholder="例如：开心、大笑、哭泣等">
                        </div>
                        <button class="save-btn" onclick="saveSingleSticker()">保存表情包</button>
                    </div>

                    <!-- 批量上传 -->
                    <div id="sticker-upload-batch" class="sticker-upload-section">
                        <div class="form-group">
                            <label>批量上传格式</label>
                            <textarea id="sticker-batch-input" placeholder="每行一个表情包，格式：描述：图片URL&#10;例如：&#10;开心：https://example.com/happy.png&#10;难过：https://example.com/sad.png" style="height:200px;"></textarea>
                            <div style="font-size:11px; color:#888; margin-top:5px;">
                                格式说明：每行一个表情包，使用中文冒号分隔描述和URL<br>
                                示例：开心：https://example.com/happy.png
                            </div>
                        </div>
                        <button class="save-btn" onclick="saveBatchStickers()">批量保存</button>
                    </div>
                </div>
            </div>

            <div id="chat-settings-modal">
                <div class="settings-modal-header">
                    <span>聊天设置</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="closeChatSettings()">完成</span>
                </div>
                <div class="settings-modal-content">
                    <div class="settings-section-title" style="margin-top:0">当前对话的用户设定</div>
                    <div style="text-align:center;">
                        <img id="user-setting-avatar-preview" class="user-avatar-upload" src="" onclick="document.getElementById('user-setting-avatar-input').click()">
                        <input type="file" id="user-setting-avatar-input" style="display:none;" accept="image/*" onchange="previewUserAvatar(this)">
                        <input type="text" id="user-setting-avatar-url" placeholder="或者输入图片URL" style="margin-top:5px; width:80%; font-size:12px; padding:5px;">
                        <div style="font-size:12px; color:#999; margin-bottom:10px;">点击头像上传或输入URL</div>
                    </div>
                    <div class="form-group"><label>用户名称</label><input type="text" id="user-setting-name" placeholder="例如：旅行者"></div>
                    <div class="form-group"><label>用户人设</label><textarea id="user-setting-persona" placeholder="例如：你是一个路过的冒险家..." style="height:80px;"></textarea></div>

                    <div class="toggle-switch" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                        <span class="toggle-label" style="font-size:14px; font-weight:bold;">开启 AI 时间感知</span>
                        <label class="switch"><input type="checkbox" id="time-perception-toggle"><span class="slider"></span></label>
                    </div>
                    <div style="font-size:11px; color:#888; margin-bottom:20px;">开启后，AI 将知道当前现实时间，并根据作息和回复间隔做出反应。</div>

                    <div class="settings-section-title">记忆与上下文</div>
                    <div class="toggle-switch">
                        <span class="toggle-label" style="font-size:14px; font-weight:bold;">自动记忆总结</span>
                        <label class="switch"><input type="checkbox" id="auto-summary-toggle"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>总结频率 (轮)</label>
                        <input type="number" id="summary-interval-input" placeholder="默认20" value="20">
                    </div>
                    <div class="form-group">
                        <label>上下文记忆数量 (条)</label>
                        <input type="number" id="context-limit-input" placeholder="默认100" value="100">
                    </div>

                    <div class="settings-section-title">绑定局部世界书</div>
                    <div class="bind-wb-list" id="bind-wb-list"></div>
                    <div style="font-size:11px; color:#999; margin-top:5px;">勾选后，该条目将仅对当前角色生效。</div>

                    <div class="settings-section-title">聊天界面美化</div>
                    
                    <div class="form-group">
                        <label>用户气泡 (User)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="theme-user-color" value="#007aff" style="width:50px; height:40px; padding:0; border:none;">
                            <input type="text" id="theme-user-css" placeholder="自定义 CSS (如: border-radius:0)" style="flex:1;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>角色气泡 (Character)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="theme-ai-color" value="#ffffff" style="width:50px; height:40px; padding:0; border:none;">
                            <input type="text" id="theme-ai-css" placeholder="自定义 CSS" style="flex:1;">
                        </div>
                    </div>
                    
                    <button class="save-btn" style="background:#333; margin-bottom:20px;" onclick="saveChatBubbleSettings()">保存气泡设置</button>

                    <div class="form-group">
                        <label>聊天背景</label>
                        <div class="theme-option-row">
                            <div class="theme-option-btn active" id="chat-bg-type-color" onclick="switchChatBgType('color')">纯色</div>
                            <div class="theme-option-btn" id="chat-bg-type-image" onclick="switchChatBgType('image')">图片</div>
                        </div>
                        
                        <div id="chat-bg-input-color">
                            <div class="color-picker-wrapper">
                                <input type="color" id="theme-chat-bg-color" value="#f5f5f5" style="width:50px; height:40px; padding:0; border:none;">
                                <span>选择背景颜色</span>
                            </div>
                        </div>

                        <div id="chat-bg-input-image" style="display:none;">
                            <input type="file" id="theme-chat-bg-file" accept="image/*">
                            <input type="text" id="theme-chat-bg-url" placeholder="或者输入图片URL" style="margin-top:5px;">
                        </div>
                    </div>
                    
                    <button class="save-btn" style="background:#333;" onclick="saveChatBgSettings()">保存聊天背景设置</button>

                    <button class="save-btn" style="background:#5856d6; margin-top:20px;" onclick="applyThemeToAllChats()">将气泡和背景应用到全部聊天</button>

                    <div style="margin-top: auto; padding-top: 20px;">
                        <button class="save-btn" style="background: #ff3b30;" onclick="clearCurrentHistory()">清空聊天记录</button>
                    </div>
                </div>
            </div>
            
            <div id="offline-settings-modal">
                <div class="settings-modal-header">
                    <span>线下模式设置</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="closeOfflineSettings()">完成</span>
                </div>
                <div class="settings-modal-content" style="max-height: 70vh; overflow-y: auto;">
                    <div class="form-group">
                        <label>最小字数</label>
                        <input type="number" id="offline-min-len" placeholder="500">
                    </div>
                    <div class="form-group">
                        <label>最大字数</label>
                        <input type="number" id="offline-max-len" placeholder="700">
                    </div>
                    <div class="form-group">
                        <label>文风/Prompt要求</label>
                        <textarea id="offline-style-prompt" placeholder="例如：细腻、沉浸感强..."></textarea>
                    </div>
                    
                    <div class="settings-section-title" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">叙事设置</div>
                    
                    <div class="form-group">
                        <label>复述设置</label>
                        <div class="theme-option-row">
                            <div class="theme-option-btn" id="offline-retell-yes" onclick="setOfflineRetell(true)">复述</div>
                            <div class="theme-option-btn active" id="offline-retell-no" onclick="setOfflineRetell(false)">不复述</div>
                        </div>
                        <div style="font-size:11px; color:#888; margin-top:5px;">复述：先扩写用户的回复，再展开后续剧情<br>不复述：直接展开后续剧情</div>
                    </div>
                    
                    <div class="form-group">
                        <label>抢话设置</label>
                        <div class="theme-option-row">
                            <div class="theme-option-btn" id="offline-interrupt-yes" onclick="setOfflineInterrupt(true)">抢话</div>
                            <div class="theme-option-btn active" id="offline-interrupt-no" onclick="setOfflineInterrupt(false)">不抢话</div>
                        </div>
                        <div style="font-size:11px; color:#888; margin-top:5px;">抢话：AI可主动续写用户下一步行动<br>不抢话：禁止AI代替用户发言和行动</div>
                    </div>
                    
                    <div class="settings-section-title" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">人称设置</div>
                    
                    <div class="form-group">
                        <label>叙事视角</label>
                        <select id="offline-perspective" style="width:100%;">
                            <option value="first_user">第一人称（用户视角，用"我"称呼用户）</option>
                            <option value="second">第二人称（用"你"称呼用户）</option>
                            <option value="third">第三人称（用用户名称称呼用户）</option>
                            <option value="first_char">角色第一人称（角色视角，用"我"称呼角色，用"你"称呼用户）</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-top:20px;">
                        <label>背景图片</label>
                        <input type="file" id="offline-bg-file" accept="image/*">
                        <input type="text" id="offline-bg-url" placeholder="或者输入图片URL" style="margin-top:5px;">
                    </div>
                    <button class="save-btn" onclick="saveOfflineSettings()">保存</button>
                </div>
            </div>

            <!-- 线下模式专用编辑弹窗 -->
            <div id="offline-edit-modal">
                <div class="offline-edit-header">
                    <span style="color:#ff3b30; cursor:pointer;" onclick="closeOfflineEditModal()">取消</span>
                    <span>编辑中</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="saveOfflineEditedMsg()">完成</span>
                </div>
                <div class="offline-edit-content">
                    <textarea id="offline-edit-textarea"></textarea>
                </div>
            </div>
        </div>

        <!-- 14. 备忘录 (Memo) App - 联系人列表 -->
        <div id="app-memos" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">备忘录</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content" id="memo-contact-list"></div>
        </div>

        <!-- 15. 备忘录 (Memo) App - 详情页 -->
        <div id="app-memo-detail" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-memos')">Back</div>
                <div class="app-title" id="memo-detail-title">Memories</div>
                <div class="action-btn" onclick="openMemoSettings()">⚙️</div>
            </div>
            <div class="app-content memo-list" id="memo-detail-list"></div>
            
            <!-- 备忘录设置弹窗 -->
            <div id="memo-settings-modal">
                <div class="settings-modal-header">
                    <span>备忘录设置</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="closeMemoSettings()">完成</span>
                </div>
                <div class="settings-modal-content">
                    <div class="settings-section-title" style="margin-top:0">手动添加</div>
                    <button class="save-btn" style="background:#34c759; margin-bottom:20px;" onclick="addImportantMemoryFromSettings()">+ 添加重要回忆</button>
                    
                    <div class="settings-section-title">每日总结设置</div>
                    
                    <div class="toggle-switch">
                        <span class="toggle-label" style="font-size:14px; font-weight:bold;">开启每日自动总结</span>
                        <label class="switch"><input type="checkbox" id="daily-summary-toggle" onchange="saveMemoSettings()"><span class="slider"></span></label>
                    </div>
                    <div style="font-size:11px; color:#888; margin-bottom:15px;">开启后，系统将在设定时间自动总结前24小时的聊天记录和记忆。</div>
                    
                    <div class="form-group" id="daily-summary-time-group">
                        <label>每日总结时间</label>
                        <input type="time" id="daily-summary-time" value="08:00" onchange="saveMemoSettings()" style="font-size:16px; padding:12px;">
                        <div style="font-size:11px; color:#888; margin-top:5px;">例如设置08:00，则每天早上8点总结前一天8点到今天8点的内容。</div>
                    </div>
                    
                    <div class="form-group" style="margin-top:15px;">
                        <label>上次总结时间</label>
                        <div id="last-summary-time" style="font-size:14px; color:#666; padding:10px 0;">暂无记录</div>
                    </div>
                    
                    <button class="save-btn" style="background:#007aff; margin-top:10px;" onclick="triggerManualDailySummary()">立即执行每日总结</button>
                    <div style="font-size:11px; color:#888; margin-top:5px;">手动触发一次每日总结，总结过去24小时的内容。</div>
                </div>
            </div>
        </div>

        <!-- 16. 日历 (Calendar) App -->
        <div id="app-calendar" class="screen">
            <div class="calendar-header">
                <div class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">◀</div>
                <div class="calendar-month-title" id="calendar-month-title">2023年 10月</div>
                <div class="calendar-nav-btn" onclick="changeCalendarMonth(1)">▶</div>
            </div>
            <div class="calendar-weekdays">
                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
            
            <!-- 月度事件列表区域 -->
            <div id="calendar-month-events" class="calendar-events-list"></div>

            <div class="app-header" style="border-top:1px solid #eee; border-bottom:none; height:60px; padding-top:0; flex-shrink:0;">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title" style="font-size:14px; color:#999;">Today</div>
                <div class="action-btn" onclick="goToToday()">今天</div>
            </div>

            <!-- 日历事件弹窗 -->
            <div id="calendar-event-modal">
                <div class="calendar-modal-content">
                    <div class="cal-modal-header">
                        <div class="cal-modal-title" id="cal-modal-date-title">10月27日</div>
                        <div style="display:flex; gap:15px;">
                            <div style="color:#ff3b30; cursor:pointer;" onclick="closeCalendarModal()">取消</div>
                            <div style="color:#007aff; cursor:pointer;" onclick="closeCalendarModal()">完成</div>
                        </div>
                    </div>
                    
                    <div class="event-type-grid">
                        <div class="event-type-btn" onclick="addCalendarEvent('anniversary')">❤️ 纪念日</div>
                        <!-- 修改：文本改为 TA的生日 -->
                        <div class="event-type-btn" onclick="addCalendarEvent('birthday_char')">🎂 TA的生日</div>
                        <div class="event-type-btn" onclick="addCalendarEvent('birthday_user')">🎉 我的生日</div>
                        <div class="event-type-btn" onclick="addCalendarEvent('period_start')">🩸 月经开始</div>
                        <div class="event-type-btn" onclick="addCalendarEvent('period_end')">🏁 月经结束</div>
                        <div class="event-type-btn" onclick="addCalendarEvent('custom')">📌 自定义行程</div>
                    </div>

                    <div id="cal-event-list"></div>
                </div>
            </div>
        </div>

        <!-- 17. 提问箱 (Question Box) App - 角色选择 -->
        <div id="app-question-box" class="screen">
            <div class="app-header qbox-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">提问箱</div>
                <div class="action-btn"></div>
            </div>
            <div class="qbox-content" id="qbox-contact-list">
                <!-- 动态填充联系人列表 -->
            </div>
        </div>

        <!-- 18. 提问箱 - 提问界面 -->
        <div id="app-question-box-ask" class="screen">
            <div class="app-header qbox-header">
                <div class="back-btn" onclick="openApp('app-question-box')">Back</div>
                <div class="app-title" id="qbox-ask-title">提问箱</div>
                <div class="action-btn"></div>
            </div>
            <div class="qbox-content">
                <!-- 提问输入区域 -->
                <div class="qbox-input-wrapper">
                    <div class="qbox-input-label">向TA提出问题...</div>
                    <div class="qbox-input-box">
                        <textarea id="qbox-question-input" placeholder="输入你想问的问题..."></textarea>
                    </div>
                    <div class="qbox-options">
                        <label class="qbox-anonymous-option">
                            <input type="checkbox" id="qbox-anonymous-toggle">
                            <span class="qbox-checkbox"></span>
                            <span>匿名提问</span>
                        </label>
                    </div>
                    <button class="qbox-send-btn" onclick="sendQuestion()">发送提问</button>
                </div>

                <!-- 历史问答列表 -->
                <div class="qbox-history" id="qbox-history-list">
                    <!-- 动态填充历史问答 -->
                </div>
            </div>

            <!-- 加载提示 -->
            <div id="qbox-loading" class="qbox-loading">
                <div class="qbox-loading-spinner"></div>
                <div>正在等待回答...</div>
            </div>
        </div>

        <!-- 19. 情侣空间 (Couple Space) App -->
        <div id="app-couple" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">情侣空间</div>
                <div class="action-btn" onclick="resetCoupleSpace()">⚙️</div>
            </div>
            
            <div class="couple-container" id="couple-lock-view">
                <div class="couple-lock-icon">🔒</div>
                <div class="couple-lock-title">空间未开启</div>
                <div class="couple-lock-desc">这里是属于你们二人的私密小天地。邀请心爱的 TA 一起开启这段甜蜜旅程吧！</div>
                <button class="couple-invite-btn" onclick="openCoupleInvite()">向 TA 发送开通邀请</button>
            </div>

            <div class="couple-container" id="couple-main-view" style="display:none;">
                <!-- 头部信息卡片 -->
                <div class="couple-glass-card couple-header-card">
                    <div class="couple-days-label">我们相爱已经</div>
                    <div class="couple-days" id="couple-days-count">0</div>
                    <div class="couple-days-label" style="font-size:12px; margin-bottom:15px;">DAYS</div>
                    <div class="couple-partner-info" id="couple-partner-info">
                        <!-- 动态填充 -->
                    </div>
                </div>
                
                <!-- 小树区域 -->
                <div class="couple-tree-section">
                    <div class="couple-tree-container" onclick="waterTree()">
                        <div class="couple-tree-base"></div>
                        <div class="couple-tree">🌳</div>
                        <div id="water-anim-container"></div>
                    </div>
                    
                    <button class="water-btn" id="water-btn" onclick="waterTree()">
                        <span>💧</span> <span id="water-btn-text">给小树浇水</span>
                    </button>
                    <div style="font-size:12px; margin-top:10px; color:rgba(255,255,255,0.8); text-shadow:0 1px 2px rgba(0,0,0,0.1);">每日打卡，让爱成长</div>
                </div>

                <!-- 功能按钮网格 -->
                <div class="couple-menu-grid">
                    <div class="couple-menu-item" onclick="openLoveLetterView()">
                        <div class="couple-menu-icon">💌</div>
                        <div class="couple-menu-text">交换情书</div>
                    </div>
                    <div class="couple-menu-item" onclick="openCoupleAlbum()">
                        <div class="couple-menu-icon">📸</div>
                        <div class="couple-menu-text">恋爱相册</div>
                    </div>
                    <div class="couple-menu-item" onclick="openCoupleMessageBoard()">
                        <div class="couple-menu-icon">📝</div>
                        <div class="couple-menu-text">留言板</div>
                    </div>
                </div>
            </div>

            <!-- 留言板界面 -->
            <div class="couple-container" id="couple-message-board-view" style="display:none; padding-top: 60px; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; background: #ffe4e1;">
                <div class="app-header" style="position:absolute; top:0; left:0; width:100%; background: rgba(255, 228, 225, 0.95); backdrop-filter: blur(10px);">
                    <div class="back-btn" onclick="closeCoupleMessageBoard()" style="color:#ff6b8a;">Back</div>
                    <div class="app-title" style="color:#ff6b8a;">留言板</div>
                    <div class="action-btn" style="display:flex; gap:15px; align-items:center;">
                        <span onclick="toggleMessageBoardDeleteMode()" style="color:#ff6b8a; font-size:18px;">🗑️</span>
                        <span onclick="openAddMessageModal()" style="color:#ff6b8a; font-size:24px;">+</span>
                    </div>
                </div>

                <div id="message-board-list" class="message-board-list">
                    <!-- 留言将动态填充 -->
                </div>

                <div class="message-board-footer">
                    <button class="couple-invite-btn" style="width:100%; background:#fffacd; color:#ff6b8a; border:1px solid #ffb6c1;" onclick="inviteTAMessage()">邀请TA来留言</button>
                </div>

                <!-- 删除模式底部栏 -->
                <div id="message-board-delete-bar" class="album-delete-bar">
                    <div class="album-delete-cancel" onclick="exitMessageBoardDeleteMode()">取消</div>
                    <div class="album-delete-confirm" onclick="confirmDeleteMessagesBoard()">删除选中</div>
                </div>
            </div>

            <!-- 添加留言弹窗 -->
            <div id="add-message-modal" class="album-modal">
                <div class="album-modal-content" style="background: #fffacd;">
                    <div class="album-modal-header" style="border-bottom: 1px dashed #ff6b8a;">
                        <span onclick="closeAddMessageModal()" style="color:#ff6b8a; cursor:pointer;">取消</span>
                        <span style="font-weight:bold; color:#5d4037;">写留言</span>
                        <span onclick="saveNewMessage()" style="color:#ff6b8a; cursor:pointer;">发布</span>
                    </div>
                    <textarea id="message-board-input" class="album-textarea" style="background: rgba(255,255,255,0.5); height: 150px;" placeholder="写下你想说的话..."></textarea>
                </div>
            </div>

            <!-- 回复留言弹窗 -->
            <div id="reply-message-modal" class="album-modal">
                <div class="album-modal-content" style="background: #fffacd;">
                    <div class="album-modal-header" style="border-bottom: 1px dashed #ff6b8a;">
                        <span onclick="closeReplyMessageModal()" style="color:#ff6b8a; cursor:pointer;">取消</span>
                        <span style="font-weight:bold; color:#5d4037;">回复TA</span>
                        <span onclick="saveReplyMessage()" style="color:#ff6b8a; cursor:pointer;">回复</span>
                    </div>
                    <div id="reply-target-content" style="font-size: 14px; color: #666; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 8px;"></div>
                    <textarea id="reply-message-input" class="album-textarea" style="background: rgba(255,255,255,0.5); height: 150px;" placeholder="回复TA的留言..."></textarea>
                </div>
            </div>


            <!-- 恋爱相册界面 -->
            <div class="couple-container" id="couple-album-view" style="display:none; padding-top: 60px; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; background: linear-gradient(135deg, #fff0f3 0%, #ffe4ec 100%);">
                <div class="app-header" style="position:absolute; top:0; left:0; width:100%; background: rgba(255,240,243,0.95); backdrop-filter: blur(10px);">
                    <div class="back-btn" onclick="closeCoupleAlbum()" style="color:#ff6b8a;">Back</div>
                    <div class="app-title" style="color:#ff6b8a;">恋爱相册</div>
                    <div class="action-btn" style="display:flex; gap:15px; align-items:center;">
                        <span onclick="toggleAlbumDeleteMode()" style="color:#ff6b8a; font-size:18px;">🗑️</span>
                        <span onclick="openAddPhotoModal()" style="color:#ff6b8a; font-size:24px;">+</span>
                    </div>
                </div>

                <div id="album-photos-container" class="album-photos-container">
                    <!-- 照片将动态填充 -->
                </div>

                <!-- 删除模式底部栏 -->
                <div id="album-delete-bar" class="album-delete-bar">
                    <div class="album-delete-cancel" onclick="exitAlbumDeleteMode()">取消</div>
                    <div class="album-delete-confirm" onclick="confirmDeletePhotos()">删除选中</div>
                </div>
                
                <div id="album-empty" class="album-empty">
                    <div class="album-empty-icon">📸</div>
                    <div class="album-empty-text">还没有照片哦</div>
                    <div class="album-empty-hint">点击右上角 + 添加第一张照片吧</div>
                </div>
            </div>

            <!-- 添加照片弹窗 -->
            <div id="add-photo-modal" class="album-modal">
                <div class="album-modal-content">
                    <div class="album-modal-header">
                        <span onclick="closeAddPhotoModal()" style="color:#ff6b8a; cursor:pointer;">取消</span>
                        <span style="font-weight:bold; color:#333;">添加照片</span>
                        <span onclick="saveNewPhoto()" style="color:#ff6b8a; cursor:pointer;">保存</span>
                    </div>
                    
                    <div class="album-form-group">
                        <label class="album-label">上传方式</label>
                        <div class="album-upload-tabs">
                            <div class="album-upload-tab active" id="upload-tab-file" onclick="switchUploadTab('file')">本地上传</div>
                            <div class="album-upload-tab" id="upload-tab-url" onclick="switchUploadTab('url')">URL上传</div>
                        </div>
                        
                        <div id="upload-file-section" class="album-upload-section">
                            <div class="album-file-preview" id="photo-file-preview">
                                <span>点击选择图片</span>
                            </div>
                            <input type="file" id="photo-file-input" accept="image/*" style="display:none;" onchange="previewPhotoFile(this)">
                        </div>
                        
                        <div id="upload-url-section" class="album-upload-section" style="display:none;">
                            <input type="text" id="photo-url-input" class="album-input" placeholder="请输入图片URL" oninput="previewPhotoUrl(this.value)">
                            <div class="album-url-preview" id="photo-url-preview"></div>
                        </div>
                    </div>
                    
                    <div class="album-form-group">
                        <label class="album-label">照片描述 <span style="color:#ff6b8a;">*必填</span></label>
                        <textarea id="photo-description" class="album-textarea" placeholder="简单描述一下照片中的内容..."></textarea>
                    </div>
                    
                    <div class="album-form-group">
                        <label class="album-label">我的评论 <span style="color:#999;">(选填)</span></label>
                        <textarea id="photo-user-comment" class="album-textarea" placeholder="写下你对这张照片的感想..."></textarea>
                    </div>
                    
                    <div class="album-divider"></div>
                    
                    <button class="album-invite-btn" onclick="inviteAddPhotos()">
                        <span>📸</span> 邀请TA来添加照片
                    </button>
                </div>
            </div>

            <!-- 照片查看弹窗 -->
            <div id="view-photo-modal" class="album-modal">
                <div class="album-view-content">
                    <div class="album-view-close" onclick="closeViewPhotoModal()">✕</div>
                    
                    <div class="album-view-photo" id="view-photo-container">
                        <!-- 照片或描述将动态填充 -->
                    </div>
                    
                    <div class="album-view-info">
                        <div class="album-view-description" id="view-photo-description"></div>
                        <div class="album-view-user-comment" id="view-photo-user-comment"></div>
                        <div class="album-view-char-comment" id="view-photo-char-comment"></div>
                    </div>
                    
                    <button class="album-comment-btn" id="invite-comment-btn" onclick="invitePhotoComment()">
                        <span></span> 邀请TA来评论
                    </button>
                    
                    <div class="album-comment-loading" id="comment-loading">
                        <div class="album-loading-spinner"></div>
                        <span>TA正在思考中...</span>
                    </div>
                </div>
            </div>

            <!-- 交换情书主界面 -->
            <div class="couple-container" id="couple-letter-view" style="display:none; padding-top: 60px; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; background: linear-gradient(135deg, #fff0f5 0%, #ffe8ef 100%);">
                <div class="app-header" style="position:absolute; top:0; left:0; width:100%; background: rgba(255, 240, 245, 0.95); backdrop-filter: blur(10px);">
                    <div class="back-btn" onclick="closeLoveLetterView()" style="color:#ff6b8a;">Back</div>
                    <div class="app-title" style="color:#ff6b8a;">交换情书</div>
                    <div class="action-btn" onclick="openLetterBox()" style="color:#ff6b8a; font-size:18px;">📬</div>
                </div>

                <!-- 情书主内容区域 -->
                <div id="letter-main-content" class="letter-main-content">
                    <!-- 默认邀请状态 -->
                    <div id="letter-invite-state" class="letter-invite-state">
                        <div class="letter-invite-icon">💌</div>
                        <div class="letter-invite-text">还没有情书哦，快去邀请TA写一封吧</div>
                        <button class="letter-invite-btn" onclick="inviteTAWriteLetter()">
                            <span>✉️</span> 邀请TA写情书
                        </button>
                    </div>

                    <!-- 加载状态 -->
                    <div id="letter-loading-state" class="letter-loading" style="display:none;">
                        <div class="letter-loading-icon">💌</div>
                        <div>TA正在认真写情书...</div>
                    </div>

                    <!-- 角色情书展示区域 -->
                    <div id="letter-display-area" style="display:none; width:100%; height:100%; overflow-y:auto; padding:15px;">
                        <div class="letter-paper-display" id="char-letter-paper">
                            <div class="letter-hearts-decoration">
                                <span>❤️</span><span>💕</span><span>❤️</span>
                            </div>
                            <div class="letter-content" id="char-letter-content"></div>
                        </div>
                        <button class="letter-exchange-btn" onclick="openLetterEditor()">
                            <span>💌</span> 交换情书
                        </button>
                    </div>
                </div>
            </div>

            <!-- 编辑情书界面 -->
            <div class="couple-container" id="couple-letter-editor" style="display:none; padding-top: 60px; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 55; background: linear-gradient(135deg, #fff0f5 0%, #ffe8ef 100%);">
                <div class="app-header" style="position:absolute; top:0; left:0; width:100%; background: rgba(255, 240, 245, 0.95); backdrop-filter: blur(10px);">
                    <div class="back-btn" onclick="closeLetterEditor()" style="color:#ff6b8a;">取消</div>
                    <div class="app-title" style="color:#ff6b8a;">写情书</div>
                    <div class="action-btn"></div>
                </div>

                <div class="letter-editor-content">
                    <div class="letter-paper-edit">
                        <div class="letter-hearts-decoration">
                            <span>❤️</span><span>💕</span><span>❤️</span>
                        </div>
                        <textarea id="love-letter-textarea" placeholder="亲爱的TA，我想对你说..."></textarea>
                    </div>
                    <button class="letter-exchange-btn" onclick="submitLetterExchange()" style="margin-top:15px;">
                        <span>💕</span> 向TA交换情书
                    </button>
                </div>
            </div>

            <!-- 情书收纳箱界面 -->
            <div class="couple-container" id="couple-letter-box" style="display:none; padding-top: 60px; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 55; background: linear-gradient(135deg, #fff0f5 0%, #ffe8ef 100%);">
                <div class="app-header" style="position:absolute; top:0; left:0; width:100%; background: rgba(255, 240, 245, 0.95); backdrop-filter: blur(10px);">
                    <div class="back-btn" onclick="closeLetterBox()" style="color:#ff6b8a;">Back</div>
                    <div class="app-title" style="color:#ff6b8a;">情书收纳箱</div>
                    <div class="action-btn"></div>
                </div>

                <div id="letter-box-content" class="letter-box-grid">
                    <!-- 情书预览卡片将动态填充 -->
                </div>

                <div id="letter-box-empty" class="letter-box-empty" style="display:none;">
                    <div class="letter-box-empty-icon">📭</div>
                    <div>还没有收纳的情书</div>
                    <div style="font-size:12px; margin-top:5px; opacity:0.7;">交换情书后会自动收纳到这里</div>
                </div>
            </div>

            <!-- 情书详情弹窗 -->
            <div id="letter-detail-modal" class="album-modal">
                <div class="letter-detail-content">
                    <div class="album-view-close" onclick="closeLetterDetailModal()">✕</div>
                    
                    <!-- TA的情书 -->
                    <div class="letter-detail-section">
                        <div class="letter-detail-label">💌 TA的情书</div>
                        <div class="letter-paper-display" style="margin-bottom:0;">
                            <div class="letter-hearts-decoration">
                                <span>❤️</span><span>💕</span><span>❤️</span>
                            </div>
                            <div class="letter-content" id="detail-char-letter"></div>
                        </div>
                    </div>

                    <!-- 分隔线 -->
                    <div class="letter-detail-divider">
                        <span>💕</span>
                    </div>

                    <!-- 我的情书 -->
                    <div class="letter-detail-section">
                        <div class="letter-detail-label">✉️ 我的情书</div>
                        <div class="letter-paper-display" style="margin-bottom:0;">
                            <div class="letter-hearts-decoration">
                                <span>❤️</span><span>💕</span><span>❤️</span>
                            </div>
                            <div class="letter-content" id="detail-user-letter"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 邀请弹窗 -->
            <div id="couple-invite-modal">
                <div class="invite-box">
                    <div class="invite-header">选择邀请对象</div>
                    <div class="invite-list" id="couple-invite-list">
                        <!-- 动态填充 -->
                    </div>
                    <button class="invite-close-btn" onclick="closeCoupleInvite()">取消</button>
                </div>
            </div>
        </div>

        <!-- 20. 论坛 App -->
        <div id="app-forum" class="screen">
            <div class="forum-header">
                <div class="forum-back-btn" onclick="goHome()">←</div>
                <div class="forum-title">论坛</div>
                <div class="forum-header-right">
                    <div class="forum-add-btn" onclick="openForumAddModal()">+</div>
                    <div class="forum-settings-btn" onclick="openForumSettings()">⚙️</div>
                </div>
            </div>
            
            <div class="forum-tabs">
                <div class="forum-tab active" id="forum-tab-following" onclick="switchForumTab('following')">关注</div>
                <div class="forum-tab" id="forum-tab-recommended" onclick="switchForumTab('recommended')">为你推荐</div>
            </div>
            
            <div class="forum-content" id="forum-posts-container">
                <!-- 帖子将在这里动态生成 -->
            </div>

            <!-- Forum Action Sheet -->
            <div id="forum-action-sheet" class="forum-action-sheet-overlay" onclick="closeForumActionSheet()">
                <div class="forum-action-sheet-content" onclick="event.stopPropagation()">
                    <div class="forum-action-sheet-item" onclick="handleForumEditAction()">编辑</div>
                    <div class="forum-action-sheet-item delete" onclick="handleForumDeleteAction()">删除</div>
                    <div class="forum-action-sheet-cancel" onclick="closeForumActionSheet()">取消</div>
                </div>
            </div>
        </div>
        
        <!-- 论坛设置弹窗 -->
        <div id="forum-settings-modal" class="forum-modal">
            <div class="forum-modal-content">
                <div class="forum-modal-header">
                    <span onclick="closeForumSettings()" style="color:#999; cursor:pointer;">取消</span>
                    <span style="font-weight:bold; color:#fff;">论坛设置</span>
                    <span onclick="saveForumSettings()" style="color:#5856d6; cursor:pointer;">保存</span>
                </div>
                <div class="forum-modal-body">
                    <div class="forum-form-group">
                        <label class="forum-label">论坛设定 (System Prompt)</label>
                        <textarea id="forum-system-prompt" class="forum-textarea" placeholder="例如：这是一个二次元爱好者聚集的论坛..."></textarea>
                    </div>
                    
                    <div class="forum-form-group" style="margin-top: 20px;">
                        <label class="forum-label">绑定发帖角色</label>
                        <div id="forum-bind-characters" style="max-height: 200px; overflow-y: auto; margin-top: 10px;"></div>
                        <div style="font-size: 11px; color: #999; margin-top: 8px;">勾选后，只有绑定的角色才能在论坛发帖</div>
                    </div>
                    
                    <button class="forum-clear-btn" onclick="clearAllForumPosts()">清空所有帖子</button>
                </div>
            </div>
        </div>
        
        <!-- 添加帖子弹窗 -->
        <div id="forum-add-modal" class="forum-modal">
            <div class="forum-modal-content">
                <div class="forum-modal-header">
                    <span onclick="closeForumAddModal()" style="color:#999; cursor:pointer;">取消</span>
                    <span style="font-weight:bold; color:#fff;">生成帖子</span>
                    <span></span>
                </div>
                <div class="forum-modal-body">
                    <div class="forum-add-options">
                        <div class="forum-add-option" onclick="generateForumPosts('character')">
                            <div class="forum-add-icon">👤</div>
                            <div class="forum-add-text">看看TA的帖子</div>
                        </div>
                        <div class="forum-add-option" onclick="generateForumPosts('passerby')">
                            <div class="forum-add-icon">👥</div>
                            <div class="forum-add-text">看看大家在聊什么</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 编辑帖子弹窗 -->
        <div id="forum-edit-modal" class="forum-modal">
            <div class="forum-modal-content">
                <div class="forum-modal-header">
                    <span onclick="closeForumEditModal()" style="color:#999; cursor:pointer;">取消</span>
                    <span style="font-weight:bold; color:#fff;">编辑帖子</span>
                    <span onclick="saveForumPostEdit()" style="color:#5856d6; cursor:pointer;">保存</span>
                </div>
                <div class="forum-modal-body">
                    <div class="forum-form-group">
                        <label class="forum-label">帖子内容</label>
                        <textarea id="forum-edit-textarea" class="forum-textarea"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 21. 音乐 App -->
        <div id="app-music" class="screen">
            <div class="app-header music-header">
                <div class="back-btn" onclick="goHome()">Back</div>
                <div class="app-title">音乐</div>
                <div class="action-btn" style="display:flex; gap:15px; align-items:center;">
                    <span onclick="toggleMusicDeleteMode()" style="font-size:18px;">🗑️</span>
                    <span onclick="openAddMusicModal()" style="font-size:24px;">+</span>
                </div>
            </div>
            <!-- 删除模式底部栏 -->
            <div id="music-delete-bar" class="album-delete-bar">
                <div class="album-delete-cancel" onclick="exitMusicDeleteMode()">取消</div>
                <div class="album-delete-confirm" onclick="confirmDeleteMusic()">删除选中</div>
            </div>
            <div class="app-content music-content" id="music-list">
                <!-- 音乐列表将动态填充 -->
            </div>
            
            <!-- 空状态 -->
            <div id="music-empty" class="music-empty">
                <div class="music-empty-icon">🎵</div>
                <div class="music-empty-text">还没有音乐哦</div>
                <div class="music-empty-hint">点击右上角的加号添加音乐吧</div>
            </div>
        </div>

        <!-- 添加音乐弹窗 -->
        <div id="add-music-modal" class="music-modal">
            <div class="music-modal-content">
                <div class="music-modal-header">
                    <span onclick="closeAddMusicModal()" style="color:#ff2d55; cursor:pointer;">取消</span>
                    <span style="font-weight:bold; color:#333;">添加音乐</span>
                    <span onclick="saveNewMusic()" style="color:#ff2d55; cursor:pointer;">保存</span>
                </div>
                <div class="music-modal-body">
                    <div class="music-form-group">
                        <label class="music-label">音乐标题 <span style="color:#ff2d55;">*必填</span></label>
                        <input type="text" id="music-title-input" class="music-input" placeholder="请输入音乐标题">
                    </div>
                    
                    <div class="music-form-group">
                        <label class="music-label">歌手/制作者 <span style="color:#ff2d55;">*必填</span></label>
                        <input type="text" id="music-artist-input" class="music-input" placeholder="请输入歌手或制作者名称">
                    </div>
                    
                    <div class="music-form-group">
                        <label class="music-label">音乐直链</label>
                        <input type="text" id="music-url-input" class="music-input" placeholder="https://music.163.com/song/media/outer/url?id=歌曲ID.mp3">
                        <div class="music-hint">格式：https://music.163.com/song/media/outer/url?id=歌曲ID.mp3</div>
                    </div>
                    
                    <div class="music-form-group">
                        <label class="music-label">音乐风格 <span style="color:#999;">(选填，推荐填写)</span></label>
                        <input type="text" id="music-style-input" class="music-input" placeholder="钢琴/舒缓/摇滚/轻音乐等...">
                    </div>
                    
                    <div class="music-form-group">
                        <label class="music-label">歌曲封面 <span style="color:#999;">(选填，推荐上传)</span></label>
                        <div class="music-cover-upload-tabs">
                            <div class="music-cover-tab active" id="cover-tab-file" onclick="switchCoverTab('file')">本地上传</div>
                            <div class="music-cover-tab" id="cover-tab-url" onclick="switchCoverTab('url')">URL上传</div>
                        </div>
                        <div id="cover-file-section">
                            <div class="music-cover-preview" id="music-cover-preview" onclick="document.getElementById('music-cover-file').click()">
                                <span>点击上传封面</span>
                                <img id="music-cover-preview-img" src="" style="display:none;">
                            </div>
                            <input type="file" id="music-cover-file" accept="image/*" style="display:none;" onchange="previewMusicCover(this)">
                        </div>
                        <div id="cover-url-section" style="display:none;">
                            <input type="text" id="music-cover-url" class="music-input" placeholder="请输入封面图片URL" oninput="previewMusicCoverUrl(this.value)">
                        </div>
                    </div>
                    
                    <div class="music-form-group">
                        <label class="music-label">歌词LRC文件 <span style="color:#999;">(请粘贴LRC文件的歌词内容)</span></label>
                        <textarea id="music-lyrics-input" class="music-textarea" placeholder="[00:00.00]歌词内容&#10;[00:05.00]第二行歌词&#10;..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 音乐播放器弹窗 -->
        <div id="music-player-modal" class="music-player-modal">
            <div class="music-player-content">
                <!-- 左上角缩小按钮 -->
                <div class="music-player-minimize" onclick="minimizeMusicPlayer()">−</div>
                
                <!-- 右上角退出按钮 -->
                <div class="music-player-close" onclick="closeMusicPlayer()">✕</div>
                
                <!-- 右下角菜单按钮 -->
                <div class="music-player-menu-btn" onclick="toggleMusicMenu()">☰</div>
                
                <!-- 旋转封面 -->
                <div class="music-player-cover-container">
                    <div class="music-player-cover" id="music-player-cover">
                        <img id="music-player-cover-img" src="" alt="封面">
                    </div>
                </div>
                
                <!-- 歌曲信息 -->
                <div class="music-player-info">
                    <div class="music-player-title" id="music-player-title">歌曲名称</div>
                    <div class="music-player-artist" id="music-player-artist">歌手</div>
                </div>
                
                <!-- 歌词显示区域 -->
                <div class="music-player-lyrics" id="music-player-lyrics">
                    <div class="lyrics-line">暂无歌词</div>
                </div>
                
                <!-- 进度条 -->
                <div class="music-player-progress-container">
                    <span class="music-time" id="music-current-time">0:00</span>
                    <div class="music-player-progress" onclick="seekMusic(event)">
                        <div class="music-player-progress-bar" id="music-progress-bar"></div>
                    </div>
                    <span class="music-time" id="music-duration">0:00</span>
                </div>
                
                <!-- 控制按钮 -->
                <div class="music-player-controls">
                    <div class="music-control-btn" onclick="prevMusic()">⏮</div>
                    <div class="music-control-btn play-btn" id="music-play-btn" onclick="toggleMusicPlay()">▶</div>
                    <div class="music-control-btn" onclick="nextMusic()">⏭</div>
                </div>
                
                <!-- 菜单弹出层 -->
                <div class="music-player-menu" id="music-player-menu">
                    <div class="music-menu-header">
                        <span class="music-menu-title">播放设置</span>
                        <span class="music-menu-close" onclick="toggleMusicMenu()">✕</span>
                    </div>
                    <div class="music-menu-item" onclick="switchPlayMode('single')">
                        <span>🔂</span> 单曲循环
                        <span class="music-menu-check" id="mode-single-check">✓</span>
                    </div>
                    <div class="music-menu-item" onclick="switchPlayMode('list')">
                        <span>📃</span> 列表播放
                        <span class="music-menu-check" id="mode-list-check" style="display:none;">✓</span>
                    </div>
                    <div class="music-menu-divider"></div>
                    <div class="music-menu-title">切换歌曲</div>
                    <div class="music-menu-songs" id="music-menu-songs">
                        <!-- 歌曲列表将动态填充 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 迷你播放器（可拖动） -->
        <div id="music-mini-player" class="music-mini-player">
            <img id="mini-player-cover" src="" alt="封面">
            <div class="mini-player-playing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>

        <!-- 隐藏的音频元素 -->
        <audio id="music-audio" preload="auto"></audio>

        <div class="home-indicator" onclick="goHome()"></div>
    </div>

    <!-- 引用外部 JavaScript 文件 -->
    <script src="script.js"></script>
</body>
</html>
