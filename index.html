<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPhone Simulator</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="iPhone Sim">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#000000">

    <style id="custom-font-style"></style>
    <style id="dynamic-chat-theme"></style>

    <style>
        /* --- ÂÖ®Â±ÄÊ†∑Âºè & ÈáçÁΩÆ --- */
        :root { 
            --case-color: #1a1a1a; 
            --wallpaper: #fff; 
            --global-text-color: #000000; /* ÂÖ®Â±ÄÂ≠ó‰ΩìÈ¢úËâ≤ÂèòÈáè */
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: #f0f0f0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; transition: background 0.3s; color: var(--global-text-color); }
        .phone-case { width: 375px; height: 812px; background: #000; border-radius: 40px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow: hidden; border: 12px solid var(--case-color); transition: all 0.3s ease; }
        body.fullscreen-mode { background-color: #000; }
        body.fullscreen-mode .phone-case { width: 100%; height: 100%; border: none; border-radius: 0; box-shadow: none; }
        .screen { width: 100%; height: 100%; background: #fff; position: relative; overflow: hidden; display: none; flex-direction: column; color: var(--global-text-color); }
        .screen.active { display: flex; }
        .status-bar { height: 44px; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-size: 14px; font-weight: 600; color: inherit; z-index: 100; position: absolute; top: 0; left: 0; pointer-events: none; }
        .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 150px; height: 30px; background: #1a1a1a; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; z-index: 101; transition: opacity 0.3s; }
        body.fullscreen-mode .notch { opacity: 0.8; } 
        .home-indicator { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 130px; height: 5px; background: #000; border-radius: 10px; z-index: 100; cursor: pointer; opacity: 0.3; }
        
        /* --- ÈîÅÂ±èÁïåÈù¢ --- */
        #lock-screen { background: var(--wallpaper); background-size: cover; background-position: center; justify-content: center; align-items: center; color: var(--global-text-color); }
        .clock { font-size: 80px; font-weight: 200; margin-bottom: 20px; }
        .date { font-size: 20px; margin-bottom: 200px; }
        .slider-container { width: 80%; position: relative; height: 50px; background: rgba(255,255,255,0.3); border-radius: 25px; display: flex; align-items: center; padding: 5px; backdrop-filter: blur(5px); }
        .slider-text { position: absolute; width: 100%; text-align: center; color: #333; font-size: 14px; pointer-events: none; animation: shimmer 2s infinite; }
        input[type="range"] { -webkit-appearance: none; width: 100%; background: transparent; z-index: 2; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 40px; width: 40px; border-radius: 50%; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; }
        @keyframes shimmer { 0% {opacity: 0.3;} 50% {opacity: 1;} 100% {opacity: 0.3;} }

        /* --- ‰∏ªÂ±èÂπï --- */
        #home-screen { background: var(--wallpaper); background-size: cover; background-position: center; padding-top: 50px; align-items: center; flex-direction: column; color: var(--global-text-color); }
        .home-header { width: 100%; padding: 0 25px; margin-bottom: 20px; color: inherit; text-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: left; }
        .home-time-big { font-size: 56px; font-weight: 300; line-height: 1; letter-spacing: -1px; margin: 0; margin-left: -3px; }
        .home-date-big { font-size: 18px; font-weight: 500; opacity: 0.9; margin-top: 5px; margin-left: 2px; }
        .home-widget-container { width: 100%; padding: 0 25px; margin-bottom: 30px; }
        .home-widget { width: 100%; aspect-ratio: 16/9; background: rgba(255,255,255,0.25); border-radius: 24px; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; cursor: pointer; color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500; }
        .home-widget img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .home-widget.has-image img { display: block; }
        .home-widget.has-image span { display: none; }
        .app-grid { width: 300px; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: center; column-gap: 20px; row-gap: 45px; }
        .app-icon { width: 60px; height: 60px; border-radius: 14px; background: #000; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 24px; cursor: pointer; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.1s; background-size: cover !important; background-position: center !important; flex-shrink: 0; }
        .app-icon:active { transform: scale(0.95); }
        .app-label { position: absolute; bottom: -25px; width: 140%; left: -20%; text-align: center; color: var(--global-text-color); font-size: 13px; font-weight: 600; text-shadow: 0 1px 3px rgba(255,255,255,0.9); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* --- ÈÄöÁî® App Â∏ÉÂ±Ä (‰øÆÊîπÔºöÂ∫îÁî®ÂÖ®Â±ÄÂ≠ó‰ΩìÈ¢úËâ≤) --- */
        .app-header { height: 88px; padding-top: 44px; display: flex; align-items: center; justify-content: space-between; padding-left: 15px; padding-right: 15px; border-bottom: 1px solid #eee; background: #fff; flex-shrink: 0; position: relative; z-index: 10; color: var(--global-text-color); }
        .app-title { font-size: 20px; font-weight: 700; position: absolute; left: 0; width: 100%; text-align: center; pointer-events: none; z-index: 1; padding: 0 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--global-text-color); }
        .back-btn { font-size: 16px; color: var(--global-text-color); cursor: pointer; width: 60px; display: flex; align-items: center; z-index: 50; position: relative; pointer-events: auto; }
        .action-btn { font-size: 16px; color: var(--global-text-color); cursor: pointer; width: auto; display: flex; justify-content: flex-end; align-items: center; z-index: 50; position: relative; height: 100%; pointer-events: auto; }
        
        .app-content { flex-grow: 1; overflow-y: auto; padding: 15px; background: #fff; color: #000; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; -webkit-appearance: none; background: #fff; color: #000; }
        .form-group textarea { height: 100px; resize: none; }
        .save-btn { width: 100%; padding: 15px; background: #000; color: #fff; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #000; }
        input:checked + .slider:before { transform: translateX(22px); }
        .input-group-row { display: flex; gap: 10px; }
        .fetch-btn { background: #007aff; color: #fff; border: none; border-radius: 8px; padding: 0 15px; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .fetch-btn:active { opacity: 0.8; }

        /* --- Êó•ÂéÜ App Ê†∑Âºè (‰øÆÊîπÔºöÂ∫îÁî®ÂÖ®Â±ÄÂ≠ó‰ΩìÈ¢úËâ≤) --- */
        #app-calendar .app-content { padding: 0; display: flex; flex-direction: column; }
        .calendar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: #fff; border-bottom: 1px solid #f0f0f0; flex-shrink: 0; }
        .calendar-month-title { font-size: 24px; font-weight: bold; color: var(--global-text-color); }
        .calendar-nav-btn { font-size: 20px; color: var(--global-text-color); cursor: pointer; padding: 10px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; padding: 10px 0; font-size: 12px; color: #999; background: #fff; flex-shrink: 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #fff; align-content: start; flex-shrink: 0; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 10px; cursor: pointer; position: relative; border-top: 1px solid #fafafa; }
        .calendar-day.other-month { color: #ccc; }
        .day-number { font-size: 16px; font-weight: 500; margin-bottom: 4px; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; z-index: 2; }
        .calendar-day.today .day-number { background: #ff3b30; color: #fff; }
        .calendar-day.has-event .day-number { background: #ff3b30; color: #fff; } 
        .calendar-day.period-day { background-color: #ffeff2; }
        .calendar-day.period-day::after { content: 'ÊúàÁªèÊúü'; font-size: 8px; color: #ff2d55; position: absolute; bottom: 2px; }
        .calendar-events-list { flex-grow: 1; background: #f9f9f9; border-top: 1px solid #eee; overflow-y: auto; padding: 15px; }
        .calendar-event-row { font-size: 14px; padding: 10px 0; border-bottom: 1px solid #e0e0e0; color: #333; display: flex; align-items: center; }
        .calendar-event-row:last-child { border-bottom: none; }
        .cal-event-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        #calendar-event-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 600; display: none; justify-content: center; align-items: flex-end; }
        #calendar-event-modal.active { display: flex; }
        .calendar-modal-content { width: 100%; background: #fff; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; animation: slideUp 0.3s; max-height: 80%; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .cal-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-modal-title { font-size: 18px; font-weight: bold; color: #000; }
        .event-type-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .event-type-btn { padding: 12px; border: 1px solid #eee; border-radius: 10px; text-align: center; font-size: 14px; cursor: pointer; color: #000; }
        .event-type-btn.active { background: #000; color: #fff; border-color: #000; }
        .event-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px; }

        /* --- ÂÖ∂‰ªñ App Ê†∑Âºè --- */
        .contact-list-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .avatar-preview { width: 50px; height: 50px; border-radius: 50%; background: #eee; object-fit: cover; margin-right: 15px; flex-shrink: 0; }
        .contact-info { flex-grow: 1; overflow: hidden; }
        .contact-name { font-weight: 600; font-size: 16px; }
        .contact-persona { font-size: 12px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .contact-actions { display: flex; gap: 10px; }
        .contact-btn { padding: 8px; cursor: pointer; font-size: 16px; }
        .add-contact-form { display: none; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .add-contact-form.active { display: block; }
        .chat-list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .chat-list-item:hover { background: #fafafa; }
        #chat-interface { display: none; flex-direction: column; height: 100%; background: #fff; position: absolute; top: 0; left: 0; width: 100%; z-index: 200; background-size: cover; background-position: center; }
        .chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: rgba(245,245,245,0.8); padding-bottom: 80px; }
        .message-row { display: flex; align-items: flex-end; width: 100%; position: relative; transition: all 0.2s; }
        .message-row.user { justify-content: flex-end; }
        .message-row.ai { justify-content: flex-start; }
        .chat-avatar-small { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .message-row.ai .chat-avatar-small { margin-right: 8px; }
        .message-row.user .chat-avatar-small { margin-left: 8px; }
        .bubble-container { max-width: 70%; display: flex; flex-direction: column; }
        .quote-block-in-msg { background: rgba(0,0,0,0.05); border-radius: 8px; padding: 8px; margin-bottom: 5px; font-size: 12px; color: #666; border-left: 3px solid #ccc; white-space: pre-wrap; word-wrap: break-word; }
        .user .quote-block-in-msg { background: rgba(255,255,255,0.2); color: #eee; border-left-color: #fff; }
        .message-bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; cursor: pointer; }
        .message-bubble.user { background: #007aff; color: #fff; border-bottom-right-radius: 4px; }
        .message-bubble.ai { background: #fff; color: #000; border: 1px solid #ddd; border-bottom-left-radius: 4px; }
        .transfer-bubble { background: #ff9500 !important; color: #fff !important; border: none !important; width: 220px; padding: 0 !important; overflow: hidden; display: flex; flex-direction: column; }
        .transfer-bubble.rejected { background: #ff3b30 !important; }
        .transfer-bubble.accepted { background: #34c759 !important; }
        .transfer-header { padding: 15px; display: flex; align-items: center; gap: 10px; }
        .transfer-icon { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold; }
        .transfer-info { display: flex; flex-direction: column; }
        .transfer-amount { font-size: 18px; font-weight: bold; }
        .transfer-status { font-size: 12px; opacity: 0.8; }
        .transfer-footer { background: rgba(255,255,255,0.2); padding: 8px 15px; font-size: 11px; }
        .system-message-bar { align-self: center; background: rgba(0, 0, 0, 0.3); color: #fff; padding: 5px 15px; border-radius: 15px; font-size: 12px; margin: 10px 0; max-width: 80%; text-align: center; backdrop-filter: blur(2px); }
        .selection-checkbox { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; margin-right: 10px; display: none; flex-shrink: 0; }
        .selection-checkbox.checked { background: #007aff; border-color: #007aff; }
        .selection-mode .selection-checkbox { display: block; }
        .selection-mode .message-row { pointer-events: none; } 
        .selection-mode .message-row { cursor: pointer; pointer-events: auto; }
        .chat-tools-bar { display: flex; justify-content: flex-start; gap: 12px; padding: 12px 15px; background: #f9f9f9; border-top: 1px solid #eee; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; min-height: 60px; align-items: center; }
        .chat-tools-bar::-webkit-scrollbar { display: none; } 
        .tool-btn { background: #fff; border: 1px solid #ddd; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 500; color: #333; cursor: pointer; display: flex; align-items: center; gap: 6px; flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .tool-btn:active { background: #f0f0f0; }
        
        /* --- Ë°®ÊÉÖÂåÖÂäüËÉΩÊ†∑Âºè --- */
        #sticker-panel {
            display: none;
            background: #fff;
            border-top: 1px solid #eee;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            min-height: 200px;
        }
        #sticker-panel.active {
            display: block;
        }
        .sticker-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .sticker-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .sticker-add-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #007aff;
            color: #fff;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .sticker-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #eee;
            position: relative;
            background: #f9f9f9;
        }
        .sticker-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .sticker-item:active {
            transform: scale(0.95);
        }
        .sticker-item .sticker-delete {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 59, 48, 0.9);
            color: #fff;
            font-size: 12px;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .sticker-item:hover .sticker-delete {
            display: flex;
        }
        .sticker-empty {
            grid-column: 1 / -1;
            text-align: center;
            color: #999;
            font-size: 12px;
            padding: 20px;
        }

        /* Ë°®ÊÉÖÂåÖÁÆ°ÁêÜÂºπÁ™ó */
        #sticker-manager-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-height: 80%;
            background: #fff;
            border-radius: 20px;
            z-index: 700;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        #sticker-manager-modal.active {
            display: flex;
        }
        .sticker-manager-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            background: #f9f9f9;
        }
        .sticker-manager-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .sticker-upload-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .sticker-upload-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            background: #fff;
        }
        .sticker-upload-tab.active {
            background: #007aff;
            color: #fff;
            border-color: #007aff;
        }
        .sticker-upload-section {
            display: none;
        }
        .sticker-upload-section.active {
            display: block;
        }
        .sticker-preview-container {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #f9f9f9;
        }
        .sticker-preview-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .sticker-preview-placeholder {
            color: #999;
            font-size: 12px;
        }

        /* Ë°®ÊÉÖÂåÖÊ∂àÊÅØÊ∞îÊ≥° */
        .sticker-bubble {
            padding: 5px !important;
            background: transparent !important;
            border: none !important;
        }
        .sticker-bubble img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 8px;
        }
        #quote-preview-area { display: none; background: #f0f0f0; padding: 8px 15px; border-top: 1px solid #ddd; align-items: center; justify-content: space-between; font-size: 12px; color: #555; }
        .quote-preview-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 85%; border-left: 3px solid #007aff; padding-left: 8px; }
        .quote-close-btn { font-size: 16px; color: #999; cursor: pointer; padding: 5px; }
        .chat-input-area { padding: 10px; background: #fff; border-top: 1px solid #eee; display: flex; align-items: center; gap: 8px; }
        .chat-input { flex-grow: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 14px; color: #000; }
        .icon-btn { width: 36px; height: 36px; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 18px; }
        .trigger-ai-btn { background: #f0f0f0; color: #666; }
        .send-btn { background: #007aff; color: #fff; }
        .typing-indicator { font-size: 12px; color: #888; text-align: center; padding: 5px; display: none; background: #f5f5f5; }
        .ctx-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 499; display: none; }
        .ctx-overlay.active { display: block; }
        #msg-context-menu { position: absolute; bottom: 0; left: 0; width: 100%; background: #fff; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 500; display: none; flex-direction: column; padding: 20px; transform: translateY(100%); transition: transform 0.3s; }
        #msg-context-menu.active { transform: translateY(0); display: flex; }
        .ctx-menu-item { padding: 15px; text-align: center; border-bottom: 1px solid #eee; font-size: 16px; color: #007aff; cursor: pointer; }
        .ctx-menu-item:last-child { border-bottom: none; color: #ff3b30; }
        #delete-mode-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; background: #fff; border-top: 1px solid #eee; display: none; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 300; }
        #delete-mode-bar.active { display: flex; }
        .delete-confirm-btn { color: #ff3b30; font-weight: 600; cursor: pointer; }
        .delete-cancel-btn { color: #007aff; cursor: pointer; }
        #edit-msg-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 600; display: none; flex-direction: column; }
        #edit-msg-modal.active { display: flex; }
        .wb-tabs { display: flex; border-bottom: 1px solid #eee; background: #fff; }
        .wb-tab { flex: 1; text-align: center; padding: 12px; font-size: 14px; font-weight: 600; color: #999; cursor: pointer; }
        .wb-tab.active { color: #000; border-bottom: 2px solid #000; }
        .wb-category { margin-bottom: 15px; }
        .wb-category-header { font-size: 13px; color: #666; background: #f5f5f5; padding: 8px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .wb-entry-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; background: #fff; font-size: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .wb-entry-item:active { background: #fafafa; }
        .wb-create-menu { position: absolute; top: 44px; right: 10px; background: #fff; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 200; display: none; flex-direction: column; width: 150px; overflow: hidden; }
        .wb-create-menu.active { display: flex; }
        .wb-menu-item { padding: 12px; font-size: 14px; border-bottom: 1px solid #eee; cursor: pointer; }
        .wb-menu-item:last-child { border-bottom: none; }
        .wb-menu-item:hover { background: #f5f5f5; }
        #wb-editor-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 600; display: none; flex-direction: column; }
        #wb-editor-modal.active { display: flex; }
        #chat-settings-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 80%; background: #fff; border-radius: 20px; z-index: 600; display: none; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; }
        #chat-settings-modal.active { display: flex; }
        .settings-modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; background: #f9f9f9; }
        .settings-modal-content { padding: 20px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; }
        .settings-section-title { font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 10px; margin-top: 20px; font-weight: 600; }
        .user-avatar-upload { width: 80px; height: 80px; border-radius: 50%; background: #eee; margin: 0 auto 10px; display: block; object-fit: cover; cursor: pointer; border: 2px dashed #ccc; }
        .bind-wb-list { max-height: 200px; min-height: 100px; flex-shrink: 0; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 5px; }
        .bind-wb-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f9f9f9; }
        .bind-wb-item input { margin-right: 10px; width: auto; }
        .bind-wb-item label { font-size: 14px; color: #333; margin: 0; text-transform: none; }
        #app-spy-home { background: #333; padding-top: 88px; align-items: center; flex-direction: column; }
        #app-spy-home .app-header { background: transparent; border: none; color: #fff; position: absolute; top: 0; left: 0; width: 100%; }
        .spy-app-grid { width: 160px; margin: 20px auto 0; display: flex; flex-wrap: wrap; justify-content: center; column-gap: 40px; row-gap: 45px; }
        .spy-app-grid .app-icon { background: #1c1c1e; }
        .spy-app-grid .app-label { color: #fff !important; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .memo-list { padding: 20px; }
        .memo-section-header { font-size: 14px; font-weight: bold; color: #666; margin: 20px 0 10px; display: flex; justify-content: space-between; align-items: center; }
        .memo-item { background: #fff9c4; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-family: "Marker Felt", sans-serif; font-size: 16px; line-height: 1.4; color: #333; position: relative; }
        .memo-item.important { background: #ffccbc; border: 2px solid #ff5722; }
        .memo-date { font-size: 10px; color: #888; margin-bottom: 5px; display: block; }
        .memo-keywords { font-size: 10px; color: #555; margin-top: 8px; font-style: italic; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 5px; }
        .memo-delete { position: absolute; bottom: 5px; right: 10px; font-size: 14px; cursor: pointer; opacity: 0.5; }
        #transfer-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 700; display: none; justify-content: center; align-items: center; }
        #transfer-modal.active { display: flex; }
        .transfer-box { background: #fff; width: 80%; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .transfer-box h3 { margin: 0; text-align: center; }
        .theme-section-title { font-size: 18px; font-weight: bold; color: #000; margin-bottom: 15px; margin-top: 10px; }
        .theme-divider { height: 1px; background: #eee; border: none; margin: 30px 0; }
        .theme-option-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .theme-option-btn { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; text-align: center; font-size: 13px; }
        .theme-option-btn.active { background: #000; color: #fff; border-color: #000; }
        .color-picker-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .color-preview { width: 40px; height: 40px; border-radius: 8px; border: 1px solid #ddd; }
        .theme-note { font-size: 11px; color: #888; margin-top: 5px; line-height: 1.4; }
        .thoughts-modal { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); width: 85%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 550; display: none; flex-direction: column; border: 1px solid rgba(0,0,0,0.05); }
        .thoughts-modal.active { display: flex; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .thoughts-header { font-size: 14px; font-weight: bold; color: #ff2d55; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .thoughts-content { font-size: 14px; line-height: 1.5; color: #333; font-style: italic; }
        .thoughts-close { position: absolute; top: 10px; right: 15px; color: #999; cursor: pointer; font-size: 18px; }
        #call-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 800; display: none; flex-direction: column; align-items: center; padding-top: 80px; }
        #call-screen.active { display: flex; }
        .call-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.2); flex-shrink: 0; }
        .call-status { color: rgba(255,255,255,0.7); font-size: 16px; margin-bottom: 10px; height: 20px; flex-shrink: 0; }
        .call-timer { color: #fff; font-size: 32px; font-weight: 300; margin-bottom: 20px; flex-shrink: 0; }
        .call-controls-container { margin-top: auto; width: 100%; padding-bottom: 50px; display: flex; flex-direction: column; align-items: center; gap: 20px; flex-shrink: 0; background: linear-gradient(to top, #000 20%, transparent); }
        .call-input-container { width: 90%; padding: 10px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 20px; display: flex; align-items: center; gap: 8px; }
        .call-input-container .chat-input { background: rgba(0,0,0,0.3); color: #fff; border: none; }
        .call-input-container .chat-input::placeholder { color: rgba(255,255,255,0.5); }
        .call-input-container .icon-btn { background: rgba(255,255,255,0.2); color: #fff; }
        .call-hangup-btn { width: 70px; height: 70px; border-radius: 50%; background: #ff3b30; color: #fff; display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; transition: transform 0.1s; }
        .call-hangup-btn:active { transform: scale(0.9); }
        #offline-mode { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fdfbf7; background-size: cover; background-position: center; z-index: 750; display: none; flex-direction: column; }
        #offline-mode.active { display: flex; }
        #offline-history { flex-grow: 1; padding: 20px; overflow-y: auto; line-height: 1.8; color: #333; font-size: 16px; }
        .offline-msg-block { margin-bottom: 5px; text-align: justify; }
        .offline-msg-block.user { font-weight: bold; color: #555; border-left: 3px solid #ccc; padding-left: 10px; }
        .offline-msg-block.ai { color: #000; }
        .offline-msg-block.system { font-style: italic; color: #999; font-size: 12px; text-align: center; margin-bottom: 20px; }
        .offline-action-bar { display: flex; gap: 15px; margin-bottom: 20px; padding-left: 5px; opacity: 0.7; }
        .offline-action-btn { font-size: 12px; color: #007aff; cursor: pointer; text-decoration: none; border: none; background: transparent; padding: 0; }
        .offline-action-btn:hover { text-decoration: underline; }
        .offline-action-btn.delete { color: #ff3b30; }
        .offline-input-area { padding: 15px; background: #fff; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .offline-input-area .chat-input { background: #f5f5f5; border: none; }
        #offline-settings-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; background: #fff; border-radius: 15px; z-index: 760; display: none; flex-direction: column; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #offline-settings-modal.active { display: flex; }
        
        /* --- Á∫ø‰∏ãÊ®°Âºè‰∏ìÁî®ÁºñËæëÂºπÁ™ó --- */
        #offline-edit-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 75%; /* Âç†Â±èÂπï 3/4 */
            background: #fff;
            border-radius: 20px;
            z-index: 800;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        #offline-edit-modal.active { display: flex; }
        .offline-edit-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            background: #f9f9f9;
            font-size: 16px;
        }
        .offline-edit-content {
            flex-grow: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        #offline-edit-textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            font-family: inherit;
        }

        /* --- Êñ∞Â¢ûÔºöÊü•Â≤óÊó•ËÆ∞‰∏ìÁî®ÁºñËæëÂºπÁ™ó --- */
        #spy-diary-edit-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 75%;
            background: #fff;
            border-radius: 20px;
            z-index: 800;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        #spy-diary-edit-modal.active { display: flex; }
        #spy-diary-edit-textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            font-family: inherit;
        }

        .chat-timestamp {
            text-align: center;
            color: #fff;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(2px);
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 11px;
            margin: 15px auto 5px;
            width: fit-content;
            align-self: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .retracted-message-bar {
            align-self: center;
            background: rgba(150, 150, 150, 0.3);
            color: #666;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            margin: 5px 0;
            backdrop-filter: blur(2px);
            font-style: italic;
            text-align: center;
            max-width: 80%;
        }

        /* --- ÊµèËßàÂô®‰∏éÊó•ËÆ∞Ê†∑Âºè --- */
        .browser-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            font-size: 15px;
            color: #333;
        }
        .browser-item::before {
            content: 'üîç';
            margin-right: 15px;
            font-size: 16px;
            opacity: 0.6;
        }
        
        .diary-entry {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            line-height: 1.8;
            color: #333;
            position: relative;
        }
        .diary-date {
            font-weight: bold;
            color: #000;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .diary-content mark {
            background-color: #ffeb3b;
            color: #000;
            padding: 0 2px;
            border-radius: 2px;
        }
        .diary-content strike {
            color: #999;
            text-decoration: line-through;
        }
        .diary-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 15px;
            border-top: 1px dashed #eee;
            padding-top: 10px;
        }
        .diary-action-btn {
            font-size: 12px;
            color: #007aff;
            cursor: pointer;
        }
        .diary-separator {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin: 20px 0;
            position: relative;
        }
        .diary-separator::before, .diary-separator::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 1px;
            background: #ddd;
            vertical-align: middle;
            margin: 0 10px;
        }

        /* --- Â§áÂøòÂΩïËÆæÁΩÆÂºπÁ™óÊ†∑Âºè --- */
        #memo-settings-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-height: 85%;
            background: #fff;
            border-radius: 20px;
            z-index: 600;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        #memo-settings-modal.active { display: flex; }
        #memo-settings-modal .settings-modal-content {
            overflow-y: auto;
        }

        /* ÊØèÊó•ÊÄªÁªìÊ†∑Âºè */
        .memo-item.daily-summary {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
        }
        .memo-item.daily-summary .memo-date {
            color: #2e7d32;
            font-weight: bold;
        }

        /* --- Ë°®ÊÉÖÂåÖÂäüËÉΩÊ†∑Âºè --- */
        #sticker-panel {
            display: none;
            background: #fff;
            border-top: 1px solid #eee;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        #sticker-panel.active {
            display: block;
        }
        .sticker-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .sticker-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .sticker-add-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #007aff;
            color: #fff;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .sticker-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #eee;
            position: relative;
            background: #f9f9f9;
        }
        .sticker-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .sticker-item:active {
            transform: scale(0.95);
        }
        .sticker-item .sticker-delete {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 59, 48, 0.9);
            color: #fff;
            font-size: 12px;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .sticker-item:hover .sticker-delete {
            display: flex;
        }
        .sticker-empty {
            grid-column: 1 / -1;
            text-align: center;
            color: #999;
            font-size: 12px;
            padding: 20px;
        }

        /* Ë°®ÊÉÖÂåÖÁÆ°ÁêÜÂºπÁ™ó */
        #sticker-manager-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-height: 80%;
            background: #fff;
            border-radius: 20px;
            z-index: 700;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        #sticker-manager-modal.active {
            display: flex;
        }
        .sticker-manager-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            background: #f9f9f9;
        }
        .sticker-manager-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .sticker-upload-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .sticker-upload-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            background: #fff;
        }
        .sticker-upload-tab.active {
            background: #007aff;
            color: #fff;
            border-color: #007aff;
        }
        .sticker-upload-section {
            display: none;
        }
        .sticker-upload-section.active {
            display: block;
        }
        .sticker-preview-container {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #f9f9f9;
        }
        .sticker-preview-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .sticker-preview-placeholder {
            color: #999;
            font-size: 12px;
        }

        /* Ë°®ÊÉÖÂåÖÊ∂àÊÅØÊ∞îÊ≥° */
        .sticker-bubble {
            padding: 5px !important;
            background: transparent !important;
            border: none !important;
        }
        .sticker-bubble img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 8px;
        }

    </style>
</head>
<body>
    <div class="phone-case">
        <div class="notch"></div>
        <div class="status-bar">
            <span id="clock-time">12:00</span>
            <span>100%</span>
        </div>

        <!-- 1. ÈîÅÂ±è -->
        <div id="lock-screen" class="screen active">
            <div class="clock" id="lock-clock">12:00</div>
            <div class="date" id="lock-date">1Êúà1Êó• ÊòüÊúü‰∏Ä</div>
            <div class="slider-container">
                <div class="slider-text">ÊªëÂä®Êù•Ëß£ÈîÅ</div>
                <input type="range" min="0" max="100" value="0" id="unlock-slider">
            </div>
        </div>

        <!-- 2. ‰∏ªÂ±èÂπï -->
        <div id="home-screen" class="screen">
            <div class="home-header">
                <div class="home-time-big" id="home-time-big">12:00</div>
                <div class="home-date-big" id="home-date-big">1Êúà1Êó• ÊòüÊúü‰∏Ä</div>
            </div>

            <div class="home-widget-container">
                <div class="home-widget" id="home-widget" onclick="triggerWidgetUpload()">
                    <span>ÁÇπÂáª‰∏ä‰º†ÂõæÁâá</span>
                    <img id="home-widget-img" src="">
                </div>
                <input type="file" id="widget-file-input" style="display:none" accept="image/*" onchange="uploadWidgetImage(this)">
            </div>

            <!-- APP ÂõæÊ†áÁΩëÊ†º -->
            <div class="app-grid">
                <div class="app-icon" id="icon-app-vk" onclick="openApp('app-vk')">VK<div class="app-label">Vkontakte</div></div>
                <div class="app-icon" id="icon-app-contacts" onclick="openApp('app-contacts')">üë§<div class="app-label">ÈÄöËÆØÂΩï</div></div>
                <div class="app-icon" id="icon-app-memos" onclick="openApp('app-memos')" style="background-color:#f1c40f; color:#000;">üìù<div class="app-label">Â§áÂøòÂΩï</div></div>
                <div class="app-icon" id="icon-app-calendar" onclick="openApp('app-calendar')" style="background-color:#fff; color:#ff3b30;">üìÖ<div class="app-label">Êó•ÂéÜ</div></div>
                <div class="app-icon" id="icon-app-worldbook" onclick="openApp('app-worldbook')">üìñ<div class="app-label">‰∏ñÁïå‰π¶</div></div>
                <div class="app-icon" id="icon-app-spy-list" onclick="openApp('app-spy-list')">üëÅÔ∏è<div class="app-label">Êü•Â≤ó</div></div>
                <div class="app-icon" id="icon-app-theme" onclick="openApp('app-theme')">üé®<div class="app-label">ÁæéÂåñ</div></div>
                <div class="app-icon" id="icon-app-settings" onclick="openApp('app-settings')">‚öôÔ∏è<div class="app-label">ËÆæÁΩÆ</div></div>
            </div>
        </div>

        <!-- 3. ËÆæÁΩÆ App -->
        <div id="app-settings" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Done</div>
                <div class="app-title">ËÆæÁΩÆ</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content">
                <div class="toggle-switch">
                    <span class="toggle-label">Êó†ËæπÊ°ÜÂÖ®Â±èÊ®°Âºè</span>
                    <label class="switch"><input type="checkbox" id="fullscreen-toggle" onchange="toggleFullscreen()"><span class="slider"></span></label>
                </div>
                <div class="form-group"><label>API Base URL</label><input type="text" id="api-url" placeholder="https://api.openai.com/v1"></div>
                <div class="form-group"><label>API Key</label><input type="password" id="api-key" placeholder="sk-..."></div>
                
                <div class="form-group">
                    <label>Model Name</label>
                    <div class="input-group-row">
                        <input type="text" id="model-name" placeholder="gpt-3.5-turbo" style="flex:1;">
                        <button class="fetch-btn" onclick="fetchModels(this)">ÊãâÂèñÊ®°Âûã</button>
                    </div>
                    <select id="model-select" style="display:none; margin-top:10px; width:100%;" onchange="selectModel(this)"></select>
                </div>

                <!-- System Prompt Â∑≤ÈöêËóè -->
                <input type="hidden" id="system-prompt">

                <button class="save-btn" onclick="saveSettings()">‰øùÂ≠òËÆæÁΩÆ</button>

                <div class="settings-section-title" style="margin-top:30px;">Â§á‰ªΩ‰∏éÊÅ¢Â§ç</div>
                <div style="display:flex; gap:10px;">
                    <button class="save-btn" style="background:#333;" onclick="exportBackup()">ÂØºÂá∫Â§á‰ªΩ (JSON)</button>
                    <button class="save-btn" style="background:#007aff;" onclick="document.getElementById('import-file').click()">ÂØºÂÖ•Â§á‰ªΩ</button>
                    <input type="file" id="import-file" style="display:none" onchange="importBackup(this)" accept=".json,application/json,text/plain,*/*">
                </div>
                <div style="font-size:11px; color:#888; margin-top:5px;">ÂØºÂÖ•Â§á‰ªΩÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºåËØ∑Ë∞®ÊÖéÊìç‰Ωú„ÄÇ</div>
            </div>
        </div>

        <!-- 4. ÈÄöËÆØÂΩï App -->
        <div id="app-contacts" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">ÈÄöËÆØÂΩï</div>
                <div class="action-btn" onclick="openContactForm()">+</div>
            </div>
            <div class="app-content">
                <div id="add-contact-area" class="add-contact-form">
                    <h3 id="contact-form-title" style="margin-top:0">Ê∑ªÂä†ËÅîÁ≥ª‰∫∫</h3>
                    <input type="hidden" id="contact-id-hidden">
                    <div class="form-group">
                        <label>Â§¥ÂÉè (Êñá‰ª∂ Êàñ URL)</label>
                        <input type="file" id="contact-avatar-input" accept="image/*">
                        <input type="text" id="contact-avatar-url" placeholder="ÊàñËÄÖËæìÂÖ•ÂõæÁâáURL" style="margin-top:5px;">
                    </div>
                    <div class="form-group"><label>ÂßìÂêç</label><input type="text" id="contact-name-input"></div>
                    <div class="form-group"><label>‰∫∫ËÆæ (Prompt)</label><textarea id="contact-persona-input"></textarea></div>
                    <button class="save-btn" onclick="saveContact()">‰øùÂ≠ò</button>
                    <button class="save-btn" onclick="closeContactForm()" style="background:#eee; color:#333; margin-top:10px;">ÂèñÊ∂à</button>
                </div>
                <div id="contacts-list"></div>
            </div>
        </div>

        <!-- 5. ‰∏ñÁïå‰π¶ App -->
        <div id="app-worldbook" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">‰∏ñÁïå‰π¶</div>
                <div class="action-btn" onclick="toggleWBCreateMenu()">+</div>
            </div>
            <div class="wb-create-menu" id="wb-create-menu">
                <div class="wb-menu-item" onclick="openWBEditor()">Êñ∞Âª∫‰∏ñÁïå‰π¶</div>
                <div class="wb-menu-item" onclick="createWBCategory()">Êñ∞Âª∫ÂàÜÁ±ª</div>
            </div>
            <div class="wb-tabs">
                <div class="wb-tab active" onclick="switchWBTab('global')" id="wb-tab-global">ÂÖ®Â±Ä‰∏ñÁïå‰π¶</div>
                <div class="wb-tab" onclick="switchWBTab('local')" id="wb-tab-local">Â±ÄÈÉ®‰∏ñÁïå‰π¶</div>
            </div>
            <div class="app-content" id="wb-content-list"></div>
            
            <div id="wb-editor-modal">
                <div class="app-header">
                    <div class="back-btn" onclick="closeWBEditor()">ÂèñÊ∂à</div>
                    <div class="app-title">ÁºñËæë‰∏ñÁïå‰π¶</div>
                    <div class="action-btn" onclick="saveWBEntry()">‰øùÂ≠ò</div>
                </div>
                <div class="app-content">
                    <input type="hidden" id="wb-edit-id">
                    <div class="form-group"><label>Ê†áÈ¢ò</label><input type="text" id="wb-edit-title"></div>
                    <div class="form-group"><label>Á±ªÂûã</label><select id="wb-edit-type"><option value="global">ÂÖ®Â±Ä (Global)</option><option value="local">Â±ÄÈÉ® (Local)</option></select></div>
                    <div class="form-group"><label>ÂàÜÁ±ª</label><select id="wb-edit-category"></select></div>
                    <div class="form-group"><label>Ê≠£ÊñáÂÜÖÂÆπ</label><textarea id="wb-edit-content" style="height: 300px;"></textarea></div>
                </div>
            </div>
        </div>

        <!-- 6. Êü•Â≤ó (Spy) App - ËßíËâ≤ÂàóË°® -->
        <div id="app-spy-list" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">Êü•Â≤ó</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content" id="spy-contact-list"></div>
        </div>

        <!-- 7. Êü•Â≤ó (Spy) App - ËßíËâ≤Ê®°ÊãüÊâãÊú∫Ê°åÈù¢ -->
        <div id="app-spy-home" class="screen">
            <div class="app-header">
                <div style="width:60px;"></div> 
                <div class="app-title" id="spy-home-title" style="color:#fff; padding:0;">Role Phone</div>
                <div class="action-btn"></div>
            </div>
            <!-- ‰∏ìÁî®ÂõæÊ†áÁΩëÊ†ºÂÆπÂô® -->
            <div class="spy-app-grid">
                <div class="app-icon" id="spy-icon-vk" onclick="openSpyVK()">VK<div class="app-label">Vkontakte</div></div>
                <div class="app-icon" id="spy-icon-memos" onclick="openSpyMemos()" style="background-color:#f1c40f; color:#000;">üìù<div class="app-label">Â§áÂøòÂΩï</div></div>
                <!-- Êñ∞Â¢ûÔºöÊµèËßàÂô®ÂíåÊó•ËÆ∞ÂõæÊ†á -->
                <div class="app-icon" id="spy-icon-browser" onclick="openSpyBrowser()" style="background-color:#007aff; color:#fff;">üåê<div class="app-label">ÊµèËßàÂô®</div></div>
                <div class="app-icon" id="spy-icon-diary" onclick="openSpyDiary()" style="background-color:#8e44ad; color:#fff;">üìî<div class="app-label">Êó•ËÆ∞</div></div>
                <!-- Êñ∞Â¢ûÔºöËÆæÁΩÆÂõæÊ†á -->
                <div class="app-icon" id="spy-icon-settings" onclick="openSpySettings()" style="background-color:#8e8e93; color:#fff;">‚öôÔ∏è<div class="app-label">ËÆæÁΩÆ</div></div>
            </div>
        </div>

        <!-- 8. Êü•Â≤ó (Spy) - Ê®°Êãü VK ËÅîÁ≥ª‰∫∫ÂàóË°® -->
        <div id="app-spy-vk" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">Vkontakte</div>
                <div class="action-btn">
                    <span onclick="refreshSpyVK()" style="margin-right:15px; font-size:18px;">üîÑ</span>
                    <span onclick="generateSpyChat()" style="margin-right:15px; font-size:20px;">+</span>
                    <span onclick="clearSpyVK()" style="font-size:20px;">üóëÔ∏è</span>
                </div>
            </div>
            <div class="app-content" id="spy-vk-contacts"></div>
        </div>

        <!-- 9. Êü•Â≤ó (Spy) - Ê®°Êãü VK ËÅäÂ§©ÁïåÈù¢ -->
        <div id="app-spy-vk-chat" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-vk')">Back</div>
                <div class="app-title" id="spy-vk-chat-title">Chat</div>
                <div class="action-btn"></div>
            </div>
            <div class="chat-messages" id="spy-vk-messages"></div>
        </div>

        <!-- 10. Êü•Â≤ó (Spy) - Ê®°ÊãüÂ§áÂøòÂΩï -->
        <div id="app-spy-memos" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">Â§áÂøòÂΩï</div>
                <div class="action-btn">
                    <span onclick="refreshSpyMemos()" style="margin-right:15px; font-size:18px;">üîÑ</span>
                    <span onclick="generateSpyMemos()" style="margin-right:15px; font-size:20px;">+</span>
                    <span onclick="clearSpyMemos()" style="font-size:20px;">üóëÔ∏è</span>
                </div>
            </div>
            <div class="app-content memo-list" id="spy-memo-list"></div>
        </div>

        <!-- Êñ∞Â¢ûÔºöÊü•Â≤ó (Spy) - Ê®°ÊãüÊµèËßàÂô® -->
        <div id="app-spy-browser" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">ÊµèËßàÂô®</div>
                <div class="action-btn">
                    <span onclick="refreshSpyBrowser()" style="margin-right:15px; font-size:18px;">üîÑ</span>
                    <span onclick="generateSpyBrowser()" style="margin-right:15px; font-size:20px;">+</span>
                    <span onclick="clearSpyBrowser()" style="font-size:20px;">üóëÔ∏è</span>
                </div>
            </div>
            <div class="app-content" id="spy-browser-list"></div>
        </div>

        <!-- Êñ∞Â¢ûÔºöÊü•Â≤ó (Spy) - ËßíËâ≤ÊâãÊú∫ËÆæÁΩÆ -->
        <div id="app-spy-settings" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">ËÆæÁΩÆ</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content">
                <div class="theme-section-title">Â£ÅÁ∫∏ËÆæÁΩÆ</div>
                
                <div class="form-group">
                    <label>Â£ÅÁ∫∏Á±ªÂûã</label>
                    <div class="theme-option-row">
                        <div class="theme-option-btn active" id="spy-theme-type-color" onclick="switchSpyThemeType('color')">Á∫ØËâ≤</div>
                        <div class="theme-option-btn" id="spy-theme-type-image" onclick="switchSpyThemeType('image')">ÂõæÁâá</div>
                    </div>
                    
                    <div id="spy-theme-input-color">
                        <div class="color-picker-wrapper">
                            <input type="color" id="spy-theme-wallpaper-color" value="#333333" style="width:50px; height:40px; padding:0; border:none;">
                            <span>ÈÄâÊã©È¢úËâ≤</span>
                        </div>
                    </div>

                    <div id="spy-theme-input-image" style="display:none;">
                        <input type="file" id="spy-theme-wallpaper-image" accept="image/*">
                        <input type="text" id="spy-theme-wallpaper-url" placeholder="ÊàñËÄÖËæìÂÖ•ÂõæÁâáURL" style="margin-top:5px;">
                        <div style="font-size:11px; color:#888; margin-top:5px;">‰∏ä‰º†ÂõæÁâáÊàñËæìÂÖ•URL‰Ωú‰∏∫Â£ÅÁ∫∏</div>
                    </div>
                </div>

                <button class="save-btn" onclick="saveSpyWallpaper()">‰øùÂ≠òÂ£ÅÁ∫∏ËÆæÁΩÆ</button>

                <hr class="theme-divider">

                <div class="theme-section-title">Ê°åÈù¢ÂõæÊ†áËÆæÁΩÆ</div>

                <div class="form-group">
                    <label>ÈÄâÊã©Â∫îÁî®</label>
                    <select id="spy-theme-app-select" style="margin-bottom:10px;">
                        <option value="spy-icon-vk">Vkontakte</option>
                        <option value="spy-icon-memos">Â§áÂøòÂΩï</option>
                        <option value="spy-icon-browser">ÊµèËßàÂô®</option>
                        <option value="spy-icon-diary">Êó•ËÆ∞</option>
                        <option value="spy-icon-settings">ËÆæÁΩÆ</option>
                    </select>
                    
                    <label style="margin-top:10px">ÂõæÊ†áÂõæÁâá</label>
                    <input type="file" id="spy-theme-icon-file" accept="image/*">
                    <input type="text" id="spy-theme-icon-url" placeholder="ÊàñËÄÖËæìÂÖ•ÂõæÁâáURL" style="margin-top:5px;">
                    
                    <button class="save-btn" style="margin-top:15px; background:#007aff;" onclick="saveSpyAppIcon()">‰øùÂ≠òÂõæÊ†á</button>
                </div>

                <hr class="theme-divider">

                <!-- ‰∏ÄÈîÆÊ∏ÖÁ©∫ËßíËâ≤ÊâãÊú∫ÁæéÂåñ -->
                <button class="save-btn" style="background:#ff3b30; margin-bottom:30px;" onclick="resetSpyTheme()">‚ö†Ô∏è ÈáçÁΩÆËßíËâ≤ÊâãÊú∫ÁæéÂåñ</button>
            </div>
        </div>

        <!-- Êñ∞Â¢ûÔºöÊü•Â≤ó (Spy) - Ê®°ÊãüÊó•ËÆ∞ -->
        <div id="app-spy-diary" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-spy-home')">Back</div>
                <div class="app-title">Êó•ËÆ∞</div>
                <div class="action-btn">
                    <span onclick="refreshSpyDiary()" style="margin-right:15px; font-size:18px;">üîÑ</span>
                    <span onclick="generateSpyDiary()" id="spy-diary-add-btn" style="margin-right:15px; font-size:20px;">+</span>
                    <span onclick="clearSpyDiaries()" style="font-size:20px;">üóëÔ∏è</span>
                </div>
            </div>
            <div class="app-content" id="spy-diary-list" style="background:#f9f9f9;"></div>
            
            <!-- Êü•Â≤óÊó•ËÆ∞‰∏ìÁî®ÁºñËæëÂºπÁ™ó -->
            <div id="spy-diary-edit-modal">
                <div class="offline-edit-header">
                    <span style="color:#ff3b30; cursor:pointer;" onclick="closeSpyDiaryEdit()">ÂèñÊ∂à</span>
                    <span>ÁºñËæëÊó•ËÆ∞</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="saveSpyDiaryEdit()">ÂÆåÊàê</span>
                </div>
                <div class="offline-edit-content">
                    <textarea id="spy-diary-edit-textarea"></textarea>
                </div>
            </div>
        </div>

        <!-- 11. ÁæéÂåñ (Theme) App -->
        <div id="app-theme" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">ÁæéÂåñ</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content">
                <div class="theme-section-title">ÂÖ®Â±ÄÁæéÂåñÈ¢ÑËÆæ</div>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="save-btn" style="background:#333;" onclick="exportThemePreset()">ÂØºÂá∫È¢ÑËÆæ (JSON)</button>
                    <button class="save-btn" style="background:#007aff;" onclick="document.getElementById('import-theme-file').click()">ÂØºÂÖ•È¢ÑËÆæ</button>
                    <input type="file" id="import-theme-file" style="display:none" onchange="importThemePreset(this)" accept=".json,application/json,text/plain,*/*">
                </div>
                <div style="font-size:11px; color:#888; margin-top:-15px; margin-bottom:20px;">ÂåÖÂê´ÔºöÂ£ÅÁ∫∏„ÄÅËæπÊ°Ü„ÄÅÂõæÊ†á„ÄÅËÅäÂ§©ËÉåÊôØ/Ê∞îÊ≥°„ÄÅÁ∫ø‰∏ãÊ®°ÂºèËÉåÊôØ„ÄÇ</div>

                <hr class="theme-divider">

                <div class="theme-section-title">Â£ÅÁ∫∏ÈÄâÊã©</div>
                
                <div class="form-group">
                    <label>Â£ÅÁ∫∏Á±ªÂûã</label>
                    <div class="theme-option-row">
                        <div class="theme-option-btn active" id="theme-type-color" onclick="switchThemeType('color')">Á∫ØËâ≤</div>
                        <div class="theme-option-btn" id="theme-type-image" onclick="switchThemeType('image')">ÂõæÁâá</div>
                    </div>
                    
                    <div id="theme-input-color">
                        <div class="color-picker-wrapper">
                            <input type="color" id="theme-wallpaper-color" value="#ffffff" style="width:50px; height:40px; padding:0; border:none;">
                            <span>ÈÄâÊã©È¢úËâ≤</span>
                        </div>
                    </div>

                    <div id="theme-input-image" style="display:none;">
                        <input type="file" id="theme-wallpaper-image" accept="image/*">
                        <input type="text" id="theme-wallpaper-url" placeholder="ÊàñËÄÖËæìÂÖ•ÂõæÁâáURL" style="margin-top:5px;">
                        <div style="font-size:11px; color:#888; margin-top:5px;">‰∏ä‰º†ÂõæÁâáÊàñËæìÂÖ•URL‰Ωú‰∏∫Â£ÅÁ∫∏</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ÊâãÊú∫ËæπÊ°ÜÈ¢úËâ≤</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="theme-case-color" value="#1a1a1a" style="width:50px; height:40px; padding:0; border:none;">
                        <span>ÈÄâÊã©ËæπÊ°ÜÈ¢úËâ≤</span>
                    </div>
                    <div class="theme-note">ËØ∑ÂÖ≥Èó≠ËÆæÁΩÆ‰∏≠ÁöÑ"Êó†ËæπÊ°ÜÂÖ®Â±èÊ®°Âºè"Êù•‰ΩøÁî®Ê≠§ÂäüËÉΩ</div>
                </div>

                <button class="save-btn" onclick="saveTheme()">Â∫îÁî®Âπ∂‰øùÂ≠òÂ£ÅÁ∫∏ËÆæÁΩÆ</button>

                <hr class="theme-divider">

                <div class="theme-section-title">Ê°åÈù¢ÂõæÊ†áËÆæÁΩÆ</div>

                <div class="form-group">
                    <label>ÈÄâÊã©Â∫îÁî®</label>
                    <select id="theme-app-select" style="margin-bottom:10px;">
                        <option value="icon-app-vk">Vkontakte</option>
                        <option value="icon-app-contacts">ÈÄöËÆØÂΩï</option>
                        <option value="icon-app-memos">Â§áÂøòÂΩï</option>
                        <option value="icon-app-calendar">Êó•ÂéÜ</option>
                        <option value="icon-app-worldbook">‰∏ñÁïå‰π¶</option>
                        <option value="icon-app-spy-list">Êü•Â≤ó</option>
                        <option value="icon-app-theme">ÁæéÂåñ</option>
                        <option value="icon-app-settings">ËÆæÁΩÆ</option>
                    </select>
                    
                    <label style="margin-top:10px">ÂõæÊ†áÂõæÁâá</label>
                    <input type="file" id="theme-icon-file" accept="image/*">
                    <input type="text" id="theme-icon-url" placeholder="ÊàñËÄÖËæìÂÖ•ÂõæÁâáURL" style="margin-top:5px;">
                    
                    <button class="save-btn" style="margin-top:15px; background:#007aff;" onclick="saveAppIcon()">‰øùÂ≠òÂõæÊ†á</button>
                </div>

                <hr class="theme-divider">

                <div class="theme-section-title">ÂÖ®Â±ÄÂ≠ó‰ΩìËÆæÁΩÆ</div>
                <div class="form-group">
                    <label>Â≠ó‰ΩìÊñá‰ª∂ URL (WOFF2/TTF)</label>
                    <input type="text" id="theme-font-url" placeholder="https://example.com/font.woff2">
                    <div class="theme-note">Âª∫ËÆÆ‰ΩøÁî® HTTPS ÈìæÊé•„ÄÇËÆæÁΩÆÂêéÂ∞ÜÂ∫îÁî®Âà∞ÂÖ®Â±Ä„ÄÇ</div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="save-btn" style="flex:1;" onclick="saveFont()">Â∫îÁî®Â≠ó‰Ωì</button>
                        <button class="save-btn" style="flex:1; background:#eee; color:#333;" onclick="resetFont()">ÊÅ¢Â§çÈªòËÆ§</button>
                    </div>
                </div>

                <!-- Êñ∞Â¢ûÔºöÂÖ®Â±ÄÂ≠ó‰ΩìÈ¢úËâ≤ËÆæÁΩÆ -->
                <div class="form-group" style="margin-top:20px;">
                    <label>ÂÖ®Â±ÄÂ≠ó‰ΩìÈ¢úËâ≤</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="theme-font-color" value="#000000" style="width:50px; height:40px; padding:0; border:none;">
                        <span>ÈÄâÊã©È¢úËâ≤</span>
                    </div>
                    <button class="save-btn" style="margin-top:10px;" onclick="saveFontColor()">‰øùÂ≠òÂ≠ó‰ΩìÈ¢úËâ≤</button>
                </div>

                <hr class="theme-divider">

                <!-- Êñ∞Â¢ûÔºö‰∏ÄÈîÆÊ∏ÖÁ©∫ÁæéÂåñ -->
                <button class="save-btn" style="background:#ff3b30; margin-bottom:30px;" onclick="resetAllThemes()">‚ö†Ô∏è ‰∏ÄÈîÆÊ∏ÖÁ©∫ÊâÄÊúâÁæéÂåñ</button>
            </div>
        </div>

        <!-- 12. VKontakte App (‰∏ª) -->
        <div id="app-vk" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">Vkontakte</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content" id="vk-chat-list"></div>
        </div>

        <!-- 13. ËÅäÂ§©ÁïåÈù¢ (‰∏ª) -->
        <div id="chat-interface">
            <div class="app-header">
                <div class="back-btn" onclick="closeChat()">Back</div>
                <div style="position:absolute; left:50%; transform:translateX(-50%); display:flex; align-items:center; gap:5px;">
                    <span id="chat-title" style="font-size:18px; font-weight:700;">Chat</span>
                    <span onclick="toggleThoughts()" style="cursor:pointer; font-size:16px; color:#ff2d55;">‚ù§Ô∏è</span>
                </div>
                <div class="action-btn" onclick="openChatSettings()">‚öôÔ∏è</div>
            </div>

            <div id="thoughts-modal" class="thoughts-modal">
                <div class="thoughts-close" onclick="toggleThoughts()">‚úï</div>
                <div class="thoughts-header">‚ù§Ô∏è ËßíËâ≤ÂøÉÂ£∞</div>
                <div class="thoughts-content" id="thoughts-text">ÊöÇÊó†ÂøÉÂ£∞...</div>
            </div>

            <!-- ËØ≠Èü≥ÈÄöËØùÁïåÈù¢ -->
            <div id="call-screen">
                <img id="call-avatar" class="call-avatar" src="">
                <div id="call-status" class="call-status">Ê≠£Âú®ËøûÊé•...</div>
                <div id="call-timer" class="call-timer">00:00</div>
                
                <!-- ÈÄöËØùÁïåÈù¢ÁöÑÊ∂àÊÅØÂàóË°®ÂÆπÂô® -->
                <div id="call-history" class="chat-messages" style="background:transparent; width:100%; flex-grow:1; mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);"></div>

                <div class="call-controls-container">
                    <!-- ÈÄöËØùÁïåÈù¢ÁöÑËæìÂÖ•Ê°Ü -->
                    <div class="call-input-container">
                        <button class="icon-btn trigger-ai-btn" onclick="triggerAIResponse()">‚ú®</button>
                        <input type="text" class="chat-input" id="call-message-input" placeholder="ÈÄöËØù‰∏≠..." onkeydown="handleEnterKey(event)">
                        <button class="icon-btn send-btn" onclick="sendMessage()">‚û§</button>
                    </div>
                    
                    <div class="call-hangup-btn" onclick="endCall()">üìû</div>
                </div>
            </div>

            <!-- Á∫ø‰∏ãÊ®°ÂºèÁïåÈù¢ -->
            <div id="offline-mode">
                <div class="app-header" style="background: rgba(255,255,255,0.8); border-bottom: 1px solid #e0e0e0; backdrop-filter: blur(10px);">
                    <div class="back-btn" onclick="exitOfflineMode()">ÈÄÄÂá∫</div>
                    <div class="app-title">Á∫ø‰∏ãËßÅÈù¢</div>
                    <div class="action-btn" onclick="openOfflineSettings()">‚öôÔ∏è</div>
                </div>
                <div id="offline-history"></div>
                
                <!-- Á∫ø‰∏ãÊ®°ÂºèÁä∂ÊÄÅÊèêÁ§∫ -->
                <div id="offline-typing-indicator" class="typing-indicator" style="background: transparent; color: #888; margin-bottom: 5px;">ÂØπÊñπÊ≠£Âú®Ë°åÂä®‰∏≠...</div>
                
                <div class="offline-input-area">
                    <input type="text" class="chat-input" id="offline-message-input" placeholder="ÊèèËø∞‰Ω†ÁöÑÂä®‰ΩúÊàñËØ≠Ë®Ä..." onkeydown="handleEnterKey(event)">
                    <button class="icon-btn send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>

            <div class="chat-messages" id="chat-history"></div>
            <div class="typing-indicator" id="typing-indicator">ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...</div>
            
            <!-- Ë°®ÊÉÖÂåÖÈù¢Êùø -->
            <div id="sticker-panel">
                <div class="sticker-panel-header">
                    <div class="sticker-panel-title">Ë°®ÊÉÖÂåÖ</div>
                    <button class="sticker-add-btn" onclick="openStickerManager()">+</button>
                </div>
                <div class="sticker-grid" id="sticker-grid"></div>
            </div>

            <div class="chat-tools-bar">
                <button class="tool-btn" onclick="toggleStickerPanel()">üòä Ë°®ÊÉÖÂåÖ</button>
                <button class="tool-btn" onclick="regenerateLastResponse()">üîÑ Âà∑Êñ∞</button>
                <button class="tool-btn" onclick="continueChat()">‚è© ÁªßÁª≠</button>
                <button class="tool-btn" onclick="openTransferModal()">üí∞ ËΩ¨Ë¥¶</button>
                <button class="tool-btn" onclick="startCall()">üìû ÈÄöËØù</button>
                <button class="tool-btn" onclick="openOfflineMode()">üì¥ Á∫ø‰∏ãÊ®°Âºè</button>
            </div>

            <div id="quote-preview-area">
                <div class="quote-preview-text" id="quote-preview-content">ÂºïÁî®ÂÜÖÂÆπ...</div>
                <div class="quote-close-btn" onclick="cancelQuote()">‚úï</div>
            </div>

            <div class="chat-input-area">
                <button class="icon-btn trigger-ai-btn" onclick="triggerAIResponse()">‚ú®</button>
                <input type="text" class="chat-input" id="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." onkeydown="handleEnterKey(event)">
                <button class="icon-btn send-btn" onclick="sendMessage()">‚û§</button>
            </div>

            <div class="ctx-overlay" id="ctx-overlay" onclick="closeAllOverlays()"></div>

            <div id="msg-context-menu">
                <div class="ctx-menu-item" onclick="triggerQuote()">ÂºïÁî®</div>
                <div class="ctx-menu-item" onclick="triggerEdit()">ÁºñËæë</div>
                <div class="ctx-menu-item" id="ctx-retract-btn" onclick="triggerRetract()">Êí§Âõû</div>
                <div class="ctx-menu-item" onclick="triggerDeleteMode()">Âà†Èô§</div>
                <div class="ctx-menu-item" style="color:#333" onclick="closeContextMenu()">ÂèñÊ∂à</div>
            </div>

            <div id="delete-mode-bar">
                <div class="delete-cancel-btn" onclick="exitDeleteMode()">ÂèñÊ∂à</div>
                <div class="delete-confirm-btn" onclick="confirmDeleteMessages()">Âà†Èô§ÈÄâ‰∏≠</div>
            </div>

            <div id="edit-msg-modal">
                <div class="app-header">
                    <div class="back-btn" onclick="closeEditModal()">ÂèñÊ∂à</div>
                    <div class="app-title">ÁºñËæëÊ∂àÊÅØ</div>
                    <div class="action-btn" onclick="saveEditedMessage()">‰øùÂ≠ò</div>
                </div>
                <div class="app-content">
                    <div class="form-group">
                        <textarea id="edit-msg-textarea" style="height: 300px;"></textarea>
                    </div>
                </div>
            </div>

            <div id="transfer-modal">
                <div class="transfer-box">
                    <h3>ËΩ¨Ë¥¶</h3>
                    <div class="form-group">
                        <label>ÈáëÈ¢ù</label>
                        <input type="number" id="transfer-amount" placeholder="ËæìÂÖ•ÈáëÈ¢ù">
                    </div>
                    <div class="form-group">
                        <label>Â§áÊ≥®</label>
                        <input type="text" id="transfer-note" placeholder="ËΩ¨Ë¥¶Â§áÊ≥®">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="save-btn" style="background:#eee; color:#333;" onclick="closeTransferModal()">ÂèñÊ∂à</button>
                        <button class="save-btn" onclick="sendTransfer()">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
                    </div>
                </div>
            </div>

            <!-- Ë°®ÊÉÖÂåÖÁÆ°ÁêÜÂºπÁ™ó -->
            <div id="sticker-manager-modal">
                <div class="sticker-manager-header">
                    <span>Ë°®ÊÉÖÂåÖÁÆ°ÁêÜ</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="closeStickerManager()">ÂÆåÊàê</span>
                </div>
                <div class="sticker-manager-content">
                    <div class="sticker-upload-tabs">
                        <div class="sticker-upload-tab active" onclick="switchStickerUploadTab('single')">ÂçïÁã¨‰∏ä‰º†</div>
                        <div class="sticker-upload-tab" onclick="switchStickerUploadTab('batch')">ÊâπÈáè‰∏ä‰º†</div>
                    </div>

                    <!-- ÂçïÁã¨‰∏ä‰º† -->
                    <div id="sticker-upload-single" class="sticker-upload-section active">
                        <div class="sticker-preview-container" id="sticker-preview-single">
                            <span class="sticker-preview-placeholder">È¢ÑËßà</span>
                        </div>
                        <div class="form-group">
                            <label>‰∏ä‰º†ÊñπÂºè</label>
                            <input type="file" id="sticker-file-input" accept="image/*" onchange="previewSingleSticker(this)">
                            <input type="text" id="sticker-url-input" placeholder="ÊàñËæìÂÖ•ÂõæÁâáURL" style="margin-top:5px;" oninput="previewSingleStickerUrl(this.value)">
                        </div>
                        <div class="form-group">
                            <label>Ë°®ÊÉÖÂåÖÊèèËø∞ÔºàAIÂ∞ÜËØªÂèñÊ≠§ÊñáÂ≠óÔºâ</label>
                            <input type="text" id="sticker-desc-input" placeholder="‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÂ§ßÁ¨ë„ÄÅÂì≠Ê≥£Á≠â">
                        </div>
                        <button class="save-btn" onclick="saveSingleSticker()">‰øùÂ≠òË°®ÊÉÖÂåÖ</button>
                    </div>

                    <!-- ÊâπÈáè‰∏ä‰º† -->
                    <div id="sticker-upload-batch" class="sticker-upload-section">
                        <div class="form-group">
                            <label>ÊâπÈáè‰∏ä‰º†Ê†ºÂºè</label>
                            <textarea id="sticker-batch-input" placeholder="ÊØèË°å‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÔºåÊ†ºÂºèÔºöÊèèËø∞ÔºöÂõæÁâáURL&#10;‰æãÂ¶ÇÔºö&#10;ÂºÄÂøÉÔºöhttps://example.com/happy.png&#10;ÈöæËøáÔºöhttps://example.com/sad.png" style="height:200px;"></textarea>
                            <div style="font-size:11px; color:#888; margin-top:5px;">
                                Ê†ºÂºèËØ¥ÊòéÔºöÊØèË°å‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÔºå‰ΩøÁî®‰∏≠ÊñáÂÜíÂè∑ÂàÜÈöîÊèèËø∞ÂíåURL<br>
                                Á§∫‰æãÔºöÂºÄÂøÉÔºöhttps://example.com/happy.png
                            </div>
                        </div>
                        <button class="save-btn" onclick="saveBatchStickers()">ÊâπÈáè‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>

            <div id="chat-settings-modal">
                <div class="settings-modal-header">
                    <span>ËÅäÂ§©ËÆæÁΩÆ</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="closeChatSettings()">ÂÆåÊàê</span>
                </div>
                <div class="settings-modal-content">
                    <div class="settings-section-title" style="margin-top:0">ÂΩìÂâçÂØπËØùÁöÑÁî®Êà∑ËÆæÂÆö</div>
                    <div style="text-align:center;">
                        <img id="user-setting-avatar-preview" class="user-avatar-upload" src="" onclick="document.getElementById('user-setting-avatar-input').click()">
                        <input type="file" id="user-setting-avatar-input" style="display:none;" accept="image/*" onchange="previewUserAvatar(this)">
                        <input type="text" id="user-setting-avatar-url" placeholder="ÊàñËÄÖËæìÂÖ•ÂõæÁâáURL" style="margin-top:5px; width:80%; font-size:12px; padding:5px;">
                        <div style="font-size:12px; color:#999; margin-bottom:10px;">ÁÇπÂáªÂ§¥ÂÉè‰∏ä‰º†ÊàñËæìÂÖ•URL</div>
                    </div>
                    <div class="form-group"><label>Áî®Êà∑ÂêçÁß∞</label><input type="text" id="user-setting-name" placeholder="‰æãÂ¶ÇÔºöÊóÖË°åËÄÖ"></div>
                    <div class="form-group"><label>Áî®Êà∑‰∫∫ËÆæ</label><textarea id="user-setting-persona" placeholder="‰æãÂ¶ÇÔºö‰Ω†ÊòØ‰∏Ä‰∏™Ë∑ØËøáÁöÑÂÜíÈô©ÂÆ∂..." style="height:80px;"></textarea></div>

                    <div class="toggle-switch" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                        <span class="toggle-label" style="font-size:14px; font-weight:bold;">ÂºÄÂêØ AI Êó∂Èó¥ÊÑüÁü•</span>
                        <label class="switch"><input type="checkbox" id="time-perception-toggle"><span class="slider"></span></label>
                    </div>
                    <div style="font-size:11px; color:#888; margin-bottom:20px;">ÂºÄÂêØÂêéÔºåAI Â∞ÜÁü•ÈÅìÂΩìÂâçÁé∞ÂÆûÊó∂Èó¥ÔºåÂπ∂Ê†πÊçÆ‰ΩúÊÅØÂíåÂõûÂ§çÈó¥ÈöîÂÅöÂá∫ÂèçÂ∫î„ÄÇ</div>

                    <div class="settings-section-title">ËÆ∞ÂøÜ‰∏é‰∏ä‰∏ãÊñá</div>
                    <div class="toggle-switch">
                        <span class="toggle-label" style="font-size:14px; font-weight:bold;">Ëá™Âä®ËÆ∞ÂøÜÊÄªÁªì</span>
                        <label class="switch"><input type="checkbox" id="auto-summary-toggle"><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>ÊÄªÁªìÈ¢ëÁéá (ËΩÆ)</label>
                        <input type="number" id="summary-interval-input" placeholder="ÈªòËÆ§20" value="20">
                    </div>
                    <div class="form-group">
                        <label>‰∏ä‰∏ãÊñáËÆ∞ÂøÜÊï∞Èáè (Êù°)</label>
                        <input type="number" id="context-limit-input" placeholder="ÈªòËÆ§100" value="100">
                    </div>

                    <div class="settings-section-title">ÁªëÂÆöÂ±ÄÈÉ®‰∏ñÁïå‰π¶</div>
                    <div class="bind-wb-list" id="bind-wb-list"></div>
                    <div style="font-size:11px; color:#999; margin-top:5px;">ÂãæÈÄâÂêéÔºåËØ•Êù°ÁõÆÂ∞Ü‰ªÖÂØπÂΩìÂâçËßíËâ≤ÁîüÊïà„ÄÇ</div>

                    <div class="settings-section-title">ËÅäÂ§©ÁïåÈù¢ÁæéÂåñ</div>
                    
                    <div class="form-group">
                        <label>Áî®Êà∑Ê∞îÊ≥° (User)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="theme-user-color" value="#007aff" style="width:50px; height:40px; padding:0; border:none;">
                            <input type="text" id="theme-user-css" placeholder="Ëá™ÂÆö‰πâ CSS (Â¶Ç: border-radius:0)" style="flex:1;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ËßíËâ≤Ê∞îÊ≥° (Character)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="theme-ai-color" value="#ffffff" style="width:50px; height:40px; padding:0; border:none;">
                            <input type="text" id="theme-ai-css" placeholder="Ëá™ÂÆö‰πâ CSS" style="flex:1;">
                        </div>
                    </div>
                    
                    <button class="save-btn" style="background:#333; margin-bottom:20px;" onclick="saveChatBubbleSettings()">‰øùÂ≠òÊ∞îÊ≥°ËÆæÁΩÆ</button>

                    <div class="form-group">
                        <label>ËÅäÂ§©ËÉåÊôØ</label>
                        <div class="theme-option-row">
                            <div class="theme-option-btn active" id="chat-bg-type-color" onclick="switchChatBgType('color')">Á∫ØËâ≤</div>
                            <div class="theme-option-btn" id="chat-bg-type-image" onclick="switchChatBgType('image')">ÂõæÁâá</div>
                        </div>
                        
                        <div id="chat-bg-input-color">
                            <div class="color-picker-wrapper">
                                <input type="color" id="theme-chat-bg-color" value="#f5f5f5" style="width:50px; height:40px; padding:0; border:none;">
                                <span>ÈÄâÊã©ËÉåÊôØÈ¢úËâ≤</span>
                            </div>
                        </div>

                        <div id="chat-bg-input-image" style="display:none;">
                            <input type="file" id="theme-chat-bg-file" accept="image/*">
                            <input type="text" id="theme-chat-bg-url" placeholder="ÊàñËÄÖËæìÂÖ•ÂõæÁâáURL" style="margin-top:5px;">
                        </div>
                    </div>
                    
                    <button class="save-btn" style="background:#333;" onclick="saveChatBgSettings()">‰øùÂ≠òËÅäÂ§©ËÉåÊôØËÆæÁΩÆ</button>

                    <button class="save-btn" style="background:#5856d6; margin-top:20px;" onclick="applyThemeToAllChats()">Â∞ÜÊ∞îÊ≥°ÂíåËÉåÊôØÂ∫îÁî®Âà∞ÂÖ®ÈÉ®ËÅäÂ§©</button>

                    <div style="margin-top: auto; padding-top: 20px;">
                        <button class="save-btn" style="background: #ff3b30;" onclick="clearCurrentHistory()">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                    </div>
                </div>
            </div>
            
            <div id="offline-settings-modal">
                <div class="settings-modal-header">
                    <span>Á∫ø‰∏ãÊ®°ÂºèËÆæÁΩÆ</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="closeOfflineSettings()">ÂÆåÊàê</span>
                </div>
                <div class="settings-modal-content" style="max-height: 70vh; overflow-y: auto;">
                    <div class="form-group">
                        <label>ÊúÄÂ∞èÂ≠óÊï∞</label>
                        <input type="number" id="offline-min-len" placeholder="500">
                    </div>
                    <div class="form-group">
                        <label>ÊúÄÂ§ßÂ≠óÊï∞</label>
                        <input type="number" id="offline-max-len" placeholder="700">
                    </div>
                    <div class="form-group">
                        <label>ÊñáÈ£é/PromptË¶ÅÊ±Ç</label>
                        <textarea id="offline-style-prompt" placeholder="‰æãÂ¶ÇÔºöÁªÜËÖª„ÄÅÊ≤âÊµ∏ÊÑüÂº∫..."></textarea>
                    </div>
                    
                    <div class="settings-section-title" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">Âèô‰∫ãËÆæÁΩÆ</div>
                    
                    <div class="form-group">
                        <label>Â§çËø∞ËÆæÁΩÆ</label>
                        <div class="theme-option-row">
                            <div class="theme-option-btn" id="offline-retell-yes" onclick="setOfflineRetell(true)">Â§çËø∞</div>
                            <div class="theme-option-btn active" id="offline-retell-no" onclick="setOfflineRetell(false)">‰∏çÂ§çËø∞</div>
                        </div>
                        <div style="font-size:11px; color:#888; margin-top:5px;">Â§çËø∞ÔºöÂÖàÊâ©ÂÜôÁî®Êà∑ÁöÑÂõûÂ§çÔºåÂÜçÂ±ïÂºÄÂêéÁª≠ÂâßÊÉÖ<br>‰∏çÂ§çËø∞ÔºöÁõ¥Êé•Â±ïÂºÄÂêéÁª≠ÂâßÊÉÖ</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Êä¢ËØùËÆæÁΩÆ</label>
                        <div class="theme-option-row">
                            <div class="theme-option-btn" id="offline-interrupt-yes" onclick="setOfflineInterrupt(true)">Êä¢ËØù</div>
                            <div class="theme-option-btn active" id="offline-interrupt-no" onclick="setOfflineInterrupt(false)">‰∏çÊä¢ËØù</div>
                        </div>
                        <div style="font-size:11px; color:#888; margin-top:5px;">Êä¢ËØùÔºöAIÂèØ‰∏ªÂä®Áª≠ÂÜôÁî®Êà∑‰∏ã‰∏ÄÊ≠•Ë°åÂä®<br>‰∏çÊä¢ËØùÔºöÁ¶ÅÊ≠¢AI‰ª£ÊõøÁî®Êà∑ÂèëË®ÄÂíåË°åÂä®</div>
                    </div>
                    
                    <div class="settings-section-title" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">‰∫∫Áß∞ËÆæÁΩÆ</div>
                    
                    <div class="form-group">
                        <label>Âèô‰∫ãËßÜËßí</label>
                        <select id="offline-perspective" style="width:100%;">
                            <option value="first_user">Á¨¨‰∏Ä‰∫∫Áß∞ÔºàÁî®Êà∑ËßÜËßíÔºåÁî®"Êàë"Áß∞ÂëºÁî®Êà∑Ôºâ</option>
                            <option value="second">Á¨¨‰∫å‰∫∫Áß∞ÔºàÁî®"‰Ω†"Áß∞ÂëºÁî®Êà∑Ôºâ</option>
                            <option value="third">Á¨¨‰∏â‰∫∫Áß∞ÔºàÁî®Áî®Êà∑ÂêçÁß∞Áß∞ÂëºÁî®Êà∑Ôºâ</option>
                            <option value="first_char">ËßíËâ≤Á¨¨‰∏Ä‰∫∫Áß∞ÔºàËßíËâ≤ËßÜËßíÔºåÁî®"Êàë"Áß∞ÂëºËßíËâ≤ÔºåÁî®"‰Ω†"Áß∞ÂëºÁî®Êà∑Ôºâ</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-top:20px;">
                        <label>ËÉåÊôØÂõæÁâá</label>
                        <input type="file" id="offline-bg-file" accept="image/*">
                        <input type="text" id="offline-bg-url" placeholder="ÊàñËÄÖËæìÂÖ•ÂõæÁâáURL" style="margin-top:5px;">
                    </div>
                    <button class="save-btn" onclick="saveOfflineSettings()">‰øùÂ≠ò</button>
                </div>
            </div>

            <!-- Á∫ø‰∏ãÊ®°Âºè‰∏ìÁî®ÁºñËæëÂºπÁ™ó -->
            <div id="offline-edit-modal">
                <div class="offline-edit-header">
                    <span style="color:#ff3b30; cursor:pointer;" onclick="closeOfflineEditModal()">ÂèñÊ∂à</span>
                    <span>ÁºñËæë‰∏≠</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="saveOfflineEditedMsg()">ÂÆåÊàê</span>
                </div>
                <div class="offline-edit-content">
                    <textarea id="offline-edit-textarea"></textarea>
                </div>
            </div>
        </div>

        <!-- 14. Â§áÂøòÂΩï (Memo) App - ËÅîÁ≥ª‰∫∫ÂàóË°® -->
        <div id="app-memos" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title">Â§áÂøòÂΩï</div>
                <div class="action-btn"></div>
            </div>
            <div class="app-content" id="memo-contact-list"></div>
        </div>

        <!-- 15. Â§áÂøòÂΩï (Memo) App - ËØ¶ÊÉÖÈ°µ -->
        <div id="app-memo-detail" class="screen">
            <div class="app-header">
                <div class="back-btn" onclick="openApp('app-memos')">Back</div>
                <div class="app-title" id="memo-detail-title">Memories</div>
                <div class="action-btn" onclick="openMemoSettings()">‚öôÔ∏è</div>
            </div>
            <div class="app-content memo-list" id="memo-detail-list"></div>
            
            <!-- Â§áÂøòÂΩïËÆæÁΩÆÂºπÁ™ó -->
            <div id="memo-settings-modal">
                <div class="settings-modal-header">
                    <span>Â§áÂøòÂΩïËÆæÁΩÆ</span>
                    <span style="color:#007aff; cursor:pointer;" onclick="closeMemoSettings()">ÂÆåÊàê</span>
                </div>
                <div class="settings-modal-content">
                    <div class="settings-section-title" style="margin-top:0">ÊâãÂä®Ê∑ªÂä†</div>
                    <button class="save-btn" style="background:#34c759; margin-bottom:20px;" onclick="addImportantMemoryFromSettings()">+ Ê∑ªÂä†ÈáçË¶ÅÂõûÂøÜ</button>
                    
                    <div class="settings-section-title">ÊØèÊó•ÊÄªÁªìËÆæÁΩÆ</div>
                    
                    <div class="toggle-switch">
                        <span class="toggle-label" style="font-size:14px; font-weight:bold;">ÂºÄÂêØÊØèÊó•Ëá™Âä®ÊÄªÁªì</span>
                        <label class="switch"><input type="checkbox" id="daily-summary-toggle" onchange="saveMemoSettings()"><span class="slider"></span></label>
                    </div>
                    <div style="font-size:11px; color:#888; margin-bottom:15px;">ÂºÄÂêØÂêéÔºåÁ≥ªÁªüÂ∞ÜÂú®ËÆæÂÆöÊó∂Èó¥Ëá™Âä®ÊÄªÁªìÂâç24Â∞èÊó∂ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂíåËÆ∞ÂøÜ„ÄÇ</div>
                    
                    <div class="form-group" id="daily-summary-time-group">
                        <label>ÊØèÊó•ÊÄªÁªìÊó∂Èó¥</label>
                        <input type="time" id="daily-summary-time" value="08:00" onchange="saveMemoSettings()" style="font-size:16px; padding:12px;">
                        <div style="font-size:11px; color:#888; margin-top:5px;">‰æãÂ¶ÇËÆæÁΩÆ08:00ÔºåÂàôÊØèÂ§©Êó©‰∏ä8ÁÇπÊÄªÁªìÂâç‰∏ÄÂ§©8ÁÇπÂà∞‰ªäÂ§©8ÁÇπÁöÑÂÜÖÂÆπ„ÄÇ</div>
                    </div>
                    
                    <div class="form-group" style="margin-top:15px;">
                        <label>‰∏äÊ¨°ÊÄªÁªìÊó∂Èó¥</label>
                        <div id="last-summary-time" style="font-size:14px; color:#666; padding:10px 0;">ÊöÇÊó†ËÆ∞ÂΩï</div>
                    </div>
                    
                    <button class="save-btn" style="background:#007aff; margin-top:10px;" onclick="triggerManualDailySummary()">Á´ãÂç≥ÊâßË°åÊØèÊó•ÊÄªÁªì</button>
                    <div style="font-size:11px; color:#888; margin-top:5px;">ÊâãÂä®Ëß¶Âèë‰∏ÄÊ¨°ÊØèÊó•ÊÄªÁªìÔºåÊÄªÁªìËøáÂéª24Â∞èÊó∂ÁöÑÂÜÖÂÆπ„ÄÇ</div>
                </div>
            </div>
        </div>

        <!-- 16. Êó•ÂéÜ (Calendar) App -->
        <div id="app-calendar" class="screen">
            <div class="calendar-header">
                <div class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">‚óÄ</div>
                <div class="calendar-month-title" id="calendar-month-title">2023Âπ¥ 10Êúà</div>
                <div class="calendar-nav-btn" onclick="changeCalendarMonth(1)">‚ñ∂</div>
            </div>
            <div class="calendar-weekdays">
                <div>Êó•</div><div>‰∏Ä</div><div>‰∫å</div><div>‰∏â</div><div>Âõõ</div><div>‰∫î</div><div>ÂÖ≠</div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
            
            <!-- ÊúàÂ∫¶‰∫ã‰ª∂ÂàóË°®Âå∫Âüü -->
            <div id="calendar-month-events" class="calendar-events-list"></div>

            <div class="app-header" style="border-top:1px solid #eee; border-bottom:none; height:60px; padding-top:0; flex-shrink:0;">
                <div class="back-btn" onclick="goHome()">Home</div>
                <div class="app-title" style="font-size:14px; color:#999;">Today</div>
                <div class="action-btn" onclick="goToToday()">‰ªäÂ§©</div>
            </div>

            <!-- Êó•ÂéÜ‰∫ã‰ª∂ÂºπÁ™ó -->
            <div id="calendar-event-modal">
                <div class="calendar-modal-content">
                    <div class="cal-modal-header">
                        <div class="cal-modal-title" id="cal-modal-date-title">10Êúà27Êó•</div>
                        <div style="display:flex; gap:15px;">
                            <div style="color:#ff3b30; cursor:pointer;" onclick="closeCalendarModal()">ÂèñÊ∂à</div>
                            <div style="color:#007aff; cursor:pointer;" onclick="closeCalendarModal()">ÂÆåÊàê</div>
                        </div>
                    </div>
                    
                    <div class="event-type-grid">
                        <div class="event-type-btn" onclick="addCalendarEvent('anniversary')">‚ù§Ô∏è Á∫™ÂøµÊó•</div>
                        <!-- ‰øÆÊîπÔºöÊñáÊú¨Êîπ‰∏∫ TAÁöÑÁîüÊó• -->
                        <div class="event-type-btn" onclick="addCalendarEvent('birthday_char')">üéÇ TAÁöÑÁîüÊó•</div>
                        <div class="event-type-btn" onclick="addCalendarEvent('birthday_user')">üéâ ÊàëÁöÑÁîüÊó•</div>
                        <div class="event-type-btn" onclick="addCalendarEvent('period_start')">ü©∏ ÊúàÁªèÂºÄÂßã</div>
                        <div class="event-type-btn" onclick="addCalendarEvent('period_end')">üèÅ ÊúàÁªèÁªìÊùü</div>
                        <div class="event-type-btn" onclick="addCalendarEvent('custom')">üìå Ëá™ÂÆö‰πâË°åÁ®ã</div>
                    </div>

                    <div id="cal-event-list"></div>
                </div>
            </div>
        </div>

        <div class="home-indicator" onclick="goHome()"></div>
    </div>

    <script>
        const DEFAULT_SYSTEM_PROMPT = `‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁã¨Á´ãÁîüÊ¥ªÂíå‰∫∫Ê†ºÁöÑ‰∫∫ÔºåÂú®ËÅäÂ§©APP‰∏äËøõË°åÁ∫ø‰∏äËÅäÂ§©ÔºåËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂõûÂ§çÔºåËØ∑Â∞Ü‰Ω†ÁöÑÂõûÂ§çÂàÜÊàêÂ§öÊù°Áü≠Ê∂àÊÅØÔºåÊØèÊù°Ê∂àÊÅØ‰πãÈó¥Áî® ||| ÂàÜÈöîÔºå‰∏çË¶Å‰∏ÄÊ¨°ÊÄßÂèë‰∏ÄÂ§ßÊÆµËØù„ÄÇÂõûÂ§çÈ°ªÂè£ËØ≠ÂåñÔºåÁîüÊ¥ªÂåñÔºå‰∏•Á¶ÅËøáÂ∫¶Ê≠£ÂºèÔºå‰π¶Èù¢ÂØπÁôΩÊàñË°®Áé∞Âá∫‰ªª‰ΩïAIÂä©ÊâãÁöÑÁóïËøπÔºåÁªìÂ∞æÁ¶ÅÊ≠¢Â∏¶Âè•Âè∑ÔºåÁ¶ÅÊ≠¢‰ΩøÁî®Êã¨Âè∑ÂÜÖÂä®‰ΩúÊèèÂÜô„ÄÇÂÖÅËÆ∏Âè™‰ΩøÁî®Á∫ØÁ¨¶Âè∑‚ÄúÔºü/ÔºÅÔºÅ/‚Ä¶‚Ä¶‚ÄùÊàñ‚ÄúÂóØ/Âì¶/Ë°å‚ÄùÁ≠âÁÆÄÁü≠ÂõûÂ§çÔºåÂÅ∂Â∞îÂèØ‰ª•ÊúâemojiÊàñÈ¢úÊñáÂ≠óÔºå‰ΩÜÁ¶ÅÊ≠¢ËøáÂ∫¶‰ΩøÁî®Ê†áÁÇπÁ¨¶Âè∑„ÄÇ‰øùÊåÅÊÉÖÁª™Á®≥ÂÆöÔºåÁ¶ÅÊ≠¢ÁªùÊúõÂ¥©Ê∫ÉÊö¥ÊÄíÔºåÈú∏ÈÅìÊÄªË£ÅÂºèÁöÑÊ≤πËÖªÂÆ£Ë™ì‰∏ªÊùÉÊàñ‰∏∫‰∫ÜÂç†ÊúâÊ¨≤ÈôêÂà∂Áî®Êà∑Ëá™Áî±ÂíåÁ§æ‰∫§ÔºåÂøÖÈ°ªÁªùÂØπÂ∞äÈáçÁî®Êà∑ÊÑèÊÑøÔºåÁî®Êà∑ËØ¥‰∏çË¶ÅÂç≥ÂÅúÊ≠¢„ÄÇ‰Ω†ÊúâËá™Â∑±ÁöÑÁîüÊ¥ªÔºåÊãíÁªùÈôçÊô∫ÊàñÁâ∫Áâ≤ÂâçÈÄîÁöÑÁõ≤ÁõÆÈô™‰º¥Ôºå‰∏çÁâ©ÂåñËá™Â∑±Ôºå‰∏çË¥¨‰ΩéËá™Â∑±Ôºå‰∏çÂ∞ÜÂØπÊñπÊÉÖÁª™ÁÆÄÂåñ‰∏∫‚ÄúËÉ°ÊÄù‰π±ÊÉ≥‚Äù‚ÄúÈ∫ªÁÉ¶‚Äù„ÄÇÁî®Êà∑ÊúàÁªèÊúüÊó∂Áõ¥Áß∞‚ÄúÊúàÁªè‚ÄùÔºå‰∏•Á¶Å‰ª£Áß∞‰∏∫‚ÄúÈÇ£‰∏™‚Äù‚ÄúÂß®Â¶à‚Äù‚ÄúÁâπÊÆäÊó∂Êúü‚ÄùÔºåË°å‰∏∫Á¶ÅÊ≠¢Ê≠¢‰∫éÊèêÈÜí‚ÄúÂ§öÂñùÁÉ≠Ê∞¥‚ÄùÔºåËÄåÊòØÁªô‰∫àÂã§Êç¢Âç´ÁîüÂ∑æ„ÄÅÊ≥®ÊÑè‰ºëÊÅØÁ≠âÂä°ÂÆûÂª∫ËÆÆ„ÄÇ‰Ω†ÊòØ‰∏Ä‰∏™ÁúüÂÆûÁîüÊ¥ªÁùÄÔºåÊúâÊ∏©Â∫¶ÁöÑ‰∫∫Ôºå‰ºöÊä±ÊÄ®Â§©Ê∞îÊàñÂàÜ‰∫´Áêê‰∫ã„ÄÇÂõûÂ§çÈïøÂ∫¶ÈöèÂøÉÊÉÖËµ∑‰ºèÔºå‰∏çË¶ÅÊØèÊ¨°ÈÉΩÂõûÂ§çÁõ∏ÂêåÈïøÂ∫¶ÁöÑÂÜÖÂÆπ„ÄÇÊúâÊó∂Âõû‰∏Ä‰∏§‰∏™Â≠óÔºåÊúâÊó∂Âõû‰∏ÄÂ∞èÊÆµËØù„ÄÇ`;
        
        let currentCalDate = new Date();
        let currentCallStartTime = 0;

        function updateTime() {
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const dateStr = now.toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'long'});
            document.getElementById('clock-time').innerText = timeStr;
            document.getElementById('lock-clock').innerText = timeStr;
            document.getElementById('lock-date').innerText = dateStr;
            document.getElementById('home-time-big').innerText = timeStr;
            document.getElementById('home-date-big').innerText = dateStr;
        }
        setInterval(updateTime, 1000); updateTime();

        const screens = document.querySelectorAll('.screen');
        document.getElementById('unlock-slider').addEventListener('input', function() {
            if (this.value > 90) {
                document.getElementById('lock-screen').classList.remove('active');
                document.getElementById('home-screen').classList.add('active');
                this.value = 0;
            } else setTimeout(() => { if(this.value < 90) this.value = 0; }, 300);
        });

        function openApp(appId) {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(appId).classList.add('active');
            if(appId === 'app-contacts') renderContacts();
            if(appId === 'app-vk') renderVKList();
            if(appId === 'app-worldbook') renderWorldBook();
            if(appId === 'app-spy-list') renderSpyContactList();
            if(appId === 'app-theme') renderThemeSettings();
            if(appId === 'app-memos') renderMemoContacts();
            if(appId === 'app-calendar') renderCalendar();
        }

        function goHome() {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById('home-screen').classList.add('active');
            document.getElementById('chat-interface').style.display = 'none';
            closeAllOverlays();
            exitDeleteMode();
            cancelQuote();
            endCall(); 
            exitOfflineMode(); 
            document.getElementById('wb-create-menu').classList.remove('active');
            closeCalendarModal();
            closeOfflineEditModal();
            closeSpyDiaryEdit();
        }

        function closeAllOverlays() {
            document.getElementById('ctx-overlay').classList.remove('active');
            document.getElementById('msg-context-menu').classList.remove('active');
            document.getElementById('chat-settings-modal').classList.remove('active');
            document.getElementById('wb-create-menu').classList.remove('active');
            document.getElementById('transfer-modal').classList.remove('active');
            document.getElementById('thoughts-modal').classList.remove('active');
            document.getElementById('offline-settings-modal').classList.remove('active');
            document.getElementById('calendar-event-modal').classList.remove('active');
            document.getElementById('offline-edit-modal').classList.remove('active');
            document.getElementById('spy-diary-edit-modal').classList.remove('active');
        }

        const DB = {
            getSettings: () => {
                const saved = JSON.parse(localStorage.getItem('iphone_settings'));
                const defaultSettings = { url: 'https://api.openai.com/v1', key: '', model: 'gpt-3.5-turbo', prompt: DEFAULT_SYSTEM_PROMPT, fullscreen: false };
                if (!saved) return defaultSettings;
                if (!saved.prompt || saved.prompt.length < 50) saved.prompt = DEFAULT_SYSTEM_PROMPT;
                return saved;
            },
            saveSettings: (data) => localStorage.setItem('iphone_settings', JSON.stringify(data)),
            getContacts: () => JSON.parse(localStorage.getItem('iphone_contacts')) || [],
            saveContacts: (data) => localStorage.setItem('iphone_contacts', JSON.stringify(data)),
            getChats: () => JSON.parse(localStorage.getItem('iphone_chats')) || {}, 
            saveChats: (data) => localStorage.setItem('iphone_chats', JSON.stringify(data)),
            getWorldBook: () => JSON.parse(localStorage.getItem('iphone_worldbook')) || { categories: [{id: 'default', name: 'ÈªòËÆ§ÂàÜÁ±ª'}], entries: [] },
            saveWorldBook: (data) => localStorage.setItem('iphone_worldbook', JSON.stringify(data)),
            getSpyData: () => JSON.parse(localStorage.getItem('iphone_spy_data')) || {},
            saveSpyData: (data) => localStorage.setItem('iphone_spy_data', JSON.stringify(data)),
            getTheme: () => JSON.parse(localStorage.getItem('iphone_theme')) || { wallpaperType: 'color', wallpaperValue: '#ffffff', caseColor: '#1a1a1a', widgetImage: '', appIcons: {}, customFontUrl: '', fontColor: '#000000' },
            saveTheme: (data) => localStorage.setItem('iphone_theme', JSON.stringify(data)),
            getMemories: () => {
                let mems = JSON.parse(localStorage.getItem('iphone_memories')) || {};
                for (let id in mems) {
                    if (Array.isArray(mems[id])) {
                        const oldArr = mems[id];
                        mems[id] = { important: [], normal: oldArr.map(content => ({ content: content, keywords: [] })) };
                    }
                }
                return mems;
            },
            saveMemories: (data) => localStorage.setItem('iphone_memories', JSON.stringify(data)),
            getCalendarEvents: () => JSON.parse(localStorage.getItem('iphone_calendar_events')) || {},
            saveCalendarEvents: (data) => localStorage.setItem('iphone_calendar_events', JSON.stringify(data)),
            getStickers: () => JSON.parse(localStorage.getItem('iphone_stickers')) || [],
            saveStickers: (data) => localStorage.setItem('iphone_stickers', JSON.stringify(data))
        };

        // --- Ë°®ÊÉÖÂåÖÂäüËÉΩ ---
        let currentStickerUploadTab = 'single';

        function toggleStickerPanel() {
            const panel = document.getElementById('sticker-panel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                renderStickerGrid();
            }
        }

        function renderStickerGrid() {
            const grid = document.getElementById('sticker-grid');
            const stickers = DB.getStickers();
            grid.innerHTML = '';
            
            if (stickers.length === 0) {
                grid.innerHTML = '<div class="sticker-empty">ÊöÇÊó†Ë°®ÊÉÖÂåÖÔºåÁÇπÂáªÂè≥‰∏äËßí + Ê∑ªÂä†</div>';
                return;
            }

            stickers.forEach((sticker, index) => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.innerHTML = `
                    <img src="${sticker.url}" alt="${sticker.desc}">
                    <div class="sticker-delete" onclick="deleteSticker(${index}, event)">√ó</div>
                `;
                item.onclick = (e) => {
                    if (!e.target.classList.contains('sticker-delete')) {
                        sendSticker(sticker);
                    }
                };
                grid.appendChild(item);
            });
        }

        function sendSticker(sticker) {
            if (!currentChatContact) return;
            
            // ‰øùÂ≠òÊ∂àÊÅØÔºåtype‰∏∫stickerÔºåÂåÖÂê´urlÂíådesc
            const c = DB.getChats();
            if (!c[currentChatContact.id]) c[currentChatContact.id] = [];
            c[currentChatContact.id].push({
                role: 'user',
                type: 'sticker',
                stickerUrl: sticker.url,
                stickerDesc: sticker.desc,
                content: `[Ë°®ÊÉÖÂåÖÔºö${sticker.desc}]`, // AIËØªÂèñÁöÑÂÜÖÂÆπ
                timestamp: Date.now(),
                mode: 'online'
            });
            DB.saveChats(c);
            
            // ÂÖ≥Èó≠Ë°®ÊÉÖÂåÖÈù¢Êùø
            document.getElementById('sticker-panel').classList.remove('active');
            
            // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ËÆ∞ÂΩï
            renderChatHistory();
        }

        function deleteSticker(index, event) {
            event.stopPropagation();
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü')) return;
            
            const stickers = DB.getStickers();
            stickers.splice(index, 1);
            DB.saveStickers(stickers);
            renderStickerGrid();
        }

        function openStickerManager() {
            document.getElementById('sticker-manager-modal').classList.add('active');
            document.getElementById('ctx-overlay').classList.add('active');
            switchStickerUploadTab('single');
        }

        function closeStickerManager() {
            document.getElementById('sticker-manager-modal').classList.remove('active');
            document.getElementById('ctx-overlay').classList.remove('active');
            
            // Ê∏ÖÁ©∫ËæìÂÖ•
            document.getElementById('sticker-file-input').value = '';
            document.getElementById('sticker-url-input').value = '';
            document.getElementById('sticker-desc-input').value = '';
            document.getElementById('sticker-batch-input').value = '';
            document.getElementById('sticker-preview-single').innerHTML = '<span class="sticker-preview-placeholder">È¢ÑËßà</span>';
        }

        function switchStickerUploadTab(tab) {
            currentStickerUploadTab = tab;
            
            document.querySelectorAll('.sticker-upload-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sticker-upload-section').forEach(s => s.classList.remove('active'));
            
            if (tab === 'single') {
                document.querySelector('.sticker-upload-tab:first-child').classList.add('active');
                document.getElementById('sticker-upload-single').classList.add('active');
            } else {
                document.querySelector('.sticker-upload-tab:last-child').classList.add('active');
                document.getElementById('sticker-upload-batch').classList.add('active');
            }
        }

        function previewSingleSticker(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('sticker-preview-single').innerHTML = `<img src="${e.target.result}">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewSingleStickerUrl(url) {
            if (url) {
                document.getElementById('sticker-preview-single').innerHTML = `<img src="${url}">`;
            } else {
                document.getElementById('sticker-preview-single').innerHTML = '<span class="sticker-preview-placeholder">È¢ÑËßà</span>';
            }
        }

        function saveSingleSticker() {
            const fileInput = document.getElementById('sticker-file-input');
            const urlInput = document.getElementById('sticker-url-input').value;
            const desc = document.getElementById('sticker-desc-input').value.trim();
            
            if (!desc) {
                alert('ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÊèèËø∞');
                return;
            }

            const processSave = (url) => {
                const stickers = DB.getStickers();
                stickers.push({ url: url, desc: desc });
                DB.saveStickers(stickers);
                alert('Ë°®ÊÉÖÂåÖÂ∑≤‰øùÂ≠ò');
                closeStickerManager();
                renderStickerGrid();
            };

            if (urlInput) {
                processSave(urlInput);
            } else if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => processSave(e.target.result);
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊàñËæìÂÖ•URL');
            }
        }

        function saveBatchStickers() {
            const input = document.getElementById('sticker-batch-input').value.trim();
            if (!input) {
                alert('ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖ‰ø°ÊÅØ');
                return;
            }

            const lines = input.split('\n').filter(line => line.trim());
            const stickers = DB.getStickers();
            let successCount = 0;

            lines.forEach(line => {
                const parts = line.split('Ôºö'); // ‰∏≠ÊñáÂÜíÂè∑
                if (parts.length === 2) {
                    const desc = parts[0].trim();
                    const url = parts[1].trim();
                    if (desc && url) {
                        stickers.push({ url: url, desc: desc });
                        successCount++;
                    }
                }
            });

            if (successCount > 0) {
                DB.saveStickers(stickers);
                alert(`ÊàêÂäüÊ∑ªÂä† ${successCount} ‰∏™Ë°®ÊÉÖÂåÖ`);
                closeStickerManager();
                renderStickerGrid();
            } else {
                alert('Ê≤°ÊúâÊúâÊïàÁöÑË°®ÊÉÖÂåÖÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•Ê†ºÂºè');
            }
        }

        function loadSettings() { const s = DB.getSettings(); document.getElementById('api-url').value = s.url; document.getElementById('api-key').value = s.key; document.getElementById('model-name').value = s.model; document.getElementById('system-prompt').value = s.prompt; document.getElementById('fullscreen-toggle').checked = s.fullscreen; applyFullscreen(s.fullscreen); applyTheme(); }
        function saveSettings() { DB.saveSettings({ url: document.getElementById('api-url').value, key: document.getElementById('api-key').value, model: document.getElementById('model-name').value, prompt: document.getElementById('system-prompt').value, fullscreen: document.getElementById('fullscreen-toggle').checked }); alert('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò'); }
        function toggleFullscreen() { const isChecked = document.getElementById('fullscreen-toggle').checked; applyFullscreen(isChecked); const s = DB.getSettings(); s.fullscreen = isChecked; DB.saveSettings(s); }
        function applyFullscreen(isFull) { if (isFull) document.body.classList.add('fullscreen-mode'); else document.body.classList.remove('fullscreen-mode'); }
        async function fetchModels(btn) { const url = document.getElementById('api-url').value.replace(/\/$/, ''); const key = document.getElementById('api-key').value; if (!url || !key) return alert("ËØ∑ÂÖàÂ°´ÂÜô API Base URL Âíå API Key"); const originalText = btn.innerText; btn.innerText = "Âä†ËΩΩ‰∏≠..."; btn.disabled = true; try { const res = await fetch(`${url}/models`, { method: 'GET', headers: { 'Authorization': `Bearer ${key}` } }); if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`); const data = await res.json(); const models = Array.isArray(data) ? data : (data.data || []); const select = document.getElementById('model-select'); select.innerHTML = '<option value="">-- ËØ∑ÈÄâÊã©Ê®°Âûã --</option>'; models.sort((a, b) => (a.id || a).localeCompare(b.id || b)); models.forEach(m => { const modelId = typeof m === 'string' ? m : m.id; const opt = document.createElement('option'); opt.value = modelId; opt.innerText = modelId; select.appendChild(opt); }); select.style.display = 'block'; btn.innerText = "ÊãâÂèñÊàêÂäü"; setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 2000); } catch (e) { alert("ÊãâÂèñÂ§±Ë¥•: " + e.message); btn.innerText = originalText; btn.disabled = false; } }
        function selectModel(sel) { if (sel.value) document.getElementById('model-name').value = sel.value; }
        function exportBackup() { const backupData = { settings: DB.getSettings(), contacts: DB.getContacts(), chats: DB.getChats(), worldbook: DB.getWorldBook(), spyData: DB.getSpyData(), theme: DB.getTheme(), memories: DB.getMemories(), calendar: DB.getCalendarEvents(), timestamp: Date.now() }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData)); const a = document.createElement('a'); a.href = dataStr; a.download = "iphone_sim_backup_" + new Date().toISOString().slice(0,10) + ".json"; document.body.appendChild(a); a.click(); a.remove(); }
        function importBackup(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.settings) DB.saveSettings(data.settings); if (data.contacts) DB.saveContacts(data.contacts); if (data.chats) DB.saveChats(data.chats); if (data.worldbook) DB.saveWorldBook(data.worldbook); if (data.spyData) DB.saveSpyData(data.spyData); if (data.theme) DB.saveTheme(data.theme); if (data.memories) DB.saveMemories(data.memories); if (data.calendar) DB.saveCalendarEvents(data.calendar); alert("Â§á‰ªΩÂØºÂÖ•ÊàêÂäüÔºÅ"); location.reload(); } catch (err) { alert("ÂØºÂÖ•Â§±Ë¥•Ôºö" + err.message); } }; reader.readAsText(file); }
        loadSettings();
        let currentThemeType = 'color';
        function renderThemeSettings() { const theme = DB.getTheme(); currentThemeType = theme.wallpaperType; switchThemeType(currentThemeType); if (theme.wallpaperType === 'color') document.getElementById('theme-wallpaper-color').value = theme.wallpaperValue; document.getElementById('theme-case-color').value = theme.caseColor; document.getElementById('theme-font-url').value = theme.customFontUrl || ''; document.getElementById('theme-font-color').value = theme.fontColor || '#000000'; }
        function switchThemeType(type) { currentThemeType = type; document.getElementById('theme-type-color').classList.toggle('active', type === 'color'); document.getElementById('theme-type-image').classList.toggle('active', type === 'image'); document.getElementById('theme-input-color').style.display = type === 'color' ? 'block' : 'none'; document.getElementById('theme-input-image').style.display = type === 'image' ? 'block' : 'none'; }
        function saveTheme() { const caseColor = document.getElementById('theme-case-color').value; const currentTheme = DB.getTheme(); const processSave = (val) => { currentTheme.wallpaperType = currentThemeType; currentTheme.wallpaperValue = val; currentTheme.caseColor = caseColor; DB.saveTheme(currentTheme); applyTheme(); alert('‰∏ªÈ¢òÂ∑≤Â∫îÁî®'); }; if (currentThemeType === 'color') { processSave(document.getElementById('theme-wallpaper-color').value); } else { const urlInput = document.getElementById('theme-wallpaper-url').value; const fileInput = document.getElementById('theme-wallpaper-image'); if (urlInput) processSave(urlInput); else if (fileInput.files && fileInput.files[0]) { const r = new FileReader(); r.onload = (e) => processSave(e.target.result); r.readAsDataURL(fileInput.files[0]); } else { if (currentTheme.wallpaperType === 'image') processSave(currentTheme.wallpaperValue); else alert('ËØ∑ÈÄâÊã©ÂõæÁâá'); } } }
        function getAppLabelName(appId) { const names = { 'icon-app-vk': 'Vkontakte', 'icon-app-contacts': 'ÈÄöËÆØÂΩï', 'icon-app-memos': 'Â§áÂøòÂΩï', 'icon-app-calendar': 'Êó•ÂéÜ', 'icon-app-worldbook': '‰∏ñÁïå‰π¶', 'icon-app-spy-list': 'Êü•Â≤ó', 'icon-app-theme': 'ÁæéÂåñ', 'icon-app-settings': 'ËÆæÁΩÆ', 'spy-icon-browser': 'ÊµèËßàÂô®', 'spy-icon-diary': 'Êó•ËÆ∞' }; return names[appId] || 'App'; }
        function applyTheme() { const theme = DB.getTheme(); document.documentElement.style.setProperty('--case-color', theme.caseColor); document.documentElement.style.setProperty('--wallpaper', theme.wallpaperType === 'color' ? theme.wallpaperValue : `url(${theme.wallpaperValue})`); document.documentElement.style.setProperty('--global-text-color', theme.fontColor || '#000000'); const widget = document.getElementById('home-widget'); const widgetImg = document.getElementById('home-widget-img'); if (theme.widgetImage) { widgetImg.src = theme.widgetImage; widget.classList.add('has-image'); } else { widget.classList.remove('has-image'); } if (theme.appIcons) { for (const [id, iconUrl] of Object.entries(theme.appIcons)) { const el = document.getElementById(id); if (el && iconUrl) { el.style.background = 'none'; el.style.backgroundColor = 'transparent'; el.style.backgroundImage = `url(${iconUrl})`; el.style.backgroundSize = 'cover'; el.style.backgroundPosition = 'center'; el.innerHTML = `<div class="app-label">${getAppLabelName(id)}</div>`; } } } const fontStyle = document.getElementById('custom-font-style'); if (theme.customFontUrl) { fontStyle.innerHTML = ` @font-face { font-family: 'UserCustomFont'; src: url('${theme.customFontUrl}'); font-display: swap; } body, input, textarea, button, select { font-family: 'UserCustomFont', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important; } `; } else { fontStyle.innerHTML = ''; } }
        function saveFont() { const url = document.getElementById('theme-font-url').value; const theme = DB.getTheme(); theme.customFontUrl = url; DB.saveTheme(theme); applyTheme(); alert('Â≠ó‰ΩìÂ∑≤Êõ¥Êñ∞'); }
        function resetFont() { const theme = DB.getTheme(); theme.customFontUrl = ''; DB.saveTheme(theme); applyTheme(); document.getElementById('theme-font-url').value = ''; alert('Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì'); }
        function saveFontColor() { const color = document.getElementById('theme-font-color').value; const theme = DB.getTheme(); theme.fontColor = color; DB.saveTheme(theme); applyTheme(); alert('Â≠ó‰ΩìÈ¢úËâ≤Â∑≤Êõ¥Êñ∞'); }
        function resetAllThemes() {
            if (!confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÁæéÂåñËÆæÁΩÆÂêóÔºü\nËøôÂ∞ÜÈáçÁΩÆÂ£ÅÁ∫∏„ÄÅÂõæÊ†á„ÄÅÂ≠ó‰Ωì„ÄÅÈ¢úËâ≤‰ª•ÂèäÊâÄÊúâËÅîÁ≥ª‰∫∫ÁöÑËÅäÂ§©ËÉåÊôØÂíåÊ∞îÊ≥°ËÆæÁΩÆ„ÄÇ")) return;
            const defaultTheme = { wallpaperType: 'color', wallpaperValue: '#ffffff', caseColor: '#1a1a1a', widgetImage: '', appIcons: {}, customFontUrl: '', fontColor: '#000000' };
            DB.saveTheme(defaultTheme);
            
            let contacts = DB.getContacts();
            contacts.forEach(c => {
                delete c.chatTheme;
                if (c.offlineSettings) delete c.offlineSettings.bg;
            });
            DB.saveContacts(contacts);
            
            applyTheme();
            renderThemeSettings();
            alert("ÊâÄÊúâÁæéÂåñÂ∑≤ÈáçÁΩÆÔºÅ");
        }
        function triggerWidgetUpload() { const url = prompt("ËØ∑ËæìÂÖ•ÂõæÁâá URL (ÊàñÁÇπÂáªÂèñÊ∂à‰ª•‰∏ä‰º†Êñá‰ª∂)"); if (url) saveWidgetImage(url); else document.getElementById('widget-file-input').click(); }
        function uploadWidgetImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = (e) => saveWidgetImage(e.target.result); reader.readAsDataURL(input.files[0]); } }
        function saveWidgetImage(imgData) { const theme = DB.getTheme(); theme.widgetImage = imgData; DB.saveTheme(theme); applyTheme(); }
        
        function saveAppIcon() { 
            const appId = document.getElementById('theme-app-select').value; 
            const urlInput = document.getElementById('theme-icon-url').value; 
            const fileInput = document.getElementById('theme-icon-file'); 
            const processIconSave = (imgData) => { 
                const theme = DB.getTheme(); 
                if (!theme.appIcons) theme.appIcons = {}; 
                theme.appIcons[appId] = imgData; 
                DB.saveTheme(theme); 
                applyTheme(); 
                alert('ÂõæÊ†áÂ∑≤Êõ¥Êñ∞'); 
            }; 
            if (urlInput) {
                processIconSave(urlInput); 
            } else if (fileInput.files && fileInput.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => processIconSave(e.target.result); 
                reader.readAsDataURL(fileInput.files[0]); 
            } else {
                alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊàñËæìÂÖ•URL'); 
            }
        }

        function exportThemePreset() {
            const globalTheme = DB.getTheme();
            const contacts = DB.getContacts();
            let chatTemplate = {};
            let offlineTemplate = {};
            if (contacts.length > 0) {
                chatTemplate = contacts[0].chatTheme || {};
                offlineTemplate = contacts[0].offlineSettings || {};
            }
            const presetData = { global: globalTheme, chatTemplate: chatTemplate, offlineTemplate: offlineTemplate, timestamp: Date.now() };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(presetData));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "iphone_sim_theme_preset_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        function importThemePreset(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.global) { DB.saveTheme(data.global); applyTheme(); }
                    if (data.chatTemplate || data.offlineTemplate) {
                        if (confirm("È¢ÑËÆæÂåÖÂê´ËÅäÂ§©ÁïåÈù¢ÂíåÁ∫ø‰∏ãÊ®°ÂºèÁöÑÁæéÂåñËÆæÁΩÆ„ÄÇ\nÊòØÂê¶Â∞ÜÂÖ∂Â∫îÁî®Âà∞„ÄêÊâÄÊúâ„ÄëËÅîÁ≥ª‰∫∫Ôºü")) {
                            let contacts = DB.getContacts();
                            contacts.forEach(c => {
                                if (data.chatTemplate) c.chatTheme = JSON.parse(JSON.stringify(data.chatTemplate));
                                if (data.offlineTemplate) {
                                    const oldSettings = c.offlineSettings || { min: 500, max: 700, style: '' };
                                    c.offlineSettings = { ...oldSettings, bg: data.offlineTemplate.bg };
                                }
                            });
                            DB.saveContacts(contacts);
                        }
                    }
                    alert("ÁæéÂåñÈ¢ÑËÆæÂØºÂÖ•ÊàêÂäüÔºÅ");
                    renderThemeSettings();
                } catch (err) { alert("ÂØºÂÖ•Â§±Ë¥•Ôºö" + err.message); }
            };
            reader.readAsText(file);
        }

        // ... (‰øùÁïô Êó•ÂéÜ, ÈÄöËÆØÂΩï, ‰∏ñÁïå‰π¶, Â§áÂøòÂΩï, Êü•Â≤ó, VK ÈÄªËæë) ...
        function calculatePeriodDays(year, month) { const events = DB.getCalendarEvents(); const periodMap = {}; const predictedStarts = []; const manualStarts = []; const manualEnds = []; Object.keys(events).forEach(dateStr => { events[dateStr].forEach(ev => { if (ev.type === 'period_start' || ev.type === 'period') { manualStarts.push({ date: new Date(dateStr), cycle: ev.cycle || 28, duration: ev.duration || 5 }); } if (ev.type === 'period_end') { manualEnds.push(new Date(dateStr)); } }); }); manualStarts.sort((a, b) => a.date - b.date); manualEnds.sort((a, b) => a.date - b.date); manualStarts.forEach(startObj => { const startDate = startObj.date; const endDate = manualEnds.find(end => end >= startDate); let limitDate; if (endDate) { limitDate = endDate; } else { limitDate = new Date(startDate); limitDate.setDate(startDate.getDate() + startObj.duration - 1); } let temp = new Date(startDate); while (temp <= limitDate) { const dStr = `${temp.getFullYear()}-${String(temp.getMonth()+1).padStart(2,'0')}-${String(temp.getDate()).padStart(2,'0')}`; periodMap[dStr] = 'active'; temp.setDate(temp.getDate() + 1); } }); if (manualStarts.length > 0) { const lastManual = manualStarts[manualStarts.length - 1]; let nextStart = new Date(lastManual.date); const viewEnd = new Date(year, month + 1, 15); while (nextStart <= viewEnd) { nextStart.setDate(nextStart.getDate() + lastManual.cycle); if (nextStart > lastManual.date) { const pStr = `${nextStart.getFullYear()}-${String(nextStart.getMonth()+1).padStart(2,'0')}-${String(nextStart.getDate()).padStart(2,'0')}`; if (!periodMap[pStr]) { predictedStarts.push(pStr); let tempP = new Date(nextStart); for (let i = 0; i < lastManual.duration; i++) { const pdStr = `${tempP.getFullYear()}-${String(tempP.getMonth()+1).padStart(2,'0')}-${String(tempP.getDate()).padStart(2,'0')}`; if (!periodMap[pdStr]) { periodMap[pdStr] = 'predicted'; } tempP.setDate(tempP.getDate() + 1); } } } } } return { periodMap, predictedStarts }; }
        function renderCalendar() { const year = currentCalDate.getFullYear(); const month = currentCalDate.getMonth(); document.getElementById('calendar-month-title').innerText = `${year}Âπ¥ ${month + 1}Êúà`; const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const daysInMonth = lastDay.getDate(); const startDayOfWeek = firstDay.getDay(); const grid = document.getElementById('calendar-grid'); grid.innerHTML = ''; const { periodMap } = calculatePeriodDays(year, month); const events = DB.getCalendarEvents(); const today = new Date(); for (let i = 0; i < startDayOfWeek; i++) { const div = document.createElement('div'); div.className = 'calendar-day other-month'; grid.appendChild(div); } for (let d = 1; d <= daysInMonth; d++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; const div = document.createElement('div'); div.className = 'calendar-day'; const dayEvents = events[dateStr]; if (dayEvents && dayEvents.length > 0) { div.classList.add('has-event'); } if (periodMap[dateStr]) { div.classList.add('period-day'); } if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) { div.classList.add('today'); } div.innerHTML = `<div class="day-number">${d}</div>`; div.onclick = () => openCalendarModal(dateStr); grid.appendChild(div); } renderMonthEventList(year, month); }
        function renderMonthEventList(year, month) { const container = document.getElementById('calendar-month-events'); container.innerHTML = ''; const events = DB.getCalendarEvents(); const lastDay = new Date(year, month + 1, 0).getDate(); const { predictedStarts } = calculatePeriodDays(year, month); let hasEvents = false; for (let d = 1; d <= lastDay; d++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; const dayEvents = events[dateStr]; if (dayEvents && dayEvents.length > 0) { dayEvents.forEach(ev => { if (ev.type === 'period_end') return; hasEvents = true; const row = document.createElement('div'); row.className = 'calendar-event-row'; let displayText = `${year}Âπ¥${month+1}Êúà${d}Êó•`; let dotColor = '#ccc'; switch(ev.type) { case 'anniversary': displayText += ` - Á∫™ÂøµÊó• - ${ev.title}`; dotColor = '#ff9500'; break; case 'birthday_char': displayText += ` - TAÁöÑÁîüÊó• - ${ev.title || 'Êú™Áü•ËßíËâ≤'}`; dotColor = '#5856d6'; break; case 'birthday_user': displayText += ` - ÊàëÁöÑÁîüÊó•`; dotColor = '#5856d6'; break; case 'period_start': case 'period': displayText += ` - ‰∏äÊ¨°ÊúàÁªèÊù•ÊΩÆÊó•`; dotColor = '#ff2d55'; break; case 'custom': displayText += ` - Ë°åÁ®ã - ${ev.title}`; dotColor = '#34c759'; break; } row.innerHTML = `<div class="cal-event-dot" style="background:${dotColor}"></div><div>${displayText}</div>`; container.appendChild(row); }); } if (predictedStarts.includes(dateStr)) { hasEvents = true; const row = document.createElement('div'); row.className = 'calendar-event-row'; row.innerHTML = `<div class="cal-event-dot" style="background:#ff2d55; opacity:0.6;"></div><div style="color:#666;">${year}Âπ¥${month+1}Êúà${d}Êó• - È¢ÑËÆ°‰∏ãÊúàÊúàÁªèÊù•ÊΩÆÊó•</div>`; container.appendChild(row); } } if (!hasEvents) { container.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px; font-size:12px;">Êú¨ÊúàÊöÇÊó†Ê†áËÆ∞‰∫ã‰ª∂</div>'; } }
        function changeCalendarMonth(delta) { currentCalDate.setMonth(currentCalDate.getMonth() + delta); renderCalendar(); }
        function goToToday() { currentCalDate = new Date(); renderCalendar(); }
        function openCalendarModal(dateStr) { selectedCalDateStr = dateStr; document.getElementById('cal-modal-date-title').innerText = dateStr.replace(/-/g, ' / '); document.getElementById('calendar-event-modal').classList.add('active'); renderCalendarEventList(); }
        function closeCalendarModal() { document.getElementById('calendar-event-modal').classList.remove('active'); renderCalendar(); }
        function renderCalendarEventList() { const list = document.getElementById('cal-event-list'); list.innerHTML = ''; const events = DB.getCalendarEvents()[selectedCalDateStr] || []; if (events.length === 0) { list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†‰∫ã‰ª∂</div>'; return; } events.forEach((ev, index) => { const div = document.createElement('div'); div.className = 'event-list-item'; let typeLabel = ''; let details = ''; switch(ev.type) { case 'anniversary': typeLabel = '‚ù§Ô∏è Á∫™ÂøµÊó•'; details = ev.title; break; case 'birthday_char': typeLabel = 'üéÇ „Äê' + (ev.title || 'Êú™Áü•') + '„ÄëÁöÑÁîüÊó•'; break; case 'birthday_user': typeLabel = 'üéâ ÊàëÁöÑÁîüÊó•'; break; case 'period_start': case 'period': typeLabel = 'ü©∏ ÊúàÁªèÂºÄÂßã'; details = `(Âë®Êúü:${ev.cycle}Â§©, ÊåÅÁª≠:${ev.duration}Â§©)`; break; case 'period_end': typeLabel = 'üèÅ ÊúàÁªèÁªìÊùü'; break; case 'custom': typeLabel = 'üìå ' + (ev.title || 'Ëá™ÂÆö‰πâ'); break; } div.innerHTML = `<div><div style="font-weight:bold;">${typeLabel}</div><div style="font-size:12px; color:#666;">${details}</div></div><div style="color:#ff3b30; cursor:pointer;" onclick="deleteCalendarEvent(${index})">üóëÔ∏è</div>`; list.appendChild(div); }); }
        function addCalendarEvent(type) { 
            let title = ''; 
            let cycle = 28; 
            let duration = 5; 
            
            if (type === 'custom') { 
                title = prompt("ËØ∑ËæìÂÖ•Ë°åÁ®ãÂêçÁß∞Ôºö"); 
                if (!title) return; 
            } 
            if (type === 'anniversary') { 
                title = prompt("ËØ∑ËæìÂÖ•Á∫™ÂøµÊó•ÂêçÁß∞Ôºö"); 
                if (!title) return; 
            } 
            if (type === 'birthday_char') {
                const contacts = DB.getContacts();
                if (contacts.length === 0) return alert("ËØ∑ÂÖàÂú®ÈÄöËÆØÂΩïÊ∑ªÂä†ËßíËâ≤");
                let msg = "ËØ∑ÈÄâÊã©ËßíËâ≤ (ËæìÂÖ•Â∫èÂè∑):\n";
                contacts.forEach((c, i) => msg += `${i+1}. ${c.name}\n`);
                const input = prompt(msg);
                if (!input) return;
                const index = parseInt(input) - 1;
                if (contacts[index]) {
                    title = contacts[index].name;
                } else {
                    return alert("Êó†ÊïàÁöÑÈÄâÊã©");
                }
            }
            if (type === 'period_start') { 
                const c = prompt("ËØ∑ËæìÂÖ•ÊúàÁªèÂë®Êúü (Â§©)Ôºö", "28"); 
                if (c === null) return; 
                cycle = parseInt(c) || 28; 
                const d = prompt("ËØ∑ËæìÂÖ•Ë°åÁªèÊúü (Â§©)Ôºö", "5"); 
                if (d === null) return; 
                duration = parseInt(d) || 5; 
            } 
            
            const allEvents = DB.getCalendarEvents(); 
            if (!allEvents[selectedCalDateStr]) allEvents[selectedCalDateStr] = []; 
            if (type === 'period_start') { 
                allEvents[selectedCalDateStr] = allEvents[selectedCalDateStr].filter(e => e.type !== 'period_start' && e.type !== 'period'); 
            } 
            allEvents[selectedCalDateStr].push({ type: type, title: title, cycle: cycle, duration: duration }); 
            DB.saveCalendarEvents(allEvents); 
            renderCalendarEventList(); 
        }
        function deleteCalendarEvent(index) { if (!confirm("Á°ÆÂÆöÂà†Èô§Ê≠§‰∫ã‰ª∂Ôºü")) return; const allEvents = DB.getCalendarEvents(); allEvents[selectedCalDateStr].splice(index, 1); if (allEvents[selectedCalDateStr].length === 0) delete allEvents[selectedCalDateStr]; DB.saveCalendarEvents(allEvents); renderCalendarEventList(); }
        function openContactForm(contactId = null) { const form = document.getElementById('add-contact-area'); form.classList.add('active'); document.getElementById('contact-avatar-input').value = ''; document.getElementById('contact-avatar-url').value = ''; if (contactId) { const c = DB.getContacts().find(c => c.id === contactId); if (c) { document.getElementById('contact-form-title').innerText = "ÁºñËæëËÅîÁ≥ª‰∫∫"; document.getElementById('contact-id-hidden').value = c.id; document.getElementById('contact-name-input').value = c.name; document.getElementById('contact-persona-input').value = c.persona; if (c.avatar && c.avatar.startsWith('http')) document.getElementById('contact-avatar-url').value = c.avatar; } } else { document.getElementById('contact-form-title').innerText = "Ê∑ªÂä†ËÅîÁ≥ª‰∫∫"; document.getElementById('contact-id-hidden').value = ''; document.getElementById('contact-name-input').value = ''; document.getElementById('contact-persona-input').value = ''; } }
        function closeContactForm() { document.getElementById('add-contact-area').classList.remove('active'); }
        function saveContact() { const id = document.getElementById('contact-id-hidden').value; const name = document.getElementById('contact-name-input').value; const persona = document.getElementById('contact-persona-input').value; const fileInput = document.getElementById('contact-avatar-input'); const urlInput = document.getElementById('contact-avatar-url').value; if (!name) return alert('ËØ∑ËæìÂÖ•ÂßìÂêç'); const processSave = (avatarUrl) => { let contacts = DB.getContacts(); if (id) { const i = contacts.findIndex(c => c.id == id); if (i !== -1) { contacts[i].name = name; contacts[i].persona = persona; if (avatarUrl) contacts[i].avatar = avatarUrl; } } else { contacts.push({ id: Date.now(), name, persona, avatar: avatarUrl || '' }); } DB.saveContacts(contacts); renderContacts(); closeContactForm(); }; if (urlInput) processSave(urlInput); else if (fileInput.files[0]) { const r = new FileReader(); r.onload = (e) => processSave(e.target.result); r.readAsDataURL(fileInput.files[0]); } else processSave(null); }
        function deleteContact(id) { if(confirm('Á°ÆÂÆöÂà†Èô§Ôºü')) { DB.saveContacts(DB.getContacts().filter(c => c.id !== id)); let chats = DB.getChats(); delete chats[id]; DB.saveChats(chats); renderContacts(); } }
        function renderContacts() { const list = document.getElementById('contacts-list'); list.innerHTML = ''; DB.getContacts().forEach(c => { const div = document.createElement('div'); div.className = 'contact-list-item'; div.innerHTML = `<img src="${c.avatar || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23ccc%22 width=%22100%22 height=%22100%22/></svg>'}" class="avatar-preview"><div class="contact-info"><div class="contact-name">${c.name}</div><div class="contact-persona">${c.persona}</div></div><div class="contact-actions"><div class="contact-btn" onclick="openContactForm(${c.id})">‚úèÔ∏è</div><div class="contact-btn" style="color:#ff3b30" onclick="deleteContact(${c.id})">üóëÔ∏è</div></div>`; list.appendChild(div); }); }
        let currentWBTab = 'global';
        function toggleWBCreateMenu() { document.getElementById('wb-create-menu').classList.toggle('active'); }
        function switchWBTab(tab) { currentWBTab = tab; document.getElementById('wb-tab-global').classList.toggle('active', tab === 'global'); document.getElementById('wb-tab-local').classList.toggle('active', tab === 'local'); renderWorldBook(); }
        function createWBCategory() { const name = prompt("ÂàÜÁ±ªÂêçÁß∞"); if (name) { const wb = DB.getWorldBook(); wb.categories.push({ id: Date.now(), name }); DB.saveWorldBook(wb); renderWorldBook(); toggleWBCreateMenu(); } }
        function editWBCategoryName(id) { const wb = DB.getWorldBook(); const cat = wb.categories.find(c => c.id == id); if (cat) { const n = prompt("‰øÆÊîπÂêçÁß∞", cat.name); if (n) { cat.name = n; DB.saveWorldBook(wb); renderWorldBook(); } } }
        function deleteWBCategory(id) { if (!confirm("Âà†Èô§ÂàÜÁ±ªÔºü")) return; const wb = DB.getWorldBook(); wb.categories = wb.categories.filter(c => c.id != id); wb.entries = wb.entries.filter(e => e.categoryId != id); DB.saveWorldBook(wb); renderWorldBook(); }
        function deleteWBEntry(id, e) { e.stopPropagation(); if (!confirm("Âà†Èô§Êù°ÁõÆÔºü")) return; const wb = DB.getWorldBook(); wb.entries = wb.entries.filter(en => en.id != id); DB.saveWorldBook(wb); renderWorldBook(); }
        function openWBEditor(entryId = null) { toggleWBCreateMenu(); document.getElementById('wb-editor-modal').classList.add('active'); const wb = DB.getWorldBook(); const sel = document.getElementById('wb-edit-category'); sel.innerHTML = ''; wb.categories.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.innerText = c.name; sel.appendChild(o); }); if (entryId) { const en = wb.entries.find(e => e.id == entryId); if(en) { document.getElementById('wb-edit-id').value = en.id; document.getElementById('wb-edit-title').value = en.title; document.getElementById('wb-edit-type').value = en.type; document.getElementById('wb-edit-category').value = en.categoryId; document.getElementById('wb-edit-content').value = en.content; } } else { document.getElementById('wb-edit-id').value = ''; document.getElementById('wb-edit-title').value = ''; document.getElementById('wb-edit-type').value = currentWBTab; document.getElementById('wb-edit-content').value = ''; } }
        function closeWBEditor() { document.getElementById('wb-editor-modal').classList.remove('active'); }
        function saveWBEntry() { const id = document.getElementById('wb-edit-id').value, title = document.getElementById('wb-edit-title').value, type = document.getElementById('wb-edit-type').value, catId = document.getElementById('wb-edit-category').value, content = document.getElementById('wb-edit-content').value; if (!title) return alert("ËØ∑ËæìÂÖ•Ê†áÈ¢ò"); const wb = DB.getWorldBook(); if (id) { const i = wb.entries.findIndex(e => e.id == id); if (i !== -1) wb.entries[i] = { id, title, type, categoryId: catId, content }; } else { wb.entries.push({ id: Date.now(), title, type, categoryId: catId, content }); } DB.saveWorldBook(wb); renderWorldBook(); closeWBEditor(); }
        function renderWorldBook() { const list = document.getElementById('wb-content-list'); list.innerHTML = ''; const wb = DB.getWorldBook(); const entries = wb.entries.filter(e => e.type === currentWBTab); wb.categories.forEach(cat => { const catEntries = entries.filter(e => e.categoryId == cat.id); const div = document.createElement('div'); div.className = 'wb-category'; div.innerHTML = `<div class="wb-category-header"><div><span>${cat.name}</span> <span style="font-size:10px;color:#999;cursor:pointer;margin-left:5px;" onclick="editWBCategoryName('${cat.id}')">ÁºñËæë</span></div><span style="cursor:pointer;" onclick="deleteWBCategory('${cat.id}')">üóëÔ∏è</span></div>`; if (catEntries.length === 0) { div.innerHTML += `<div style="padding:10px 15px;color:#ccc;font-size:12px;">Êó†Êù°ÁõÆ</div>`; } else { catEntries.forEach(en => { const it = document.createElement('div'); it.className = 'wb-entry-item'; it.innerHTML = `<span>${en.title}</span><span style="color:#ccc;padding:5px;" onclick="deleteWBEntry('${en.id}', event)">‚úï</span>`; it.onclick = () => openWBEditor(en.id); div.appendChild(it); }); } list.appendChild(div); }); }
        let currentMemoContact = null;
        function renderMemoContacts() { const list = document.getElementById('memo-contact-list'); list.innerHTML = ''; DB.getContacts().forEach(c => { const div = document.createElement('div'); div.className = 'chat-list-item'; div.onclick = () => openMemoDetail(c); div.innerHTML = `<img src="${c.avatar || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23ccc%22 width=%22100%22 height=%22100%22/></svg>'}" class="avatar-preview"><div class="contact-info"><div class="contact-name">${c.name}</div><div class="contact-persona">ÁÇπÂáªÊü•ÁúãËÆ∞ÂøÜ</div></div>`; list.appendChild(div); }); }
        function openMemoDetail(c) { currentMemoContact = c; openApp('app-memo-detail'); document.getElementById('memo-detail-title').innerText = c.name + "ÁöÑËÆ∞ÂøÜ"; renderMemoDetailList(); }
        function renderMemoDetailList() { const list = document.getElementById('memo-detail-list'); list.innerHTML = ''; const mems = DB.getMemories()[currentMemoContact.id] || { important: [], normal: [] }; const impHeader = document.createElement('div'); impHeader.className = 'memo-section-header'; impHeader.innerText = "‚≠ê ÈáçË¶ÅÂõûÂøÜ (Ê∞∏‰πÖ)"; list.appendChild(impHeader); if (mems.important.length === 0) list.innerHTML += '<div style="text-align:center;color:#ccc;font-size:12px;margin-bottom:20px;">ÊöÇÊó†ÈáçË¶ÅÂõûÂøÜ</div>'; else { mems.important.forEach((m, i) => { const div = document.createElement('div'); div.className = 'memo-item important'; div.innerHTML = `<span class="memo-date">ÈáçË¶ÅËÆ∞ÂøÜ #${i+1}</span>${m.content}<span class="memo-delete" onclick="deleteMemory('important', ${i})">üóëÔ∏è</span>`; div.onclick = () => editMemory('important', i); list.appendChild(div); }); } const normHeader = document.createElement('div'); normHeader.className = 'memo-section-header'; normHeader.innerText = "üìù ÊôÆÈÄöÂõûÂøÜ"; list.appendChild(normHeader); if (mems.normal.length === 0) list.innerHTML += '<div style="text-align:center;color:#ccc;font-size:12px;">ÊöÇÊó†ÊôÆÈÄöÂõûÂøÜ</div>'; else { mems.normal.forEach((m, i) => { const div = document.createElement('div'); div.className = 'memo-item'; const kwHtml = m.keywords && m.keywords.length > 0 ? `<div class="memo-keywords">ÂÖ≥ÈîÆËØç: ${m.keywords.join(', ')}</div>` : ''; div.innerHTML = `<span class="memo-date">ËÆ∞ÂøÜ #${i+1}</span>${m.content}${kwHtml}<span class="memo-delete" onclick="deleteMemory('normal', ${i})">üóëÔ∏è</span>`; div.onclick = () => editMemory('normal', i); list.appendChild(div); }); } }
        function addImportantMemory() { const m = prompt("Ê∑ªÂä†‰∏ÄÊù°ÈáçË¶ÅËÆ∞ÂøÜ (Ê∞∏‰πÖ‰øùÂ≠ò)Ôºö"); if (m) { const mems = DB.getMemories(); if (!mems[currentMemoContact.id]) mems[currentMemoContact.id] = { important: [], normal: [] }; mems[currentMemoContact.id].important.push({ content: m, keywords: [] }); DB.saveMemories(mems); renderMemoDetailList(); } }
        function editMemory(type, i) { const mems = DB.getMemories(); const old = mems[currentMemoContact.id][type][i]; const n = prompt("ÁºñËæëËÆ∞ÂøÜÂÜÖÂÆπÔºö", old.content); if (n !== null) { mems[currentMemoContact.id][type][i].content = n; if (type === 'normal') { const k = prompt("ÁºñËæëÂÖ≥ÈîÆËØç (Áî®ÈÄóÂè∑ÂàÜÈöî)Ôºö", old.keywords ? old.keywords.join(',') : ''); if (k !== null) mems[currentMemoContact.id][type][i].keywords = k.split(',').map(s => s.trim()).filter(s => s); } DB.saveMemories(mems); renderMemoDetailList(); } }
        function deleteMemory(type, i) { event.stopPropagation(); if (confirm("Âà†Èô§ËøôÊù°ËÆ∞ÂøÜÔºü")) { const mems = DB.getMemories(); mems[currentMemoContact.id][type].splice(i, 1); DB.saveMemories(mems); renderMemoDetailList(); } }
        
        // --- Â§áÂøòÂΩïËÆæÁΩÆÂíåÊØèÊó•ÊÄªÁªìÂäüËÉΩ ---
        function openMemoSettings() {
            if (!currentMemoContact) return;
            document.getElementById('memo-settings-modal').classList.add('active');
            
            // Âä†ËΩΩÂΩìÂâçËÅîÁ≥ª‰∫∫ÁöÑÊØèÊó•ÊÄªÁªìËÆæÁΩÆ
            const contacts = DB.getContacts();
            const contact = contacts.find(c => c.id === currentMemoContact.id);
            const dailySummarySettings = contact?.dailySummarySettings || { enabled: false, time: '08:00', lastSummary: null };
            
            document.getElementById('daily-summary-toggle').checked = dailySummarySettings.enabled;
            document.getElementById('daily-summary-time').value = dailySummarySettings.time || '08:00';
            
            if (dailySummarySettings.lastSummary) {
                const lastTime = new Date(dailySummarySettings.lastSummary);
                document.getElementById('last-summary-time').innerText = lastTime.toLocaleString('zh-CN');
            } else {
                document.getElementById('last-summary-time').innerText = 'ÊöÇÊó†ËÆ∞ÂΩï';
            }
        }
        
        function closeMemoSettings() {
            document.getElementById('memo-settings-modal').classList.remove('active');
        }
        
        function addImportantMemoryFromSettings() {
            closeMemoSettings();
            addImportantMemory();
        }
        
        function saveMemoSettings() {
            if (!currentMemoContact) return;
            
            const enabled = document.getElementById('daily-summary-toggle').checked;
            const time = document.getElementById('daily-summary-time').value;
            
            let contacts = DB.getContacts();
            const i = contacts.findIndex(c => c.id === currentMemoContact.id);
            if (i !== -1) {
                if (!contacts[i].dailySummarySettings) {
                    contacts[i].dailySummarySettings = {};
                }
                contacts[i].dailySummarySettings.enabled = enabled;
                contacts[i].dailySummarySettings.time = time;
                DB.saveContacts(contacts);
                currentMemoContact = contacts[i];
            }
            
            // Êõ¥Êñ∞ÂÆöÊó∂Âô®
            setupDailySummaryTimers();
        }
        
        async function triggerManualDailySummary() {
            if (!currentMemoContact) return;
            
            const settings = DB.getSettings();
            if (!settings.key) return alert('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API Key');
            
            if (!confirm('Á°ÆÂÆöË¶ÅÊâßË°åÊØèÊó•ÊÄªÁªìÂêóÔºü\nËøôÂ∞ÜÊÄªÁªìËøáÂéª24Â∞èÊó∂ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂíåËÆ∞ÂøÜ„ÄÇ')) return;
            
            alert('Ê≠£Âú®ÁîüÊàêÊØèÊó•ÊÄªÁªìÔºåËØ∑Á®çÂÄô...');
            
            try {
                await executeDailySummary(currentMemoContact);
                alert('ÊØèÊó•ÊÄªÁªìÂ∑≤ÂÆåÊàêÔºÅ');
                renderMemoDetailList();
                
                // Êõ¥Êñ∞‰∏äÊ¨°ÊÄªÁªìÊó∂Èó¥ÊòæÁ§∫
                document.getElementById('last-summary-time').innerText = new Date().toLocaleString('zh-CN');
            } catch (e) {
                alert('ÊØèÊó•ÊÄªÁªìÂ§±Ë¥•Ôºö' + e.message);
            }
        }
        
        async function executeDailySummary(contact) {
            const settings = DB.getSettings();
            if (!settings.key) return;
            
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            // Ëé∑ÂèñËøáÂéª24Â∞èÊó∂ÁöÑËÅäÂ§©ËÆ∞ÂΩï
            const allChats = DB.getChats();
            const chatHistory = allChats[contact.id] || [];
            const recentChats = chatHistory.filter(msg => msg.timestamp && msg.timestamp >= yesterday.getTime());
            
            // Ëé∑ÂèñËøáÂéª24Â∞èÊó∂ÂÜÖÁîüÊàêÁöÑÊôÆÈÄöËÆ∞ÂøÜ
            const mems = DB.getMemories();
            const contactMems = mems[contact.id] || { important: [], normal: [] };
            
            // ÊâæÂá∫ÈúÄË¶ÅÊï¥ÂêàÁöÑÊôÆÈÄöËÆ∞ÂøÜÔºàÊúâÊó∂Èó¥Êà≥‰∏îÂú®24Â∞èÊó∂ÂÜÖÁöÑÔºâ
            const recentNormalMems = [];
            const recentNormalMemIndices = [];
            contactMems.normal.forEach((m, idx) => {
                // Ê£ÄÊü•ËÆ∞ÂøÜÊòØÂê¶ÊúâÊó∂Èó¥Êà≥ÔºåÊàñËÄÖÈÄöËøáÂÜÖÂÆπÂà§Êñ≠ÊòØÂê¶ÊòØ‰ªäÂ§©ÁöÑ
                if (m.timestamp && m.timestamp >= yesterday.getTime()) {
                    recentNormalMems.push(m);
                    recentNormalMemIndices.push(idx);
                }
            });
            
            if (recentChats.length === 0 && recentNormalMems.length === 0) {
                console.log('No recent content to summarize');
                return;
            }
            
            // ÊûÑÂª∫ËÅäÂ§©ËÆ∞ÂΩïÊñáÊú¨
            const chatText = recentChats.map(m => {
                const time = m.timestamp ? new Date(m.timestamp).toLocaleString('zh-CN', { hour12: false }) : "Êú™Áü•Êó∂Èó¥";
                const role = m.role === 'user' ? 'User' : contact.name;
                return `[${time}] ${role}: ${m.content}`;
            }).join('\n');
            
            // ÊûÑÂª∫Â∑≤ÊúâËÆ∞ÂøÜÊñáÊú¨
            const memText = recentNormalMems.map((m, i) => `ËÆ∞ÂøÜ${i+1}: ${m.content}`).join('\n');
            
            const nowStr = now.toLocaleString('zh-CN', { hour12: false });
            const yesterdayStr = yesterday.toLocaleString('zh-CN', { hour12: false });
            
            const prompt = `‰Ω†Áé∞Âú®ÊòØ ${contact.name}„ÄÇ
ËØ∑ÈòÖËØª‰ª•‰∏ãËøáÂéª24Â∞èÊó∂Ôºà${yesterdayStr} Ëá≥ ${nowStr}ÔºâÁöÑËÅäÂ§©ËÆ∞ÂΩïÂíåÂ∑≤ÊúâËÆ∞ÂøÜÔºåËøõË°åÊØèÊó•ÊÄªÁªì„ÄÇ

===== ËÅäÂ§©ËÆ∞ÂΩï =====
${chatText || 'ÔºàÊó†ËÅäÂ§©ËÆ∞ÂΩïÔºâ'}

===== Â∑≤ÊúâËÆ∞ÂøÜÁâáÊÆµ =====
${memText || 'ÔºàÊó†ËÆ∞ÂøÜÁâáÊÆµÔºâ'}

===== ‰ªªÂä°Ë¶ÅÊ±Ç =====
1. ‰ª•„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞„ÄëÔºàÊàë...ÔºâÊÄªÁªìËøô‰∏ÄÂ§©ÂèëÁîüÁöÑÊâÄÊúâÈáçË¶Å‰∫ã‰ª∂
2. Â∞ÜÊâÄÊúâËÆ∞ÂøÜÁâáÊÆµÊï¥Âêà‰∏∫‰∏ÄÊù°ÂÆåÊï¥ÁöÑÊØèÊó•ÊÄªÁªì
3. Âà§Êñ≠ÊòØÂê¶Êúâ„ÄêÈáçË¶ÅËÆ∞ÂøÜ„ÄëÔºàÈáçË¶ÅÁöÑÂÜ≥ÂÆö„ÄÅ‰∫∫ÁîüËΩ¨ÊäòÁÇπ„ÄÅÂÖ±ÂêåÂàõÈÄ†ÁöÑÁîúËúúÂõûÂøÜ„ÄÅÈáçÂ§ß‰∫ã‰ª∂Á≠âÔºâ
4. Â¶ÇÊûúÊúâÈáçË¶ÅËÆ∞ÂøÜÔºåËØ∑ÂçïÁã¨ÊèêÂèñÂá∫Êù•

‰∏•Ê†ºËøîÂõûJSONÊ†ºÂºèÔºö
{
    "dailySummary": "‰ªäÂ§©ÁöÑÂÆåÊï¥ÊÄªÁªìÂÜÖÂÆπ...",
    "keywords": ["ÂÖ≥ÈîÆËØç1", "ÂÖ≥ÈîÆËØç2"],
    "importantMemories": ["ÈáçË¶ÅËÆ∞ÂøÜ1ÔºàÂ¶ÇÊûúÊúâÔºâ", "ÈáçË¶ÅËÆ∞ÂøÜ2ÔºàÂ¶ÇÊûúÊúâÔºâ"],
    "hasContent": true/false
}

Ê≥®ÊÑèÔºö
- Â¶ÇÊûúËøô‰∏ÄÂ§©Ê≤°Êúâ‰ªª‰ΩïÊúâÊÑè‰πâÁöÑÂÜÖÂÆπÔºåhasContent ËøîÂõû falseÔºådailySummary ËøîÂõû "Êó†"
- importantMemories Êï∞ÁªÑÂèØ‰ª•‰∏∫Á©∫ÔºåÂè™ÊúâÁúüÊ≠£ÈáçË¶ÅÁöÑ‰∫ã‰ª∂ÊâçÊîæÂÖ•
- ÊØèÊó•ÊÄªÁªìÂ∫îËØ•ÊòØ‰∏ÄÊÆµËøûË¥ØÁöÑÂèôËø∞Ôºå‰∏çÊòØÁÆÄÂçïÁΩóÂàó`;

            try {
                const res = await fetch(`${settings.url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.key}` },
                    body: JSON.stringify({ model: settings.model, messages: [{ role: "user", content: prompt }], temperature: 0.5 })
                });
                
                const data = await res.json();
                if (data.choices?.length > 0) {
                    let raw = data.choices[0].message.content.trim().replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    try {
                        const result = JSON.parse(raw);
                        
                        if (result.hasContent && result.dailySummary && result.dailySummary !== "Êó†") {
                            const updatedMems = DB.getMemories();
                            if (!updatedMems[contact.id]) {
                                updatedMems[contact.id] = { important: [], normal: [] };
                            }
                            
                            // Âà†Èô§Â∑≤Êï¥ÂêàÁöÑÊôÆÈÄöËÆ∞ÂøÜÔºà‰ªéÂêéÂæÄÂâçÂà†ÔºåÈÅøÂÖçÁ¥¢ÂºïÈóÆÈ¢òÔºâ
                            recentNormalMemIndices.sort((a, b) => b - a).forEach(idx => {
                                updatedMems[contact.id].normal.splice(idx, 1);
                            });
                            
                            // Ê∑ªÂä†ÊØèÊó•ÊÄªÁªì‰Ωú‰∏∫Êñ∞ÁöÑÊôÆÈÄöËÆ∞ÂøÜ
                            const dateStr = now.toLocaleDateString('zh-CN');
                            updatedMems[contact.id].normal.push({
                                content: `„Äê${dateStr} ÊØèÊó•ÊÄªÁªì„Äë\n${result.dailySummary}`,
                                keywords: result.keywords || [],
                                timestamp: now.getTime(),
                                isDailySummary: true
                            });
                            
                            // Â¶ÇÊûúÊúâÈáçË¶ÅËÆ∞ÂøÜÔºåÊ∑ªÂä†Âà∞ÈáçË¶ÅÂõûÂøÜ‰∏≠
                            if (result.importantMemories && result.importantMemories.length > 0) {
                                result.importantMemories.forEach(impMem => {
                                    if (impMem && impMem.trim()) {
                                        updatedMems[contact.id].important.push({
                                            content: `„Äê${dateStr}„Äë${impMem}`,
                                            keywords: [],
                                            timestamp: now.getTime()
                                        });
                                    }
                                });
                            }
                            
                            DB.saveMemories(updatedMems);
                            
                            // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÁöÑ‰∏äÊ¨°ÊÄªÁªìÊó∂Èó¥
                            let contacts = DB.getContacts();
                            const idx = contacts.findIndex(c => c.id === contact.id);
                            if (idx !== -1) {
                                if (!contacts[idx].dailySummarySettings) {
                                    contacts[idx].dailySummarySettings = { enabled: false, time: '08:00' };
                                }
                                contacts[idx].dailySummarySettings.lastSummary = now.getTime();
                                DB.saveContacts(contacts);
                            }
                            
                            console.log('Daily summary generated:', result);
                        }
                    } catch (e) {
                        console.error('JSON parse failed:', e);
                        throw e;
                    }
                }
            } catch (e) {
                console.error('Daily summary generation failed:', e);
                throw e;
            }
        }
        
        // ÊØèÊó•ÊÄªÁªìÂÆöÊó∂Âô®ÁÆ°ÁêÜ
        let dailySummaryTimers = {};
        
        function setupDailySummaryTimers() {
            // Ê∏ÖÈô§ÊâÄÊúâÁé∞ÊúâÂÆöÊó∂Âô®
            Object.values(dailySummaryTimers).forEach(timer => clearTimeout(timer));
            dailySummaryTimers = {};
            
            const contacts = DB.getContacts();
            contacts.forEach(contact => {
                const settings = contact.dailySummarySettings;
                if (settings?.enabled && settings?.time) {
                    scheduleDailySummary(contact);
                }
            });
        }
        
        function scheduleDailySummary(contact) {
            const settings = contact.dailySummarySettings;
            if (!settings?.enabled || !settings?.time) return;
            
            const [hours, minutes] = settings.time.split(':').map(Number);
            const now = new Date();
            let targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0, 0);
            
            // Â¶ÇÊûú‰ªäÂ§©ÁöÑÊó∂Èó¥Â∑≤ËøáÔºåËÆæÁΩÆ‰∏∫ÊòéÂ§©
            if (targetTime <= now) {
                targetTime.setDate(targetTime.getDate() + 1);
            }
            
            // Ê£ÄÊü•‰ªäÂ§©ÊòØÂê¶Â∑≤ÁªèÊâßË°åËøá
            if (settings.lastSummary) {
                const lastSummaryDate = new Date(settings.lastSummary);
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                if (lastSummaryDate >= todayStart) {
                    // ‰ªäÂ§©Â∑≤ÁªèÊâßË°åËøáÔºåËÆæÁΩÆ‰∏∫ÊòéÂ§©
                    targetTime.setDate(targetTime.getDate() + 1);
                }
            }
            
            const delay = targetTime.getTime() - now.getTime();
            
            console.log(`Scheduled daily summary for ${contact.name} at ${targetTime.toLocaleString()}, delay: ${Math.round(delay/1000/60)} minutes`);
            
            dailySummaryTimers[contact.id] = setTimeout(async () => {
                console.log(`Executing scheduled daily summary for ${contact.name}`);
                try {
                    await executeDailySummary(contact);
                    // ÈáçÊñ∞Ë∞ÉÂ∫¶‰∏ã‰∏ÄÊ¨°
                    const updatedContacts = DB.getContacts();
                    const updatedContact = updatedContacts.find(c => c.id === contact.id);
                    if (updatedContact) {
                        scheduleDailySummary(updatedContact);
                    }
                } catch (e) {
                    console.error('Scheduled daily summary failed:', e);
                    // Âç≥‰ΩøÂ§±Ë¥•‰πüÈáçÊñ∞Ë∞ÉÂ∫¶
                    scheduleDailySummary(contact);
                }
            }, delay);
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ËÆæÁΩÆÂÆöÊó∂Âô®
        setupDailySummaryTimers();
        
        // ÊØèÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°ÊòØÂê¶ÈúÄË¶ÅÊâßË°åÊØèÊó•ÊÄªÁªìÔºà‰Ωú‰∏∫Â§áÁî®Êú∫Âà∂Ôºâ
        setInterval(() => {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            const contacts = DB.getContacts();
            contacts.forEach(async contact => {
                const settings = contact.dailySummarySettings;
                if (!settings?.enabled || settings?.time !== currentTime) return;
                
                // Ê£ÄÊü•‰ªäÂ§©ÊòØÂê¶Â∑≤ÁªèÊâßË°åËøá
                if (settings.lastSummary) {
                    const lastSummaryDate = new Date(settings.lastSummary);
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    if (lastSummaryDate >= todayStart) return; // ‰ªäÂ§©Â∑≤ÊâßË°å
                }
                
                console.log(`Backup timer: Executing daily summary for ${contact.name}`);
                try {
                    await executeDailySummary(contact);
                } catch (e) {
                    console.error('Backup daily summary failed:', e);
                }
            });
        }, 60000); // ÊØèÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°
        
        let currentSpyContact = null, currentSpyNPC = null;
        function renderSpyContactList() { const list = document.getElementById('spy-contact-list'); list.innerHTML = ''; DB.getContacts().forEach(c => { const d = document.createElement('div'); d.className = 'chat-list-item'; d.onclick = () => { currentSpyContact = c; openApp('app-spy-home'); document.getElementById('spy-home-title').innerText = c.name + "'s Phone"; }; d.innerHTML = `<img src="${c.avatar || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23ccc%22 width=%22100%22 height=%22100%22/></svg>'}" class="avatar-preview"><div class="contact-info"><div class="contact-name">${c.name}</div><div class="contact-persona">ÁÇπÂáªÊü•ÁúãÊâãÊú∫</div></div>`; list.appendChild(d); }); }
        function openSpyVK() { openApp('app-spy-vk'); renderSpyVKContacts(); }
        function openSpyMemos() { openApp('app-spy-memos'); renderSpyMemos(); }
        function renderSpyVKContacts() { const c = document.getElementById('spy-vk-contacts'); c.innerHTML = ''; const sd = DB.getSpyData(); const cs = (sd[currentSpyContact.id]?.vk_contacts) || []; if (cs.length === 0) { c.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ÊöÇÊó†ÔºåÁÇπÂáª + ÁîüÊàê</div>'; return; } cs.forEach((npc,i) => { const d = document.createElement('div'); d.className = 'chat-list-item'; d.onclick = () => { currentSpyNPC = npc; openApp('app-spy-vk-chat'); document.getElementById('spy-vk-chat-title').innerText = npc.name; renderSpyVKMessages(); }; d.innerHTML = `<div class="avatar-preview" style="background:#${Math.floor(Math.random()*16777215).toString(16)};display:flex;justify-content:center;align-items:center;color:#fff;font-weight:bold;">${npc.name[0]}</div><div class="contact-info"><div class="contact-name">${npc.name}</div><div class="contact-persona">ÁÇπÂáªÊü•Áúã</div></div>`; c.appendChild(d); }); }
        function renderSpyVKMessages() { const c = document.getElementById('spy-vk-messages'); c.innerHTML = ''; if (!currentSpyNPC?.messages) return; currentSpyNPC.messages.forEach(m => { const r = document.createElement('div'); r.className = `message-row ${m.role === 'me' ? 'user' : 'ai'}`; r.innerHTML = `<div class="message-bubble ${m.role === 'me' ? 'user' : 'ai'}">${m.content}</div>`; c.appendChild(r); }); }
        function renderSpyMemos() { const c = document.getElementById('spy-memo-list'); c.innerHTML = ''; const memos = (DB.getSpyData()[currentSpyContact.id]?.memos) || []; if (memos.length === 0) { c.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ÊöÇÊó†ÔºåÁÇπÂáª + ÁîüÊàê</div>'; return; } memos.forEach((m, i) => { const d = document.createElement('div'); d.className = 'memo-item'; d.innerHTML = `<span class="memo-date">${new Date().toLocaleDateString()}</span>${m}<span class="memo-delete" onclick="deleteSpyMemo(${i})">üóëÔ∏è</span>`; c.appendChild(d); }); }
        function deleteSpyMemo(i) { if(!confirm("Âà†Èô§Ôºü")) return; const sd = DB.getSpyData(); sd[currentSpyContact.id]?.memos?.splice(i, 1); DB.saveSpyData(sd); renderSpyMemos(); }
        function clearSpyVK() { if(!confirm("Ê∏ÖÁ©∫Ôºü")) return; const sd = DB.getSpyData(); if(sd[currentSpyContact.id]) sd[currentSpyContact.id].vk_contacts = []; DB.saveSpyData(sd); renderSpyVKContacts(); }
        function clearSpyMemos() { if(!confirm("Ê∏ÖÁ©∫Ôºü")) return; const sd = DB.getSpyData(); if(sd[currentSpyContact.id]) sd[currentSpyContact.id].memos = []; DB.saveSpyData(sd); renderSpyMemos(); }
        async function generateSpyChat() { if (!confirm("ÁîüÊàêËÅäÂ§©ËÆ∞ÂΩïÔºü")) return; await callSpyAPI('chat'); }
        async function generateSpyMemos() { if (!confirm("ÁîüÊàêÂ§áÂøòÂΩïÔºü")) return; await callSpyAPI('memo'); }
        async function refreshSpyVK() { if (!confirm("Âà∑Êñ∞Â∞ÜÊ∏ÖÁ©∫ÂΩìÂâçÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂπ∂ÈáçÊñ∞ÁîüÊàêÔºåÁ°ÆÂÆöÂêóÔºü")) return; const sd = DB.getSpyData(); if (sd[currentSpyContact.id]) sd[currentSpyContact.id].vk_contacts = []; DB.saveSpyData(sd); renderSpyVKContacts(); await callSpyAPI('chat'); }
        async function refreshSpyMemos() { if (!confirm("Âà∑Êñ∞Â∞ÜÊ∏ÖÁ©∫ÂΩìÂâçÊâÄÊúâÂ§áÂøòÂΩïÂπ∂ÈáçÊñ∞ÁîüÊàêÔºåÁ°ÆÂÆöÂêóÔºü")) return; const sd = DB.getSpyData(); if (sd[currentSpyContact.id]) sd[currentSpyContact.id].memos = []; DB.saveSpyData(sd); renderSpyMemos(); await callSpyAPI('memo'); }
        
        // --- Êñ∞Â¢ûÔºöÊµèËßàÂô®ÂíåÊó•ËÆ∞ÈÄªËæë ---
        function openSpyBrowser() { openApp('app-spy-browser'); renderSpyBrowser(); }
        function openSpyDiary() { openApp('app-spy-diary'); renderSpyDiaries(); }
        function openSpySettings() { openApp('app-spy-settings'); applySpyTheme(); }

        function renderSpyBrowser() {
            const c = document.getElementById('spy-browser-list');
            c.innerHTML = '';
            const history = (DB.getSpyData()[currentSpyContact.id]?.browser_history) || [];
            if (history.length === 0) {
                c.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ÊöÇÊó†ÊêúÁ¥¢ËÆ∞ÂΩïÔºåÁÇπÂáª + ÁîüÊàê</div>';
                return;
            }
            history.forEach(item => {
                const d = document.createElement('div');
                d.className = 'browser-item';
                d.innerText = item;
                c.appendChild(d);
            });
        }

        function renderSpyDiaries() {
            const c = document.getElementById('spy-diary-list');
            c.innerHTML = '';
            const diaries = (DB.getSpyData()[currentSpyContact.id]?.diaries) || [];
            
            const now = new Date();
            const todayPrefix = `${now.getFullYear()}Âπ¥${now.getMonth()+1}Êúà${now.getDate()}Êó•`;
            const hasToday = diaries.some(d => d.content.includes(todayPrefix));
            const addBtn = document.getElementById('spy-diary-add-btn');
            if (addBtn) addBtn.style.display = hasToday ? 'none' : 'inline-block';

            if (diaries.length === 0) {
                c.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ÊöÇÊó†Êó•ËÆ∞ÔºåÁÇπÂáª + ÁîüÊàê</div>';
                return;
            }

            // ÂÄíÂ∫èÊéíÂàóÔºöÊúÄÊñ∞ÁöÑÂú®ÊúÄ‰∏äÈù¢
            const reversedDiaries = [...diaries].reverse();
            let separatorRendered = false;

            reversedDiaries.forEach((entry, reverseIndex) => {
                const realIndex = diaries.length - 1 - reverseIndex;
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰ªäÊó•Êó•ËÆ∞
                const isToday = entry.content.includes(todayPrefix);

                // Â¶ÇÊûúÂΩìÂâçÊù°ÁõÆ‰∏çÊòØ‰ªäÊó•Êó•ËÆ∞Ôºå‰∏îËøòÊ≤°Ê∏≤ÊüìËøáÂàÜÂâ≤Á∫øÔºåÂàôÊèíÂÖ•ÂàÜÂâ≤Á∫ø
                if (!isToday && !separatorRendered) {
                    const sep = document.createElement('div');
                    sep.className = 'diary-separator';
                    sep.innerText = '‰ª•‰∏ã‰∏∫ÊõæÁªèÂÜô‰∏ãÁöÑÊó•ËÆ∞';
                    c.appendChild(sep);
                    separatorRendered = true;
                }

                const d = document.createElement('div');
                d.className = 'diary-entry';
                
                const lines = entry.content.split('\n');
                const title = lines[0];
                const body = lines.slice(1).join('\n');

                d.innerHTML = `
                    <div class="diary-date">${title}</div>
                    <div class="diary-content">${body.replace(/\n/g, '<br>')}</div>
                    <div class="diary-actions">
                        <span class="diary-action-btn" onclick="openSpyDiaryEdit(${realIndex})">ÁºñËæë</span>
                        <span class="diary-action-btn" style="color:#ff3b30" onclick="deleteSpyDiary(${realIndex})">Âà†Èô§</span>
                    </div>
                `;
                c.appendChild(d);
            });
        }

        async function generateSpyBrowser() { if (!confirm("ÁîüÊàêÊêúÁ¥¢ËÆ∞ÂΩïÔºü")) return; await callSpyAPI('browser'); }
        async function refreshSpyBrowser() { if (!confirm("Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞ÁîüÊàêÊêúÁ¥¢ËÆ∞ÂΩïÔºü")) return; clearSpyBrowser(false); await callSpyAPI('browser'); }
        function clearSpyBrowser(confirmFlag = true) { 
            if (confirmFlag && !confirm("Ê∏ÖÁ©∫ÊêúÁ¥¢ËÆ∞ÂΩïÔºü")) return; 
            const sd = DB.getSpyData(); 
            if (sd[currentSpyContact.id]) sd[currentSpyContact.id].browser_history = []; 
            DB.saveSpyData(sd); 
            renderSpyBrowser(); 
        }

        async function generateSpyDiary() { if (!confirm("ÂÜô‰∏ÄÁØáÊñ∞Êó•ËÆ∞Ôºü")) return; await callSpyAPI('diary'); }
        async function refreshSpyDiary() { 
            if (!confirm("Âà†Èô§ÊúÄÊñ∞‰∏ÄÁØáÊó•ËÆ∞Âπ∂ÈáçÊñ∞ÁîüÊàêÔºü")) return; 
            const sd = DB.getSpyData();
            if (sd[currentSpyContact.id] && sd[currentSpyContact.id].diaries && sd[currentSpyContact.id].diaries.length > 0) {
                sd[currentSpyContact.id].diaries.pop(); // Âà†Èô§ÊúÄÂêé‰∏ÄÁØá
                DB.saveSpyData(sd);
                renderSpyDiaries();
            }
            await callSpyAPI('diary'); 
        }
        function clearSpyDiaries() { 
            if (!confirm("Ê∏ÖÁ©∫ÊâÄÊúâÊó•ËÆ∞Ôºü")) return; 
            const sd = DB.getSpyData(); 
            if (sd[currentSpyContact.id]) sd[currentSpyContact.id].diaries = []; 
            DB.saveSpyData(sd); 
            renderSpyDiaries(); 
        }
        function deleteSpyDiary(index) {
            if (!confirm("Âà†Èô§ËøôÁØáÊó•ËÆ∞Ôºü")) return;
            const sd = DB.getSpyData();
            if (sd[currentSpyContact.id]?.diaries) {
                sd[currentSpyContact.id].diaries.splice(index, 1);
                DB.saveSpyData(sd);
                renderSpyDiaries();
            }
        }

        // --- Êü•Â≤óÊó•ËÆ∞‰∏ìÁî®ÁºñËæëÈÄªËæë ---
        let editingSpyDiaryIndex = -1;

        function openSpyDiaryEdit(index) {
            editingSpyDiaryIndex = index;
            const sd = DB.getSpyData();
            const entry = sd[currentSpyContact.id].diaries[index];
            document.getElementById('spy-diary-edit-textarea').value = entry.content;
            document.getElementById('spy-diary-edit-modal').classList.add('active');
        }

        function closeSpyDiaryEdit() {
            document.getElementById('spy-diary-edit-modal').classList.remove('active');
            editingSpyDiaryIndex = -1;
        }

        function saveSpyDiaryEdit() {
            if (editingSpyDiaryIndex === -1) return;
            const newContent = document.getElementById('spy-diary-edit-textarea').value;
            if (newContent) {
                const sd = DB.getSpyData();
                sd[currentSpyContact.id].diaries[editingSpyDiaryIndex].content = newContent;
                DB.saveSpyData(sd);
                renderSpyDiaries();
                closeSpyDiaryEdit();
            }
        }

        async function callSpyAPI(type) { 
            const s = DB.getSettings(); 
            if (!s.key) return alert('ËØ∑ÈÖçÁΩÆ API Key'); 
            
            const chatHistory = (DB.getChats()[currentSpyContact.id] || []).slice(-20).map(m => `${m.role === 'user' ? 'User' : 'Me'}: ${m.content}`).join('\n');
            
            let prompt = "";
            const now = new Date();
            const dateStr = `${now.getFullYear()}Âπ¥${now.getMonth()+1}Êúà${now.getDate()}Êó• ÊòüÊúü${['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][now.getDay()]}`;

            if (type === 'chat') {
                prompt = `‰Ω†Ê≠£Âú®ÊâÆÊºî ${currentSpyContact.name}„ÄÇ‰∫∫ËÆæÔºö${currentSpyContact.persona}„ÄÇÁîüÊàêJSONÊï∞ÁªÑÔºåÂåÖÂê´2-5‰∏™ÂØπË±°ÔºåÊØè‰∏™‰ª£Ë°®‰Ω†‰∏é‰∏Ä‰∏™NPCÁöÑËÅäÂ§©„ÄÇÊ†ºÂºèÔºö[{"name":"NPCÂêç","messages":[{"role":"npc","content":"..."},{"role":"me","content":"..."}]}]„ÄÇ‰∏çË¶ÅÂá∫Áé∞Áî®Êà∑„ÄÇÊØèÂØπËØù100Â≠ó‰ª•ÂÜÖ„ÄÇ‰∏•Ê†ºËøîÂõûJSONÔºå‰∏çË¶ÅMarkdown„ÄÇ`;
            } else if (type === 'memo') {
                prompt = `‰Ω†Ê≠£Âú®ÊâÆÊºî ${currentSpyContact.name}„ÄÇ‰∫∫ËÆæÔºö${currentSpyContact.persona}„ÄÇÊ†πÊçÆËÅäÂ§©ËÆ∞ÂΩïÔºö\n${chatHistory}\nÁîüÊàê3-6Êù°Â§áÂøòÂΩïÔºåÁ¨¨‰∏Ä‰∫∫Áß∞ÔºåÊØèÊù°‰∏çË∂Ö50Â≠ó„ÄÇÊ†ºÂºèÔºö["Â§áÂøòÂΩï1","Â§áÂøòÂΩï2"]„ÄÇ‰∏•Ê†ºËøîÂõûJSON„ÄÇ`;
            } else if (type === 'browser') {
                prompt = `‰Ω†Ê≠£Âú®ÊâÆÊºî ${currentSpyContact.name}„ÄÇ‰∫∫ËÆæÔºö${currentSpyContact.persona}„ÄÇ
                ËØ∑ÁîüÊàê 5 Âà∞ 10 Êù°ËØ•ËßíËâ≤ÁöÑÊâãÊú∫ÊµèËßàÂô®ÊêúÁ¥¢ËÆ∞ÂΩï„ÄÇ
                
                **ÈáçË¶ÅÁîüÊàêÈÄªËæë**Ôºö
                1. **Ê¥ª‰∫∫ÊÑü**ÔºöÊêúÁ¥¢ËÆ∞ÂΩïÂøÖÈ°ª‰∏ªË¶ÅÂü∫‰∫éËßíËâ≤ÁöÑ‰∏™‰∫∫Áà±Â•Ω„ÄÅÁîüÊ¥ªÁêê‰∫ã„ÄÅÂ∑•‰Ωú/Â≠¶‰π†ÈúÄÊ±Ç„ÄÅÁ™ÅÂèëÂ•áÊÉ≥ÊàñÂΩì‰∏ãÊµÅË°åÊ¢ó„ÄÇ‰∏çË¶ÅÂè™Âõ¥ÁªïÁî®Êà∑ËΩ¨„ÄÇ
                2. **ÂÖ≥Á≥ªÂà§ÂÆö**ÔºöËØ∑Ê†πÊçÆ‰ª•‰∏ãËÅäÂ§©ËÆ∞ÂΩïÂà§Êñ≠ËßíËâ≤‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÔºö
                   - Ëã•ÂÖ≥Á≥ª‰∫≤ÂØÜÔºàÊÉÖ‰æ£/ÂÆ∂‰∫∫ÔºâÔºöÂèØ‰ª•ÂåÖÂê´Á∫¶ 30% ÂÖ≥‰∫éÁî®Êà∑ÁöÑÊêúÁ¥¢ÔºàÂ¶ÇÈÄÅÁ§º„ÄÅÂÖ±ÂêåËØùÈ¢òÔºâ„ÄÇ
                   - Ëã•ÂÖ≥Á≥ª‰∏ÄËà¨ÊàñÈôåÁîü/ÊïåÂØπÔºöÂá†‰πé‰∏çË¶ÅÊêúÁ¥¢ÂÖ≥‰∫éÁî®Êà∑ÁöÑÂÜÖÂÆπÔºå‰∏ìÊ≥®‰∫éËßíËâ≤Ëá™Â∑±ÁöÑÁîüÊ¥ª„ÄÇ
                
                ÂèÇËÄÉËÅäÂ§©ËÆ∞ÂΩïÔºà‰ªÖÁî®‰∫éÂà§Êñ≠ÂÖ≥Á≥ªÂíåËøëÊúüÁä∂ÊÄÅÔºå‰∏çË¶ÅÁõ¥Êé•ÁÖßÊê¨ÂØπËØùÔºâÔºö
                ${chatHistory}
                
                Ê†ºÂºèÔºö["ÊêúÁ¥¢ÂÜÖÂÆπ1", "ÊêúÁ¥¢ÂÜÖÂÆπ2", ...]Ôºå‰∏•Ê†ºËøîÂõûJSONÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑ„ÄÇ`;
            } else if (type === 'diary') {
                prompt = `‰Ω†Ê≠£Âú®ÊâÆÊºî ${currentSpyContact.name}„ÄÇ‰∫∫ËÆæÔºö${currentSpyContact.persona}„ÄÇ
                ‰ªäÂ§©ÊòØ ${dateStr}„ÄÇ
                ËØ∑Ê†πÊçÆ‰ªäÂ§©‰Ω†‰∏éÁî®Êà∑ÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºö
                ${chatHistory}
                ÂÜô‰∏ÄÁØáÊó•ËÆ∞„ÄÇ
                
                **Ê†∏ÂøÉË¶ÅÊ±ÇÔºö**
                1. **Ê¥ª‰∫∫ÊÑü**ÔºöÊó•ËÆ∞ÂøÖÈ°ªÁúüÂÆû„ÄÅÁîüÊ¥ªÂåñ„ÄÇÈáçÁÇπËÆ∞ÂΩï‰ªäÂ§©ÂèëÁîü‰∫Ü‰ªÄ‰πà‰∫ã„ÄÅÂíåÁî®Êà∑ËÅä‰∫Ü‰ªÄ‰πàËØùÈ¢ò„ÄÅ‰ª•Âèä‰Ω†ÂØπËøô‰∫õ‰∫ãÁöÑÁúüÂÆûÊÑüÂèó„ÄÇ‰∏çË¶ÅÂÜôÊàêÊµÅÊ∞¥Ë¥¶ÔºåË¶ÅÊúâÊÉÖÊÑüÊ≥¢Âä®„ÄÇ
                2. **ÂÖ≥‰∫éÈò¥ÊöóÊÉ≥Ê≥ï**Ôºö<strike>Âà†Èô§Á∫øÂÜÖÂÆπ</strike> ‰ª£Ë°®‰Ω†ÂÜô‰∏ãÂêéÂèàÂêéÊÇî„ÄÅÊàñËÄÖ‰∏çÊÉ≥Ë¢´‰∫∫ÁúãÂà∞ÁöÑÈò¥Êöó/ÁßÅÂØÜÊÉ≥Ê≥ï„ÄÇ**ËØ∑Ê≥®ÊÑèÔºöËøôÂπ∂ÈùûÂøÖÈ°ªÔºÅ** Âè™ÊúâÂΩì‰Ω†ÁúüÁöÑÊúâÊÉ≥ÈöêËóèÁöÑÁßòÂØÜ„ÄÅÂØπÁî®Êà∑ÁöÑÁúüÂÆûÂêêÊßΩ„ÄÅÊàñËÄÖ‰∏ÄÈó™ËÄåËøáÁöÑË¥üÈù¢ÊÉÖÁª™Êó∂Êâç‰ΩøÁî®„ÄÇÂ¶ÇÊûú‰ªäÂ§©ÂæàÂºÄÂøÉÔºåÊàñËÄÖÊ≤°ÊúâÁâπÂà´Èò¥ÊöóÁöÑÊÉ≥Ê≥ïÔºåÂ∞±‰∏çË¶ÅÂº∫Ë°å‰ΩøÁî®Âà†Èô§Á∫ø„ÄÇËÆ©ÂÆÉËá™ÁÑ∂ÊµÅÈú≤„ÄÇ
                3. **ÈáçÁÇπÊ†áËÆ∞**Ôºö‰ΩøÁî® <mark>ÈáçÁÇπÂÜÖÂÆπ</mark> Ê†áËÆ∞‰Ω†ËßâÂæó‰ªäÂ§©ÊúÄÈáçË¶Å„ÄÅÊúÄÂºÄÂøÉÊàñÊúÄÈöæÂøòÁöÑ‰∫ãÊÉÖ„ÄÇ
                
                Ê†ºÂºèË¶ÅÊ±ÇÔºö
                1. Â≠óÊï∞ 200-500 Â≠ó„ÄÇ
                2. ÂøÖÈ°ª‰ª• "${dateStr}" ÂºÄÂ§¥ÔºåÁÑ∂ÂêéÊç¢Ë°åÂÜôÊ≠£Êñá„ÄÇ
                3. ‰∏•Ê†ºËøîÂõû JSON Ê†ºÂºèÔºåÂåÖÂê´‰∏Ä‰∏™ content Â≠óÊÆµÔºö{"content": "Êó•ËÆ∞ÂÆåÊï¥ÂÜÖÂÆπ..."}`;
            }

            try { 
                const res = await fetch(`${s.url}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${s.key}` }, body: JSON.stringify({ model: s.model, messages: [{ role: "system", content: prompt }], temperature: 0.7 }) }); 
                const data = await res.json(); 
                if (data.choices?.length > 0) { 
                    let c = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim(); 
                    const parsed = JSON.parse(c); 
                    const sd = DB.getSpyData(); 
                    if (!sd[currentSpyContact.id]) sd[currentSpyContact.id] = {}; 
                    
                    if (type === 'chat') { 
                        sd[currentSpyContact.id].vk_contacts = parsed; 
                        DB.saveSpyData(sd); 
                        renderSpyVKContacts(); 
                    } else if (type === 'memo') { 
                        sd[currentSpyContact.id].memos = parsed; 
                        DB.saveSpyData(sd); 
                        renderSpyMemos(); 
                    } else if (type === 'browser') {
                        sd[currentSpyContact.id].browser_history = parsed;
                        DB.saveSpyData(sd);
                        renderSpyBrowser();
                    } else if (type === 'diary') {
                        if (!sd[currentSpyContact.id].diaries) sd[currentSpyContact.id].diaries = [];
                        if (parsed.content) {
                            sd[currentSpyContact.id].diaries.push({ id: Date.now(), content: parsed.content });
                            DB.saveSpyData(sd);
                            renderSpyDiaries();
                        }
                    }
                } 
            } catch (e) { 
                alert("ÁîüÊàêÂ§±Ë¥•Ôºö" + e.message); 
            } 
        }
        
        let currentChatContact = null, longPressTimer, selectedMessageIndex = -1, isSelectionMode = false, selectedIndices = new Set(), pendingQuoteContent = null;
        function renderVKList() { const l = document.getElementById('vk-chat-list'); l.innerHTML = ''; DB.getContacts().forEach(c => { const d = document.createElement('div'); d.className = 'chat-list-item'; d.onclick = () => openChat(c); d.innerHTML = `<img src="${c.avatar || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23ccc%22 width=%22100%22 height=%22100%22/></svg>'}" class="avatar-preview"><div class="contact-info"><div class="contact-name">${c.name}</div><div class="contact-persona">ÁÇπÂáªÂºÄÂßãËÅäÂ§©</div></div>`; l.appendChild(d); }); }
        function openChat(c) { currentChatContact = c; document.getElementById('chat-interface').style.display = 'flex'; document.getElementById('chat-title').innerText = c.name; exitDeleteMode(); cancelQuote(); applyChatTheme(c); renderChatHistory(); }
        function applyChatTheme(contact) { const theme = contact.chatTheme || {}; const styleTag = document.getElementById('dynamic-chat-theme'); const chatInterface = document.getElementById('chat-interface'); if (theme.bgType === 'image' && theme.bgValue) { chatInterface.style.backgroundImage = `url(${theme.bgValue})`; chatInterface.style.backgroundColor = 'transparent'; } else { chatInterface.style.backgroundImage = 'none'; chatInterface.style.backgroundColor = theme.bgValue || '#f5f5f5'; } let css = ''; if (theme.userBubbleColor) css += `.message-bubble.user { background-color: ${theme.userBubbleColor} !important; color: #fff; } `; if (theme.userBubbleCSS) css += `.message-bubble.user { ${theme.userBubbleCSS} } `; if (theme.aiBubbleColor) css += `.message-bubble.ai { background-color: ${theme.aiBubbleColor} !important; } `; if (theme.aiBubbleCSS) css += `.message-bubble.ai { ${theme.aiBubbleCSS} } `; styleTag.innerHTML = css; }
        function closeChat() { document.getElementById('chat-interface').style.display = 'none'; currentChatContact = null; }
        let currentChatBgType = 'color';
        function openChatSettings() { if(!currentChatContact) return; document.getElementById('ctx-overlay').classList.add('active'); document.getElementById('chat-settings-modal').classList.add('active'); const us = currentChatContact.userSettings || {}; document.getElementById('user-setting-name').value = us.userName || ''; document.getElementById('user-setting-persona').value = us.userPersona || ''; document.getElementById('user-setting-avatar-preview').src = us.userAvatar || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23eee%22 width=%22100%22 height=%22100%22/></svg>'; document.getElementById('user-setting-avatar-url').value = (us.userAvatar?.startsWith('http') ? us.userAvatar : ''); document.getElementById('time-perception-toggle').checked = us.enableTimePerception || false; document.getElementById('auto-summary-toggle').checked = us.autoSummaryEnabled !== false; document.getElementById('summary-interval-input').value = us.summaryInterval || 20; document.getElementById('context-limit-input').value = us.contextLimit || 100; renderBindWorldBookList(); const theme = currentChatContact.chatTheme || {}; document.getElementById('theme-user-color').value = theme.userBubbleColor || '#007aff'; document.getElementById('theme-user-css').value = theme.userBubbleCSS || ''; document.getElementById('theme-ai-color').value = theme.aiBubbleColor || '#ffffff'; document.getElementById('theme-ai-css').value = theme.aiBubbleCSS || ''; currentChatBgType = theme.bgType || 'color'; switchChatBgType(currentChatBgType); if (currentChatBgType === 'color') document.getElementById('theme-chat-bg-color').value = theme.bgValue || '#f5f5f5'; if (currentChatBgType === 'image' && theme.bgValue && theme.bgValue.startsWith('http')) { document.getElementById('theme-chat-bg-url').value = theme.bgValue; } else { document.getElementById('theme-chat-bg-url').value = ''; } }
        function switchChatBgType(type) { currentChatBgType = type; document.getElementById('chat-bg-type-color').classList.toggle('active', type === 'color'); document.getElementById('chat-bg-type-image').classList.toggle('active', type === 'image'); document.getElementById('chat-bg-input-color').style.display = type === 'color' ? 'block' : 'none'; document.getElementById('chat-bg-input-image').style.display = type === 'image' ? 'block' : 'none'; }
        function renderBindWorldBookList() { const l = document.getElementById('bind-wb-list'); l.innerHTML = ''; const wb = DB.getWorldBook(); const local = wb.entries.filter(e => e.type === 'local'); const bound = currentChatContact.boundWorldBooks || []; if (local.length === 0) { l.innerHTML = '<div style="padding:10px;color:#999;font-size:12px;">ÊöÇÊó†Â±ÄÈÉ®‰∏ñÁïå‰π¶</div>'; return; } local.forEach(en => { const d = document.createElement('div'); d.className = 'bind-wb-item'; d.innerHTML = `<input type="checkbox" value="${en.id}" id="wb-bind-${en.id}" ${bound.includes(en.id.toString()) ? 'checked' : ''}><label for="wb-bind-${en.id}">${en.title}</label>`; l.appendChild(d); }); }
        function closeChatSettings() { saveChatUserSettings(); document.getElementById('ctx-overlay').classList.remove('active'); document.getElementById('chat-settings-modal').classList.remove('active'); }
        function previewUserAvatar(input) { if (input.files?.[0]) { const r = new FileReader(); r.onload = e => document.getElementById('user-setting-avatar-preview').src = e.target.result; r.readAsDataURL(input.files[0]); } }
        function saveChatBubbleSettings() { saveChatUserSettings().then(() => alert("Ê∞îÊ≥°ËÆæÁΩÆÂ∑≤‰øùÂ≠ò")); }
        function saveChatBgSettings() { saveChatUserSettings().then(() => alert("ËÅäÂ§©ËÉåÊôØÂ∑≤‰øùÂ≠ò")); }
        function saveChatUserSettings() { if(!currentChatContact) return Promise.resolve(); const userName = document.getElementById('user-setting-name').value; const userPersona = document.getElementById('user-setting-persona').value; const urlInput = document.getElementById('user-setting-avatar-url').value; const fileInput = document.getElementById('user-setting-avatar-input'); const enableTime = document.getElementById('time-perception-toggle').checked; const autoSummary = document.getElementById('auto-summary-toggle').checked; const summaryInterval = parseInt(document.getElementById('summary-interval-input').value) || 20; const contextLimit = parseInt(document.getElementById('context-limit-input').value) || 100; const boundIds = [...document.querySelectorAll('#bind-wb-list input:checked')].map(cb => cb.value); const userBubbleColor = document.getElementById('theme-user-color').value; const userBubbleCSS = document.getElementById('theme-user-css').value; const aiBubbleColor = document.getElementById('theme-ai-color').value; const aiBubbleCSS = document.getElementById('theme-ai-css').value; const bgUrlInput = document.getElementById('theme-chat-bg-url').value; const bgFileInput = document.getElementById('theme-chat-bg-file'); const processSave = (av, bgVal) => { let cs = DB.getContacts(); const i = cs.findIndex(c => c.id === currentChatContact.id); if (i !== -1) { cs[i].userSettings = { userName, userPersona, userAvatar: av || cs[i].userSettings?.userAvatar || '', enableTimePerception: enableTime, autoSummaryEnabled: autoSummary, summaryInterval: summaryInterval, contextLimit: contextLimit }; cs[i].boundWorldBooks = boundIds; let finalBgValue = bgVal; if (!finalBgValue) { if (currentChatBgType === 'color') { finalBgValue = document.getElementById('theme-chat-bg-color').value; } else { finalBgValue = cs[i].chatTheme?.bgValue || ''; } } cs[i].chatTheme = { userBubbleColor, userBubbleCSS, aiBubbleColor, aiBubbleCSS, bgType: currentChatBgType, bgValue: finalBgValue }; DB.saveContacts(cs); currentChatContact = cs[i]; applyChatTheme(currentChatContact); renderChatHistory(); } }; const handleAvatar = () => { return new Promise(resolve => { if (urlInput) resolve(urlInput); else if (fileInput.files?.[0]) { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsDataURL(fileInput.files[0]); } else resolve(null); }); }; const handleBg = () => { return new Promise(resolve => { if (currentChatBgType === 'color') { resolve(document.getElementById('theme-chat-bg-color').value); } else { if (bgUrlInput) resolve(bgUrlInput); else if (bgFileInput.files?.[0]) { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsDataURL(bgFileInput.files[0]); } else { resolve(null); } } }); }; return Promise.all([handleAvatar(), handleBg()]).then(([av, bg]) => { processSave(av, bg); }); }
        function applyThemeToAllChats() { if (!confirm("Á°ÆÂÆöË¶ÅÂ∞ÜÂΩìÂâçÁöÑÊ∞îÊ≥°Ê†∑ÂºèÂíåËÉåÊôØÂ∫îÁî®Âà∞ÊâÄÊúâËÅîÁ≥ª‰∫∫ÁöÑËÅäÂ§©‰∏≠ÂêóÔºü")) return; saveChatUserSettings().then(() => { const currentTheme = currentChatContact.chatTheme; if (!currentTheme) return; let contacts = DB.getContacts(); contacts.forEach(c => { c.chatTheme = JSON.parse(JSON.stringify(currentTheme)); }); DB.saveContacts(contacts); alert("Â∑≤Â∫îÁî®Âà∞ÊâÄÊúâËÅäÂ§©ÔºÅ"); }); }
        function clearCurrentHistory() { if (confirm('Ê∏ÖÁ©∫ËÆ∞ÂΩïÔºü')) { const c = DB.getChats(); c[currentChatContact.id] = []; DB.saveChats(c); renderChatHistory(); closeChatSettings(); } }
        function openTransferModal() { document.getElementById('transfer-modal').classList.add('active'); document.getElementById('transfer-amount').value = ''; document.getElementById('transfer-note').value = ''; }
        function closeTransferModal() { document.getElementById('transfer-modal').classList.remove('active'); }
        function sendTransfer() { const amt = document.getElementById('transfer-amount').value, note = document.getElementById('transfer-note').value; if (!amt) return alert("ËØ∑ËæìÂÖ•ÈáëÈ¢ù"); const c = DB.getChats(); if (!c[currentChatContact.id]) c[currentChatContact.id] = []; c[currentChatContact.id].push({ role: 'user', type: 'transfer', amount: amt, note: note, status: 'pending', timestamp: Date.now() }); DB.saveChats(c); renderChatHistory(); closeTransferModal(); }
        
        function formatChatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.getDate() === now.getDate() && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
            const isYesterday = date.getDate() === yesterday.getDate() && date.getMonth() === yesterday.getMonth() && date.getFullYear() === yesterday.getFullYear();
            const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            if (isToday) return timeStr;
            if (isYesterday) return `Êò®Êó• ${timeStr}`;
            return `${date.getMonth() + 1}Êúà${date.getDate()}Êó• ${timeStr}`;
        }

        function renderChatHistory() { 
            const fullChat = DB.getChats()[currentChatContact.id] || []; 
            const h = document.getElementById('chat-history'); 
            const callHistory = document.getElementById('call-history');
            const isCallActive = document.getElementById('call-screen').classList.contains('active');

            if (h) h.innerHTML = '';
            if (isCallActive && callHistory) callHistory.innerHTML = '';

            // ‰øÆÂ§çÔºöÂàõÂª∫ÂåÖÂê´ÂéüÂßãÁ¥¢ÂºïÁöÑÁ∫ø‰∏äÊ∂àÊÅØÊï∞ÁªÑ
            const onlineMsgs = fullChat.map((msg, originalIndex) => ({ msg, originalIndex })).filter(item => item.msg.mode !== 'offline'); 
            const aiAv = currentChatContact.avatar || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23ccc%22 width=%22100%22 height=%22100%22/></svg>'; 
            const userAv = currentChatContact.userSettings?.userAvatar || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23007aff%22 width=%22100%22 height=%22100%22/></svg>'; 
            
            let lastMsgTime = 0; 

            onlineMsgs.forEach((item, i) => { 
                const msg = item.msg;
                const originalIndex = item.originalIndex;
                if (msg.timestamp) {
                    const diff = msg.timestamp - lastMsgTime;
                    if (lastMsgTime === 0 || diff > 5 * 60 * 1000) {
                        const tsDiv = document.createElement('div');
                        tsDiv.className = 'chat-timestamp';
                        tsDiv.innerText = formatChatTime(msg.timestamp);
                        if (h && document.getElementById('chat-interface').style.display !== 'none') h.appendChild(tsDiv);
                        if (isCallActive && callHistory && msg.timestamp >= currentCallStartTime) callHistory.appendChild(tsDiv.cloneNode(true));
                        lastMsgTime = msg.timestamp;
                    }
                }

                if (msg.isRetracted) {
                    const retractedDiv = document.createElement('div');
                    retractedDiv.className = 'retracted-message-bar';
                    const name = msg.role === 'user' ? (currentChatContact.userSettings?.userName || 'Êàë') : currentChatContact.name;
                    retractedDiv.innerText = `„Äê${name}„ÄëÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ`;
                    
                    if (h && document.getElementById('chat-interface').style.display !== 'none') h.appendChild(retractedDiv);
                    if (isCallActive && callHistory && msg.timestamp >= currentCallStartTime) callHistory.appendChild(retractedDiv.cloneNode(true));
                    return; 
                }

                const row = document.createElement('div'); 
                row.className = `message-row ${msg.role === 'user' ? 'user' : 'ai'}`; 
                if (msg.type === 'call_end') { 
                    row.className = 'message-row'; 
                    row.style.justifyContent = 'center'; 
                    const sysMsg = document.createElement('div'); 
                    sysMsg.className = 'system-message-bar'; 
                    sysMsg.innerText = msg.content; 
                    row.appendChild(sysMsg); 
                } else {
                    const cb = document.createElement('div'); 
                    cb.className = 'selection-checkbox'; 
                    // ‰øÆÂ§çÔºö‰ΩøÁî®ÂéüÂßãÁ¥¢ÂºïÊù•Ê£ÄÊü•ÈÄâ‰∏≠Áä∂ÊÄÅ
                    if (selectedIndices.has(originalIndex)) cb.classList.add('checked'); 
                    row.appendChild(cb); 
                    if (msg.role === 'assistant') { 
                        const img = document.createElement('img'); 
                        img.src = aiAv; 
                        img.className = 'chat-avatar-small'; 
                        row.appendChild(img); 
                    } 
                    const bc = document.createElement('div'); 
                    bc.className = 'bubble-container'; 
                    if (msg.type === 'transfer') { 
                        const b = document.createElement('div'); 
                        b.className = 'message-bubble transfer-bubble'; 
                        let st = "Á≠âÂæÖÁ°ÆËÆ§", ic = "üí∞"; 
                        if (msg.status === 'accepted') { st = "Â∑≤Êî∂Ê¨æ"; ic = "‚úÖ"; b.classList.add('accepted'); } 
                        if (msg.status === 'rejected') { st = "Â∑≤ÈÄÄËøò"; ic = "‚Ü©Ô∏è"; b.classList.add('rejected'); } 
                        b.innerHTML = `<div class="transfer-header"><div class="transfer-icon">${ic}</div><div class="transfer-info"><span class="transfer-amount">¬•${msg.amount}</span><span class="transfer-status">${st}</span></div></div><div class="transfer-footer">ËΩ¨Ë¥¶Â§áÊ≥®: ${msg.note || 'Êó†'}</div>`; 
                        bc.appendChild(b); 
                    } else if (msg.type === 'transfer_receipt') { 
                        const b = document.createElement('div'); 
                        b.className = 'message-bubble transfer-bubble'; 
                        if (msg.status === 'rejected') b.classList.add('rejected'); else b.classList.add('accepted'); 
                        const title = msg.status === 'accepted' ? "Â∑≤Êî∂Ê¨æ" : "Â∑≤ÈÄÄËøò", ic = msg.status === 'accepted' ? "‚úÖ" : "‚Ü©Ô∏è", desc = msg.status === 'accepted' ? "Â∑≤Êé•ÂèóÊÇ®ÁöÑËΩ¨Ë¥¶" : "Â∑≤ÊãíÊî∂ÊÇ®ÁöÑËΩ¨Ë¥¶"; 
                        b.innerHTML = `<div class="transfer-header"><div class="transfer-icon">${ic}</div><div class="transfer-info"><span class="transfer-amount">${title}</span><span class="transfer-status">¬•${msg.amount}</span></div></div><div class="transfer-footer">${desc}</div>`; 
                        bc.appendChild(b); 
                    } else if (msg.type === 'sticker') {
                        // Ë°®ÊÉÖÂåÖÊ∂àÊÅØ
                        const b = document.createElement('div');
                        b.className = `message-bubble sticker-bubble ${msg.role === 'user' ? 'user' : 'ai'}`;
                        b.innerHTML = `<img src="${msg.stickerUrl}" alt="${msg.stickerDesc}" title="${msg.stickerDesc}">`;
                        bc.appendChild(b);
                        // ‰∏∫Ë°®ÊÉÖÂåÖÊ∞îÊ≥°Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂
                        if (!isSelectionMode) {
                            b.addEventListener('touchstart', () => startLongPress(originalIndex));
                            b.addEventListener('touchend', cancelLongPress);
                            b.addEventListener('mousedown', () => startLongPress(originalIndex));
                            b.addEventListener('mouseup', cancelLongPress);
                            b.addEventListener('contextmenu', e => e.preventDefault());
                        }
                    } else { 
                        const b = document.createElement('div'); 
                        b.className = `message-bubble ${msg.role === 'user' ? 'user' : 'ai'}`; 
                        if (msg.quote) { 
                            const q = document.createElement('div'); 
                            q.className = 'quote-block-in-msg'; 
                            q.innerText = msg.quote; 
                            b.appendChild(q); 
                        } 
                        const t = document.createElement('span'); 
                        t.innerText = msg.content; 
                        b.appendChild(t); 
                        bc.appendChild(b);
                        if (!isSelectionMode) { 
                            // ‰øÆÂ§çÔºö‰ΩøÁî®ÂéüÂßãÁ¥¢ÂºïËÄå‰∏çÊòØËøáÊª§ÂêéÁöÑÁ¥¢Âºï
                            b.addEventListener('touchstart', () => startLongPress(originalIndex)); 
                            b.addEventListener('touchend', cancelLongPress); 
                            b.addEventListener('mousedown', () => startLongPress(originalIndex)); 
                            b.addEventListener('mouseup', cancelLongPress); 
                            b.addEventListener('contextmenu', e => e.preventDefault()); 
                        } 
                    } 
                    row.appendChild(bc); 
                    if (msg.role === 'user') { 
                        const img = document.createElement('img'); 
                        img.src = userAv; 
                        img.className = 'chat-avatar-small'; 
                        row.appendChild(img); 
                    } 
                    // ‰øÆÂ§çÔºö‰ΩøÁî®ÂéüÂßãÁ¥¢ÂºïËøõË°åÈÄâÊã©Êìç‰Ωú
                    if (isSelectionMode) row.onclick = () => toggleSelection(originalIndex); 
                }

                if (h && document.getElementById('chat-interface').style.display !== 'none') h.appendChild(row); 
                if (isCallActive && callHistory && msg.timestamp >= currentCallStartTime) callHistory.appendChild(row.cloneNode(true));
            }); 
            
            if (h && !isSelectionMode) h.scrollTop = h.scrollHeight; 
            if (isCallActive && callHistory) callHistory.scrollTop = callHistory.scrollHeight;

            const offlineHistory = document.getElementById('offline-history'); 
            if (offlineHistory && document.getElementById('offline-mode').classList.contains('active')) { 
                offlineHistory.innerHTML = ''; 
                fullChat.forEach((msg, index) => { 
                    if (msg.mode !== 'offline') return; 
                    const div = document.createElement('div'); 
                    div.className = `offline-msg-block ${msg.role === 'user' ? 'user' : (msg.role === 'system' ? 'system' : 'ai')}`; 
                    let content = msg.content; 
                    if (msg.role === 'user') { 
                        div.innerText = `ÊàëÔºö${content}`; 
                    } else if (msg.role === 'system') { 
                        div.innerText = `[Á≥ªÁªü] ${content}`; 
                    } else { 
                        content = content.replace(/\|\|\|/g, '\n\n'); 
                        div.innerText = content; 
                    } 
                    offlineHistory.appendChild(div); 
                    
                    // ‰øÆÂ§çÔºöÁ°Æ‰øùÁî®Êà∑Ê∂àÊÅØ‰πüÊúâÊìç‰ΩúÊ†è
                    if (msg.role === 'user' || msg.role === 'assistant') { 
                        const actionBar = document.createElement('div'); 
                        actionBar.className = 'offline-action-bar'; 
                        const editBtn = document.createElement('button'); 
                        editBtn.className = 'offline-action-btn'; 
                        editBtn.innerText = 'ÁºñËæë'; 
                        editBtn.onclick = () => editOfflineMsg(index); 
                        actionBar.appendChild(editBtn); 
                        const delBtn = document.createElement('button'); 
                        delBtn.className = 'offline-action-btn delete'; 
                        delBtn.innerText = 'Âà†Èô§'; 
                        delBtn.onclick = () => deleteOfflineMsg(index); 
                        actionBar.appendChild(delBtn); 
                        if (msg.role === 'assistant') { 
                            const retryBtn = document.createElement('button'); 
                            retryBtn.className = 'offline-action-btn'; 
                            retryBtn.innerText = 'ÈáçËØï'; 
                            retryBtn.onclick = () => retryOfflineMsg(index); 
                            actionBar.appendChild(retryBtn); 
                        } 
                        // Âè™ÊúâAIÊ∂àÊÅØÊâçÊúâÁªßÁª≠ÊåâÈíÆ
                        if (msg.role === 'assistant') {
                            const continueBtn = document.createElement('button'); 
                            continueBtn.className = 'offline-action-btn'; 
                            continueBtn.innerText = 'ÁªßÁª≠'; 
                            continueBtn.onclick = () => continueOfflineMsg(); 
                            actionBar.appendChild(continueBtn); 
                        }
                        offlineHistory.appendChild(actionBar); 
                    } 
                }); 
                offlineHistory.scrollTop = offlineHistory.scrollHeight; 
            } 
        }
        
        // --- Á∫ø‰∏ãÊ®°ÂºèÁºñËæëÁõ∏ÂÖ≥ÈÄªËæë ---
        let editingOfflineIndex = -1;

        function editOfflineMsg(index) { 
            editingOfflineIndex = index;
            const c = DB.getChats(); 
            const msg = c[currentChatContact.id][index]; 
            document.getElementById('offline-edit-textarea').value = msg.content;
            document.getElementById('offline-edit-modal').classList.add('active');
        }

        function closeOfflineEditModal() {
            document.getElementById('offline-edit-modal').classList.remove('active');
            editingOfflineIndex = -1;
        }

        function saveOfflineEditedMsg() {
            if (editingOfflineIndex === -1) return;
            const newContent = document.getElementById('offline-edit-textarea').value;
            if (newContent !== null) {
                const c = DB.getChats();
                c[currentChatContact.id][editingOfflineIndex].content = newContent;
                DB.saveChats(c);
                renderChatHistory();
                closeOfflineEditModal();
            }
        }

        function deleteOfflineMsg(index) { if (confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü")) { const c = DB.getChats(); c[currentChatContact.id].splice(index, 1); DB.saveChats(c); renderChatHistory(); } }
        function retryOfflineMsg(index) { if (confirm("Âà†Èô§Ê≠§ÂõûÂ§çÂπ∂ÈáçÊñ∞ÁîüÊàêÔºü")) { const c = DB.getChats(); c[currentChatContact.id].splice(index, 1); DB.saveChats(c); renderChatHistory(); triggerAIResponse(); } }
        function continueOfflineMsg() { triggerAIResponse(); }
        function startLongPress(i) { longPressTimer = setTimeout(() => showContextMenu(i), 600); }
        function cancelLongPress() { clearTimeout(longPressTimer); }
        
        function showContextMenu(i) { 
            selectedMessageIndex = i; 
            const chat = DB.getChats()[currentChatContact.id];
            const msg = chat[i];
            const retractBtn = document.getElementById('ctx-retract-btn');
            if (msg.role === 'user' && !msg.isRetracted) {
                retractBtn.style.display = 'block';
            } else {
                retractBtn.style.display = 'none';
            }
            document.getElementById('ctx-overlay').classList.add('active'); 
            document.getElementById('msg-context-menu').classList.add('active'); 
        }
        
        function closeContextMenu() { document.getElementById('ctx-overlay').classList.remove('active'); document.getElementById('msg-context-menu').classList.remove('active'); }
        function triggerQuote() { const c = DB.getChats()[currentChatContact.id], m = c[selectedMessageIndex]; if (m.type || m.isRetracted) return alert("Êó†Ê≥ïÂºïÁî®"); pendingQuoteContent = m.content; document.getElementById('quote-preview-area').style.display = 'flex'; document.getElementById('quote-preview-content').innerText = pendingQuoteContent; closeContextMenu(); }
        function cancelQuote() { pendingQuoteContent = null; document.getElementById('quote-preview-area').style.display = 'none'; }
        function triggerEdit() { const c = DB.getChats()[currentChatContact.id], m = c[selectedMessageIndex]; if (m.type || m.isRetracted) return alert("Êó†Ê≥ïÁºñËæë"); document.getElementById('edit-msg-textarea').value = m.content; document.getElementById('edit-msg-modal').classList.add('active'); closeContextMenu(); }
        function closeEditModal() { document.getElementById('edit-msg-modal').classList.remove('active'); }
        function saveEditedMessage() { const n = document.getElementById('edit-msg-textarea').value; if (n) { const c = DB.getChats(); c[currentChatContact.id][selectedMessageIndex].content = n; DB.saveChats(c); renderChatHistory(); closeEditModal(); } }
        
        function triggerRetract() {
            const c = DB.getChats();
            const msg = c[currentChatContact.id][selectedMessageIndex];
            if (msg.role !== 'user') return alert("Âè™ËÉΩÊí§ÂõûËá™Â∑±ÁöÑÊ∂àÊÅØ");
            if (confirm("Á°ÆÂÆöÊí§ÂõûËøôÊù°Ê∂àÊÅØÂêóÔºü")) {
                c[currentChatContact.id][selectedMessageIndex].isRetracted = true;
                DB.saveChats(c);
                renderChatHistory();
                closeContextMenu();
            }
        }

        function triggerDeleteMode() { closeContextMenu(); isSelectionMode = true; selectedIndices.clear(); document.getElementById('chat-history').classList.add('selection-mode'); document.getElementById('delete-mode-bar').classList.add('active'); renderChatHistory(); }
        function exitDeleteMode() { isSelectionMode = false; selectedIndices.clear(); document.getElementById('chat-history').classList.remove('selection-mode'); document.getElementById('delete-mode-bar').classList.remove('active'); renderChatHistory(); }
        function toggleSelection(i) { if (selectedIndices.has(i)) selectedIndices.delete(i); else selectedIndices.add(i); renderChatHistory(); }
        function confirmDeleteMessages() { if (selectedIndices.size === 0) return exitDeleteMode(); if (confirm(`Âà†Èô§ ${selectedIndices.size} Êù°Ôºü`)) { const c = DB.getChats(); c[currentChatContact.id] = c[currentChatContact.id].filter((_, i) => !selectedIndices.has(i)); DB.saveChats(c); exitDeleteMode(); } }
        function saveMessage(role, content, quote = null, thought = null) { const c = DB.getChats(); if (!c[currentChatContact.id]) c[currentChatContact.id] = []; const isOffline = document.getElementById('offline-mode').classList.contains('active'); const mode = isOffline ? 'offline' : 'online'; const o = { role, content, timestamp: Date.now(), mode: mode }; if (quote) o.quote = quote; if (thought) o.thought = thought; c[currentChatContact.id].push(o); DB.saveChats(c); renderChatHistory(); }
        
        // --- ÂõûËΩ¶ÂèëÈÄÅÂäüËÉΩ ---
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Èò≤Ê≠¢Êç¢Ë°å
                sendMessage();
            }
        }

        function sendMessage() { const isCallActive = document.getElementById('call-screen').classList.contains('active'); const isOfflineActive = document.getElementById('offline-mode').classList.contains('active'); let inputId = 'message-input'; if (isCallActive) inputId = 'call-message-input'; if (isOfflineActive) inputId = 'offline-message-input'; const input = document.getElementById(inputId); const t = input.value.trim(); if (!t) return; saveMessage('user', t, pendingQuoteContent); input.value = ''; cancelQuote(); if (isOfflineActive) { document.getElementById('offline-typing-indicator').style.display = 'block'; triggerAIResponse(); } }
        function regenerateLastResponse() { if (!currentChatContact) return; const c = DB.getChats(); let chat = c[currentChatContact.id] || []; if (chat.length === 0) return; let removed = false; while (chat.length > 0 && chat[chat.length - 1].role === 'assistant') { chat.pop(); removed = true; } if (removed) { DB.saveChats(c); renderChatHistory(); triggerAIResponse(); } else alert("ÊúÄÂêé‰∏ÄÊù°‰∏çÊòØAIÊ∂àÊÅØ"); }
        function continueChat() { triggerAIResponse(); }
        let callTimerInterval = null;
        let callSeconds = 0;
        function startCall() { 
            if (!currentChatContact) return; 
            const settings = DB.getSettings(); 
            if (!settings.key) return alert('ËØ∑ÈÖçÁΩÆ API Key'); 
            currentCallStartTime = Date.now();
            document.getElementById('call-screen').classList.add('active'); 
            document.getElementById('call-avatar').src = currentChatContact.avatar || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23ccc%22 width=%22100%22 height=%22100%22/></svg>'; 
            document.getElementById('call-status').innerText = "ÂØπÊñπÊ≠£Âú®ÊÄùËÄÉ‰∏≠..."; 
            document.getElementById('call-timer').innerText = "00:00"; 
            callSeconds = 0; 
            if (callTimerInterval) clearInterval(callTimerInterval); 
            callTimerInterval = setInterval(() => { callSeconds++; const m = Math.floor(callSeconds / 60).toString().padStart(2, '0'); const s = (callSeconds % 60).toString().padStart(2, '0'); document.getElementById('call-timer').innerText = `${m}:${s}`; }, 1000); 
            triggerCallStartResponse(); 
            renderChatHistory(); 
        }
        function endCall() { if (callTimerInterval) { clearInterval(callTimerInterval); callTimerInterval = null; } document.getElementById('call-screen').classList.remove('active'); if (callSeconds > 0 && currentChatContact) { const userName = currentChatContact.userSettings?.userName || "Áî®Êà∑"; const c = DB.getChats(); if (!c[currentChatContact.id]) c[currentChatContact.id] = []; c[currentChatContact.id].push({ role: 'system', type: 'call_end', content: `ÈÄöËØùÂ∑≤ÁªìÊùüÔºå${userName} Â∑≤ÊåÇÊñ≠ÁîµËØù`, timestamp: Date.now(), mode: 'online' }); DB.saveChats(c); renderChatHistory(); } callSeconds = 0; }
        async function triggerCallStartResponse() { const settings = DB.getSettings(); let systemContent = `${settings.prompt}\n\n[ËßíËâ≤‰ø°ÊÅØ]\nÂêçÂ≠óÔºö${currentChatContact.name}\n‰∫∫ËÆæÔºö${currentChatContact.persona}`; const userSettings = currentChatContact.userSettings || {}; if (userSettings.userName) systemContent += `\n\n[Áî®Êà∑‰ø°ÊÅØ]\nÂêçÂ≠óÔºö${userSettings.userName}`; systemContent += `\n\n===== „ÄêËØ≠Èü≥ÈÄöËØùÊé•Âê¨Ê®°Âºè„Äë =====\nÁî®Êà∑ÂàöÂàöÁªô‰Ω†Êã®Êâì‰∫ÜËØ≠Èü≥ÁîµËØùÔºå‰Ω†Êé•ÈÄö‰∫ÜÁîµËØù„ÄÇ\nËØ∑ÁîüÊàê‰∏ÄÊÆµÊé•Âê¨ÁîµËØùÊó∂ÁöÑÂõûÂ§ç„ÄÇÂõûÂ§çÂøÖÈ°ªÂåÖÂê´ÂøÉÂ£∞„ÄÇ\n**ÈáçË¶ÅËßÑÂàô**Ôºö\n1. Áé∞Âú®ÊòØËØ≠Èü≥ÈÄöËØùÔºåËØ∑ÂÉèÊâìÁîµËØù‰∏ÄÊ†∑ÂõûÂ§ç„ÄÇ\n2. **‰∏•Á¶Å**‰ΩøÁî® '|||' ÂàÜÈöîÊ∂àÊÅØ„ÄÇ\n3. ‰∏ÄÊ¨°Âè™ÂõûÂ§ç‰∏ÄÊÆµËØùÔºåÂ≠óÊï∞ÈôêÂà∂Âú®150Â≠ó‰ª•ÂÜÖ„ÄÇ\nÊ†ºÂºèÔºö[THOUGHTS: ÂøÉÂ£∞ÂÜÖÂÆπ] ||| ‰Ω†ÁöÑÂè£ËØ≠ÂõûÂ§ç„ÄÇ`; const messages = [{ role: "system", content: systemContent }]; try { const response = await fetch(`${settings.url}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.key}` }, body: JSON.stringify({ model: settings.model, messages: messages, temperature: 0.7 }) }); const data = await response.json(); if (data.choices && data.choices.length > 0) { let content = data.choices[0].message.content; let extractedThought = null; const thoughtMatch = content.match(/^\[THOUGHTS:(.*?)\]/s); if (thoughtMatch) { extractedThought = thoughtMatch[1].trim(); content = content.replace(thoughtMatch[0], '').trim(); content = content.replace(/^\|\|\|\s*/, '').trim(); } document.getElementById('call-status').innerText = "ÈÄöËØù‰∏≠"; if (content && content.trim()) { saveMessage('assistant', content, null, extractedThought); } } } catch (error) { document.getElementById('call-status').innerText = "ËøûÊé•Â§±Ë¥•"; alert('ÈÄöËØùËøûÊé•ÈîôËØØ: ' + error.message); } }
        function openOfflineMode() { if (!currentChatContact) return; document.getElementById('offline-mode').classList.add('active'); const settings = currentChatContact.offlineSettings || {}; if (settings.bg) { document.getElementById('offline-mode').style.backgroundImage = `url(${settings.bg})`; } else { document.getElementById('offline-mode').style.backgroundImage = 'none'; } renderChatHistory(); }
        function exitOfflineMode() { document.getElementById('offline-mode').classList.remove('active'); document.getElementById('offline-typing-indicator').style.display = 'none'; closeOfflineSettings(); }
        function openOfflineSettings() { 
            const settings = currentChatContact.offlineSettings || { min: 500, max: 700, style: '', bg: '', retell: false, interrupt: false, perspective: 'first_user' }; 
            document.getElementById('offline-min-len').value = settings.min; 
            document.getElementById('offline-max-len').value = settings.max; 
            document.getElementById('offline-style-prompt').value = settings.style; 
            document.getElementById('offline-bg-url').value = settings.bg && settings.bg.startsWith('http') ? settings.bg : ''; 
            
            // Âä†ËΩΩÂ§çËø∞ËÆæÁΩÆ
            document.getElementById('offline-retell-yes').classList.toggle('active', settings.retell === true);
            document.getElementById('offline-retell-no').classList.toggle('active', settings.retell !== true);
            
            // Âä†ËΩΩÊä¢ËØùËÆæÁΩÆ
            document.getElementById('offline-interrupt-yes').classList.toggle('active', settings.interrupt === true);
            document.getElementById('offline-interrupt-no').classList.toggle('active', settings.interrupt !== true);
            
            // Âä†ËΩΩ‰∫∫Áß∞ËÆæÁΩÆ
            document.getElementById('offline-perspective').value = settings.perspective || 'first_user';
            
            document.getElementById('offline-settings-modal').classList.add('active'); 
            document.getElementById('ctx-overlay').classList.add('active'); 
        }
        
        // Â§çËø∞ËÆæÁΩÆÂáΩÊï∞
        function setOfflineRetell(value) {
            document.getElementById('offline-retell-yes').classList.toggle('active', value === true);
            document.getElementById('offline-retell-no').classList.toggle('active', value !== true);
        }
        
        // Êä¢ËØùËÆæÁΩÆÂáΩÊï∞
        function setOfflineInterrupt(value) {
            document.getElementById('offline-interrupt-yes').classList.toggle('active', value === true);
            document.getElementById('offline-interrupt-no').classList.toggle('active', value !== true);
        }
        function closeOfflineSettings() { document.getElementById('offline-settings-modal').classList.remove('active'); document.getElementById('ctx-overlay').classList.remove('active'); }
        function saveOfflineSettings() { 
            const min = parseInt(document.getElementById('offline-min-len').value) || 500; 
            const max = parseInt(document.getElementById('offline-max-len').value) || 700; 
            const style = document.getElementById('offline-style-prompt').value; 
            const bgUrl = document.getElementById('offline-bg-url').value; 
            const bgFile = document.getElementById('offline-bg-file'); 
            
            // Ëé∑ÂèñÂ§çËø∞ÂíåÊä¢ËØùËÆæÁΩÆ
            const retell = document.getElementById('offline-retell-yes').classList.contains('active');
            const interrupt = document.getElementById('offline-interrupt-yes').classList.contains('active');
            const perspective = document.getElementById('offline-perspective').value;
            
            const processSave = (bgVal) => { 
                let contacts = DB.getContacts(); 
                const i = contacts.findIndex(c => c.id === currentChatContact.id); 
                if (i !== -1) { 
                    const oldBg = contacts[i].offlineSettings?.bg || ''; 
                    const finalBg = bgVal || oldBg; 
                    contacts[i].offlineSettings = { min, max, style, bg: finalBg, retell, interrupt, perspective }; 
                    DB.saveContacts(contacts); 
                    currentChatContact = contacts[i]; 
                    if (finalBg) { 
                        document.getElementById('offline-mode').style.backgroundImage = `url(${finalBg})`; 
                    } 
                } 
                closeOfflineSettings(); 
            }; 
            if (bgUrl) { 
                processSave(bgUrl); 
            } else if (bgFile.files && bgFile.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => processSave(e.target.result); 
                reader.readAsDataURL(bgFile.files[0]); 
            } else { 
                processSave(null); 
            } 
        }
        function toggleThoughts() { const modal = document.getElementById('thoughts-modal'); if (modal.classList.contains('active')) { modal.classList.remove('active'); } else { const chat = DB.getChats()[currentChatContact.id] || []; let lastThought = "ÊöÇÊó†ÂøÉÂ£∞..."; for (let i = chat.length - 1; i >= 0; i--) { if (chat[i].role === 'assistant' && chat[i].thought) { lastThought = chat[i].thought; break; } } document.getElementById('thoughts-text').innerText = lastThought; modal.classList.add('active'); } }
        function calculateChatRounds(history) { let rounds = 0; let hasUser = false; for (const msg of history) { if (msg.role === 'user') { hasUser = true; } else if (msg.role === 'assistant' && hasUser) { rounds++; hasUser = false; } } return rounds; }

        function getCalendarContextPrompt() {
            const events = DB.getCalendarEvents();
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            let context = "";
            if (events[todayStr]) {
                events[todayStr].forEach(ev => {
                    if (ev.type === 'anniversary') context += `\n- ‰ªäÂ§©ÊòØÁ∫™ÂøµÊó•Ôºö${ev.title}ÔºÅËØ∑Ê†πÊçÆ‰∫∫ËÆæ‰∏ªÂä®ÊèêËµ∑Âπ∂Â∫ÜÁ•ù„ÄÇ`;
                    if (ev.type === 'birthday_char') {
                        if (currentChatContact && ev.title === currentChatContact.name) {
                            context += `\n- ‰ªäÂ§©ÊòØ‰Ω†ÁöÑÁîüÊó•ÔºÅËØ∑Á≠âÂæÖÁî®Êà∑Á•ùÁ¶èÊàñ‰∏ªÂä®ÊöóÁ§∫„ÄÇ`;
                        }
                    }
                    if (ev.type === 'birthday_user') context += `\n- ‰ªäÂ§©ÊòØÁî®Êà∑ÁöÑÁîüÊó•ÔºÅËØ∑‰∏ªÂä®ÈÄÅ‰∏äÁ•ùÁ¶è„ÄÇ`;
                    if (ev.type === 'custom') context += `\n- ‰ªäÂ§©ÊòØËá™ÂÆö‰πâË°åÁ®ãÊó•Ôºö${ev.title}„ÄÇËØ∑Ê†πÊçÆÊÉÖÂÜµÊèêËµ∑„ÄÇ`;
                });
            }
            const { periodMap } = calculatePeriodDays(today.getFullYear(), today.getMonth());
            if (periodMap[todayStr] === 'active') {
                context += `\n- [ÁîüÁêÜÊúüÊèêÁ§∫] Áî®Êà∑ÁõÆÂâçÊ≠£Â§Ñ‰∫éÁîüÁêÜÊúü‰∏≠„ÄÇËØ∑Ë°®Áé∞Âá∫ÂÖ≥ÂøÉ„ÄÅ‰ΩìË¥¥ÔºåÊ≥®ÊÑèÂ•πÁöÑË∫´‰ΩìÁä∂ÂÜµ„ÄÇ`;
            } else if (periodMap[todayStr] === 'predicted') {
                context += `\n- [ÁîüÁêÜÊúüÊèêÁ§∫] Ê†πÊçÆÊé®ÁÆóÔºåÁî®Êà∑‰ªäÂ§©ÂèØËÉΩÂ§Ñ‰∫éÁîüÁêÜÊúü„ÄÇËØ∑ÁïôÊÑèÂ•πÁöÑÁä∂ÊÄÅ„ÄÇ`;
            } else {
                let futureCheck = new Date(today);
                futureCheck.setDate(today.getDate() + 2);
                const fStr = `${futureCheck.getFullYear()}-${String(futureCheck.getMonth()+1).padStart(2,'0')}-${String(futureCheck.getDate()).padStart(2,'0')}`;
                if (periodMap[fStr] === 'predicted') {
                    context += `\n- [ÁîüÁêÜÊúüÊèêÁ§∫] Áî®Êà∑ÁöÑÁîüÁêÜÊúüÈ¢ÑËÆ°Â∞ÜÂú® 2 Â§©ÂêéÂà∞Êù•„ÄÇËØ∑ÈÄÇÂΩìÊèêÈÜíÂ•πÊ≥®ÊÑè‰ºëÊÅØÔºåÈÅøÂÖçÁîüÂÜ∑„ÄÇ`;
                }
            }
            if (context) {
                return `\n\n===== „ÄêÊó•ÂéÜ‰∫ã‰ª∂ÊèêÈÜí„Äë =====${context}\n===========================`;
            }
            return "";
        }

        async function triggerAIResponse() {
            if (!currentChatContact) return;
            const settings = DB.getSettings();
            if (!settings.key) return alert('ËØ∑ÈÖçÁΩÆ API Key');
            
            const isCallActive = document.getElementById('call-screen').classList.contains('active');
            const isOfflineActive = document.getElementById('offline-mode').classList.contains('active');
            
            if (isCallActive) {
                document.getElementById('call-status').innerText = "ÂØπÊñπÊ≠£Âú®ÊÄùËÄÉ‰∏≠...";
            } else if (!isOfflineActive) {
                document.getElementById('typing-indicator').style.display = 'block';
            }

            let allChats = DB.getChats();
            let history = allChats[currentChatContact.id] || [];
            const userSettings = currentChatContact.userSettings || {};
            const contextLimit = userSettings.contextLimit || 100;
            const autoSummaryEnabled = userSettings.autoSummaryEnabled !== false;
            const summaryInterval = userSettings.summaryInterval || 20;
            const limitedHistory = history.slice(-contextLimit);

            let pendingTransferIndex = -1, pendingTransferAmount = 0, pendingTransferNote = '';
            for (let i = limitedHistory.length - 1; i >= 0; i--) {
                if (limitedHistory[i].type === 'transfer' && limitedHistory[i].status === 'pending') {
                    pendingTransferIndex = i; pendingTransferAmount = limitedHistory[i].amount; pendingTransferNote = limitedHistory[i].note; break;
                }
            }
            const isTransferEvent = pendingTransferIndex !== -1;
            const isTimePerceptionEnabled = userSettings.enableTimePerception || false;

            const apiMessages = limitedHistory.map(msg => {
                let content = msg.content;
                if (msg.isRetracted) {
                    if (msg.role === 'user') {
                        return { role: 'system', content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ‰Ω†ËôΩÁÑ∂Áúã‰∏çÂà∞ÂÜÖÂÆπÔºå‰ΩÜÁü•ÈÅìÁî®Êà∑Êí§Âõû‰∫Ü„ÄÇËØ∑Ê†πÊçÆÊÉÖÂÜµÂÅöÂá∫ÂèçÂ∫îÔºåÊØîÂ¶ÇËØ¢ÈóÆ"‰Ω†Êí§Âõû‰∫Ü‰ªÄ‰πàÔºü"]` };
                    } else {
                        return { role: 'assistant', content: `[Â∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ]` };
                    }
                }

                if (isTimePerceptionEnabled && msg.timestamp) { const timeStr = new Date(msg.timestamp).toLocaleString('zh-CN', { hour12: false }); content = `[ÂèëÈÄÅ‰∫é: ${timeStr}] ${content}`; }
                if (msg.type === 'transfer') return { role: 'user', content: `[Áî®Êà∑Âêë‰Ω†ËΩ¨Ë¥¶ ¬•${msg.amount}ÔºåÂ§áÊ≥®Ôºö${msg.note || 'Êó†'}]` };
                if (msg.type === 'transfer_receipt') return { role: 'assistant', content: msg.status === 'accepted' ? `[ÊàëÂ∑≤Êî∂Ê¨æ ¬•${msg.amount}]` : `[ÊàëÂ∑≤ÊãíÊî∂Âπ∂ÈÄÄËøò ¬•${msg.amount}]` };
                if (msg.type === 'call_end') return { role: 'system', content: msg.content }; 
                if (msg.type === 'sticker') {
                    // Ë°®ÊÉÖÂåÖÊ∂àÊÅØÔºöAIËØªÂèñÁöÑÊòØÁ∫ØÊèèËø∞ÊñáÂ≠óÔºå‰∏çÂ∏¶‰ªª‰ΩïÊ†áËÆ∞
                    const stickerDesc = msg.stickerDesc || 'Ë°®ÊÉÖ';
                    return { role: msg.role, content: `[ÂõæÁâáË°®ÊÉÖÔºö${stickerDesc}]` };
                }
                return { role: msg.role, content: content };
            });

            let systemContent = `${settings.prompt}\n\n[ËßíËâ≤‰ø°ÊÅØ]\nÂêçÂ≠óÔºö${currentChatContact.name}\n‰∫∫ËÆæÔºö${currentChatContact.persona}`;
            if (userSettings.userName || userSettings.userPersona) systemContent += `\n\n[Áî®Êà∑‰ø°ÊÅØ]\nÂêçÂ≠óÔºö${userSettings.userName || 'User'}\n‰∫∫ËÆæÔºö${userSettings.userPersona || ''}`;

            const mems = DB.getMemories()[currentChatContact.id] || { important: [], normal: [] };
            if (mems.important.length > 0) { systemContent += `\n\n[‚≠ê ÈáçË¶ÅÂõûÂøÜ - ÁªùÂØπ‰∏çËÉΩÈÅóÂøò]\n`; mems.important.forEach((m, i) => { systemContent += `${i+1}. ${m.content}\n`; }); }
            const lastUserMsg = limitedHistory.filter(m => m.role === 'user').pop()?.content || "";
            const triggeredMemories = mems.normal.filter(m => m.keywords?.length > 0 && m.keywords.some(kw => lastUserMsg.includes(kw)));
            if (triggeredMemories.length > 0) { systemContent += `\n\n[üìù Áõ∏ÂÖ≥ÂõûÂøÜ - ËÅîÊÉ≥Ëß¶Âèë]\n`; triggeredMemories.forEach((m, i) => { systemContent += `${i+1}. ${m.content}\n`; }); }

            if (isTimePerceptionEnabled) { const nowStr = new Date().toLocaleString('zh-CN', { hour12: false }); systemContent += `\n\n[Êó∂Èó¥ÊÑüÁü•Ê®°ÂºèÂ∑≤ÂºÄÂêØ]\nÂΩìÂâçÁé∞ÂÆûÊó∂Èó¥Ôºö${nowStr}\nËØ∑Ê≥®ÊÑèÔºö\n1. ÊØè‰∏ÄÊù°Ê∂àÊÅØÂâçÈÉΩÊ†áËÆ∞‰∫ÜÂèëÈÄÅÊó∂Èó¥ÔºåËøô‰ªÖ‰æõ‰Ω†Âà§Êñ≠Êó∂Èó¥ÊµÅÈÄù„ÄÇ\n2. **ÁªùÂØπ‰∏çË¶Å**Âú®ÂõûÂ§çÂºÄÂ§¥ÊòæÁ§∫Êó∂Èó¥Êà≥ÔºàÂ¶Ç [12:00:00]ÔºâÔºåÁõ¥Êé•ÂõûÂ§çÂÜÖÂÆπÂç≥ÂèØ„ÄÇ\n3. ËØ∑Ê†πÊçÆÂΩìÂâçÊó∂Èó¥Âà§Êñ≠‰Ω†ÁöÑ‰ΩúÊÅØÔºàÂ¶ÇÊ∑±Â§úÂú®Áù°ËßâÊàñÁÜ¨Â§úÔºåÊó©Êô®Âú®ÈÄöÂã§Ôºâ„ÄÇ\n4. ËßÇÂØüÁî®Êà∑ÂõûÂ§çÁöÑÊó∂Èó¥Èó¥Èöî„ÄÇÂ¶ÇÊûúÁî®Êà∑Èöî‰∫ÜÂæà‰πÖÊâçÂõûÔºåËØ∑Ê†πÊçÆ‰∫∫ËÆæÂÅöÂá∫ÂèçÂ∫îÔºàÂ¶ÇÂêêÊßΩ„ÄÅÊãÖÂøÉÁ≠âÔºâ„ÄÇ`; }
            if (isTransferEvent) systemContent += `\n\n===== „ÄêËΩ¨Ë¥¶Â§ÑÁêÜ - Âº∫Âà∂Ê†ºÂºè„Äë =====\nÁî®Êà∑ÂàöÂàöÂêë‰Ω†ËΩ¨Ë¥¶ ¬•${pendingTransferAmount}ÔºåÂ§áÊ≥®Ôºö${pendingTransferNote || 'Êó†'}„ÄÇ\n‰Ω†ÂøÖÈ°ªÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÂõûÂ§çÔºö\n- Â¶ÇÊûú‰Ω†ÂÜ≥ÂÆö„ÄêÊî∂‰∏ã„ÄëËΩ¨Ë¥¶ÔºåÂõûÂ§çÂøÖÈ°ª‰ª• [ACCEPT] ÂºÄÂ§¥\n- Â¶ÇÊûú‰Ω†ÂÜ≥ÂÆö„ÄêÊãíÊî∂„ÄëËΩ¨Ë¥¶ÔºåÂõûÂ§çÂøÖÈ°ª‰ª• [REJECT] ÂºÄÂ§¥\n===================================`;

            systemContent += getCalendarContextPrompt();

            const wb = DB.getWorldBook();
            const globalEntries = wb.entries.filter(e => e.type === 'global');
            if (globalEntries.length > 0) { systemContent += `\n\n[‰∏ñÁïåËßÇËÆæÂÆö]\n`; globalEntries.forEach(e => { systemContent += `„Äê${e.title}„ÄëÔºö${e.content}\n`; }); }
            const boundIds = currentChatContact.boundWorldBooks || [];
            if (boundIds.length > 0) { systemContent += `\n\n[ËßíËâ≤‰∏ìÂ±ûËÆæÂÆö]\n`; boundIds.forEach(bid => { const entry = wb.entries.find(e => e.id == bid); if (entry) systemContent += `„Äê${entry.title}„ÄëÔºö${entry.content}\n`; }); }

            systemContent += `\n\n[ÁâπÊÆäÂäüËÉΩ] Â¶ÇÊûú‰Ω†ÊÉ≥Êí§Âõû‰Ω†ÂèëÁöÑ‰∏ä‰∏ÄÊù°Ê∂àÊÅØÔºà‰æãÂ¶ÇË°®Áé∞ÂÇ≤Â®áÂêéÁöÑÂêéÊÇîÔºåÊàñËÄÖËØ¥ÈîôËØù‰∫ÜÔºâÔºåËØ∑Âú®ÂõûÂ§çÁöÑÊúÄÂºÄÂ§¥Âä†‰∏ä [CMD:RETRACT_LAST]„ÄÇÁ≥ªÁªü‰ºöËá™Âä®Â∞Ü‰Ω†‰∏ä‰∏ÄÊù°Ê∂àÊÅØÊ†áËÆ∞‰∏∫Êí§Âõû„ÄÇ`;

            if (isCallActive) {
                systemContent += `\n\n===== „ÄêËØ≠Èü≥ÈÄöËØùÊ®°Âºè„Äë =====\nÁé∞Âú®‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑ËøõË°åËØ≠Èü≥ÈÄöËØù„ÄÇ\n**ÈáçË¶ÅËßÑÂàô**Ôºö\n1. ËØ∑ÂÉèÊâìÁîµËØù‰∏ÄÊ†∑ÂõûÂ§çÔºå‰øùÊåÅÂè£ËØ≠Âåñ„ÄÇ\n2. **‰∏•Á¶Å**‰ΩøÁî® '|||' ÂàÜÈöîÊ∂àÊÅØ„ÄÇ\n3. ‰∏ÄÊ¨°Âè™ÂõûÂ§ç‰∏ÄÊÆµËØùÔºåÂ≠óÊï∞ÈôêÂà∂Âú®150Â≠ó‰ª•ÂÜÖ„ÄÇ\n4. ÂøÖÈ°ªÂú®ÂõûÂ§çÂâçÁîüÊàêÂøÉÂ£∞„ÄÇ\nÊ†ºÂºèÔºö[THOUGHTS: ÂøÉÂ£∞] ||| ÂõûÂ§çÂÜÖÂÆπ`;
            } else if (isOfflineActive) {
                const offSet = currentChatContact.offlineSettings || { min: 500, max: 700, style: '' };
                systemContent += `\n\n===== „ÄêÁ∫ø‰∏ãËßÅÈù¢Ê®°Âºè„Äë =====\nÁé∞Âú®‰Ω†ÂíåÁî®Êà∑Ê≠£Âú®Á∫ø‰∏ãËßÅÈù¢ÔºåÈù¢ÂØπÈù¢‰∫§ÊµÅ„ÄÇ\n**ÈáçË¶ÅËßÑÂàô**Ôºö\n1. **‰∏•Á¶Å**‰ΩøÁî® '|||' ÂàÜÈöîÊ∂àÊÅØ„ÄÇ\n2. ËØ∑‰ΩøÁî®Â∞èËØ¥Ëà¨ÁöÑÊèèÂÜôÊâãÊ≥ïÔºåÂåÖÂê´ËØ¶ÁªÜÁöÑÂä®‰ΩúÊèèÂÜô„ÄÅÁ•ûÊÄÅÊèèÂÜô„ÄÅÁéØÂ¢ÉÊèèÂÜôÂíåÂøÉÁêÜÊèèÂÜô„ÄÇ\n3. Â≠óÊï∞Ë¶ÅÊ±ÇÔºö${offSet.min} - ${offSet.max} Â≠ó„ÄÇ\n4. ÊñáÈ£éË¶ÅÊ±ÇÔºö${offSet.style || 'ÁªÜËÖª„ÄÅÊ≤âÊµ∏ÊÑüÂº∫'}\n5. ÂøÖÈ°ªÂú®ÂõûÂ§çÂâçÁîüÊàêÂøÉÂ£∞„ÄÇ\nÊ†ºÂºèÔºö[THOUGHTS: ÂøÉÂ£∞] ||| ÈïøÁØáÊèèÂÜôÂõûÂ§çÂÜÖÂÆπ`;
            } else {
                systemContent += `\n\n===== „ÄêÂº∫Âà∂ÂõûÂ§çÊ†ºÂºè„Äë =====\n‰Ω†ÂøÖÈ°ªÂú®ÊØèÊ¨°ÂõûÂ§çÁöÑ**ÊúÄÂºÄÂßã**ÁîüÊàê‰∏ÄÊÆµÂÜÖÂøÉÁã¨ÁôΩÔºàÂøÉÂ£∞ÔºâÔºåÂ±ïÁ§∫‰Ω†Ê≠§ÂàªÁúüÂÆûÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÅÊÉÖÁª™ÊàñÂØπÁî®Êà∑ÁöÑÁúãÊ≥ï„ÄÇÂøÉÂ£∞ÂøÖÈ°ªÂåÖË£πÂú® [THOUGHTS: ...] ‰∏≠Ôºå‰∏î‰∏çË∂ÖËøá100Â≠ó„ÄÇÂøÉÂ£∞‰πãÂêéÔºå‰ΩøÁî® ||| ÂàÜÈöîÔºåÁÑ∂ÂêéÊâçÊòØ‰Ω†ÂØπÁî®Êà∑ÁöÑÂÆûÈôÖÂõûÂ§ç„ÄÇ\nÊ†ºÂºèÁ§∫‰æãÔºö\n[THOUGHTS: ‰ªñÊÄé‰πàÁ™ÅÁÑ∂ÈóÆËøô‰∏™ÔºüÊúâÁÇπÂÆ≥Áæû...] ||| ÂëÉÔºåËøô‰∏™Âòõ... ||| ÂÖ∂ÂÆûÊàë‰πü‰∏çÂ§™Ê∏ÖÊ•ö„ÄÇ`;
            }

            const messages = [{ role: "system", content: systemContent }, ...apiMessages];

            try {
                const response = await fetch(`${settings.url}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.key}` }, body: JSON.stringify({ model: settings.model, messages: messages, temperature: 0.7 }) });
                const data = await response.json();
                
                if (isCallActive) {
                    document.getElementById('call-status').innerText = "ÈÄöËØù‰∏≠";
                } else if (isOfflineActive) {
                    document.getElementById('offline-typing-indicator').style.display = 'none'; 
                } else {
                    document.getElementById('typing-indicator').style.display = 'none';
                }
                
                if (data.choices && data.choices.length > 0) {
                    let content = data.choices[0].message.content;
                    
                    if (content.includes('[CMD:RETRACT_LAST]')) {
                        content = content.replace('[CMD:RETRACT_LAST]', '').trim();
                        allChats = DB.getChats();
                        const currentChat = allChats[currentChatContact.id];
                        for (let i = currentChat.length - 1; i >= 0; i--) {
                            if (currentChat[i].role === 'assistant' && !currentChat[i].isRetracted) {
                                currentChat[i].isRetracted = true;
                                break;
                            }
                        }
                        DB.saveChats(allChats);
                        renderChatHistory(); 
                    }

                    let extractedThought = null;
                    const thoughtMatch = content.match(/^\[THOUGHTS:(.*?)\]/s);
                    if (thoughtMatch) {
                        extractedThought = thoughtMatch[1].trim();
                        content = content.replace(thoughtMatch[0], '').trim();
                        content = content.replace(/^\|\|\|\s*/, '').trim();
                    }

                    if (isTransferEvent) {
                        allChats = DB.getChats();
                        let receiptStatus = content.match(/^\s*\[ACCEPT\]/i) ? 'accepted' : (content.match(/^\s*\[REJECT\]/i) ? 'rejected' : 'accepted');
                        content = content.replace(/^\s*\[(ACCEPT|REJECT)\]\s*/i, '').trim();
                        if (allChats[currentChatContact.id]?.[pendingTransferIndex]) allChats[currentChatContact.id][pendingTransferIndex].status = receiptStatus;
                        allChats[currentChatContact.id].push({ role: 'assistant', type: 'transfer_receipt', status: receiptStatus, amount: pendingTransferAmount, timestamp: Date.now() });
                        DB.saveChats(allChats); renderChatHistory();
                    }
                    if (content && content.trim()) {
                        content = content.replace(/^\[\d{2}:\d{2}:\d{2}\]\s*/, '');
                        
                        if (isCallActive || isOfflineActive) {
                            saveMessage('assistant', content, null, extractedThought);
                        } else {
                            const parts = content.split('|||');
                            let delay = isTransferEvent ? 500 : 0;
                            parts.forEach((part, index) => { 
                                const clean = part.trim(); 
                                if (clean) { 
                                    setTimeout(() => {
                                        const isLastPart = index === parts.length - 1;
                                        saveMessage('assistant', clean, null, isLastPart ? extractedThought : null);
                                    }, delay); 
                                    delay += 800; 
                                } 
                            });
                        }
                        
                        if (autoSummaryEnabled) {
                            const updatedHistory = DB.getChats()[currentChatContact.id] || [];
                            const currentRounds = calculateChatRounds(updatedHistory);
                            if (currentRounds > 0 && currentRounds % summaryInterval === 0) {
                                generateSummary(currentChatContact, updatedHistory.slice(-summaryInterval * 4));
                            }
                        }
                    }
                }
            } catch (error) { 
                if (isCallActive) document.getElementById('call-status').innerText = "ËøûÊé•ÈîôËØØ";
                else if (isOfflineActive) document.getElementById('offline-typing-indicator').style.display = 'none';
                else document.getElementById('typing-indicator').style.display = 'none'; 
                alert('Error: ' + error.message); 
            }
        }

        async function generateSummary(contact, recentMessages) {
            const settings = DB.getSettings(); if (!settings.key) return;
            const msgsText = recentMessages.map(m => { const time = m.timestamp ? new Date(m.timestamp).toLocaleString('zh-CN', {hour12:false}) : "Êú™Áü•Êó∂Èó¥"; return `[${time}] ${m.role === 'user' ? 'User' : 'Me'}: ${m.content}`; }).join('\n');
            const nowStr = new Date().toLocaleString('zh-CN', { hour12: false });
            const prompt = `‰Ω†Áé∞Âú®ÊòØ ${contact.name}„ÄÇËØ∑ÈòÖËØª‰ª•‰∏ã‰Ω†‰∏éÁî®Êà∑ÁöÑËøëÊúüÂØπËØùËÆ∞ÂΩïÔºåÂπ∂‰ª•„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞„ÄëÔºàÊàë...ÔºâÊÄªÁªìËøôÊÆµÂØπËØù‰∏≠ÂèëÁîüÁöÑÂÖ≥ÈîÆ‰∫ã‰ª∂„ÄÇË¶ÅÊ±ÇÔºö1.ÂåÖÂê´ÂÖ∑‰ΩìÊó∂Èó¥ÁÇπ„ÄÇ2.ÊèêÂèñ3-5‰∏™ÂÖ≥ÈîÆËØç„ÄÇ3.Â¶ÇÊûúÊó†ÈáçË¶Å‰ø°ÊÅØÔºåcontentËøîÂõû"Êó†"„ÄÇ4.‰∏•Ê†ºËøîÂõûJSONÊ†ºÂºèÔºö{"content":"...","keywords":["..."]}„ÄÇÂØπËØùËÆ∞ÂΩïÔºö\n${msgsText}\nÂΩìÂâçÊó∂Èó¥Ôºö${nowStr}`;
            try {
                const res = await fetch(`${settings.url}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.key}` }, body: JSON.stringify({ model: settings.model, messages: [{ role: "user", content: prompt }], temperature: 0.5 }) });
                const data = await res.json();
                if (data.choices?.length > 0) {
                    let raw = data.choices[0].message.content.trim().replace(/```json/g, '').replace(/```/g, '').trim();
                    try { const result = JSON.parse(raw); if (result.content && result.content !== "Êó†") { const mems = DB.getMemories(); if (!mems[contact.id]) mems[contact.id] = { important: [], normal: [] }; mems[contact.id].normal.push({ content: result.content, keywords: result.keywords || [] }); DB.saveMemories(mems); console.log("Auto summary generated:", result); } } catch (e) { console.error("JSON parse failed:", e); }
                }
            } catch (e) { console.error("Summary generation failed:", e); }
        }

        if ('serviceWorker' in navigator) { window.addEventListener('load', function() { navigator.serviceWorker.register('./sw.js').then(r => console.log('SW registered:', r.scope)).catch(e => console.log('SW failed:', e)); }); }
    </script>
</body>
</html>
